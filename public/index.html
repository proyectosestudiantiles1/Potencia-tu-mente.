<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ================================================================= -->
    <!--                       METADATOS Y CONFIGURACIÓN                     -->
    <!-- ================================================================= -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Una plataforma de aprendizaje interactiva sobre conceptos clave, con un enfoque en la sostenibilidad y el cuidado del medio ambiente.">
    <meta name="keywords" content="aprendizaje, educación, medio ambiente, ecología, reciclaje, sostenibilidad, ciencia">
    <meta name="author" content="EcoMentes Team">
    <title data-key="title">EcoMentes - Plataforma de Aprendizaje Verde</title>
    
    <!-- Librería de íconos Font Awesome para una UI más rica -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- ================================================================= -->
    <!--                     ESTILOS CSS INTEGRADOs (CSS-in-HTML)            -->
    <!-- ================================================================= -->
    <style>
        /* ----------------------------------------------------------------- */
        /*                          1. VARIABLES Y RESET                     */
        /* ----------------------------------------------------------------- */
        
        /* 
         * Sistema de Diseño: Variables CSS para un control centralizado
         * sobre la apariencia. Esto permite cambios globales (como el tema oscuro)
         * de manera eficiente y mantenible.
         */
        :root {
            /* Paleta de Colores Principal (Tema Claro) */
            --color-primary-dark: #2d6a4f;
            --color-primary-main: #40916c;
            --color-primary-light: #52b788;
            --color-accent: #ff9f1c;
            --color-success: #00b458;
            --color-danger: #d00000;
            --color-bg: #f8f9fa;
            --color-surface: #ffffff;
            --color-text-primary: #212529;
            --color-text-secondary: #6c757d;
            --color-border: #dee2e6;
            --color-white: #ffffff;

            /* Tipografía */
            --font-family-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
            --font-size-base: 16px;
            --font-size-h1: 3.5rem;
            --font-size-h2: 2.5rem;
            --font-size-h3: 1.75rem;

            /* Espaciado */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 2rem;
            --spacing-xl: 4rem;

            /* Otros */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.07);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        /*
         * Tema Oscuro: Sobrescribimos las variables cuando el atributo
         * data-theme="dark" está presente en el <html> tag.
         */
        html[data-theme='dark'] {
            --color-primary-dark: #52b788;
            --color-primary-main: #40916c;
            --color-primary-light: #2d6a4f;
            --color-accent: #ffaf4c;
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text-primary: #e0e0e0;
            --color-text-secondary: #a0a0a0;
            --color-border: #333333;
        }
        
        /* Reset básico y configuración global */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            font-size: var(--font-size-base);
        }

        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            line-height: 1.7;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        /* ----------------------------------------------------------------- */
        /*                     2. ESTILOS DE ACCESIBILIDAD                   */
        /* ----------------------------------------------------------------- */

        /* Indicadores de foco claros y consistentes para navegación por teclado */
        :focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 3px;
        }

        /* Reducir movimiento para usuarios que lo prefieran */
        @media (prefers-reduced-motion: reduce) {
          *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
          }
        }
        
        /* ----------------------------------------------------------------- */
        /*                       3. DISEÑO DE COMPONENTES                    */
        /* ----------------------------------------------------------------- */

        /* ----- Cabecera y Navegación ----- */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 5%;
            background-color: var(--color-primary-dark);
            color: var(--color-white);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .logo h1 { font-size: 1.5rem; }
        .logo i { color: var(--color-primary-light); }

        .main-nav ul { list-style: none; display: flex; gap: 1.5rem; }
        .main-nav a { text-decoration: none; color: var(--color-white); font-weight: 600; position: relative; padding: 0.5rem 0; }
        .main-nav a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px; background-color: var(--color-accent); transition: width var(--transition-speed) ease; }
        .main-nav a:hover::after, .main-nav a:focus-visible::after { width: 100%; }
        .mobile-menu-button { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        /* ----- Sección Héroe ----- */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-intro {
            height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--color-white);
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1444927714506-8492d91b4b60?q=80&w=2070') no-repeat center center/cover;
            padding: 0 var(--spacing-lg);
        }
        
        .hero-content h2 { font-size: var(--font-size-h1); margin-bottom: var(--spacing-md); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); animation: fadeInDown 1s ease-out; }
        .hero-content p { font-size: 1.5rem; margin-bottom: var(--spacing-lg); animation: fadeInDown 1.2s ease-out; }

        .cta-button {
            text-decoration: none;
            background-color: var(--color-primary-main);
            color: var(--color-white);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
            box-shadow: var(--shadow-md);
            animation: fadeInDown 1.4s ease-out;
        }
        .cta-button:hover, .cta-button:focus-visible { background-color: var(--color-primary-light); transform: translateY(-3px) scale(1.05); }

        /* ----- Diseño de Secciones ----- */
        .content-section { padding: var(--spacing-xl) 5%; max-width: 1200px; margin: 0 auto; }
        .content-section h2 { font-size: var(--font-size-h2); color: var(--color-primary-dark); margin-bottom: var(--spacing-lg); text-align: center; }

        /* ----- Sección de Conceptos y Búsqueda ----- */
        .search-container { position: relative; max-width: 600px; margin: 0 auto 3rem; }
        #buscadorConceptos {
            width: 100%;
            padding: var(--spacing-md) 3rem var(--spacing-md) var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: var(--color-surface);
            color: var(--color-text-primary);
        }
        #buscadorConceptos:focus { border-color: var(--color-primary-main); box-shadow: 0 0 0 4px rgba(64, 145, 108, 0.2); }
        .search-icon { position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); color: var(--color-text-secondary); }
        
        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }
        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .concept-card {
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            border: 1px solid var(--color-border);
            animation: popIn 0.5s ease-out forwards;
        }
        .concept-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-md); }
        .concept-card h3 { color: var(--color-primary-dark); margin-bottom: var(--spacing-md); }
        .concept-card strong { color: var(--color-primary-main); }
        .concept-details p { margin-bottom: var(--spacing-md); font-size: 0.95rem; }
        
        .practice-button {
            margin-top: auto;
            display: block;
            text-align: center;
            text-decoration: none;
            width: 100%;
            background-color: var(--color-primary-dark);
            color: var(--color-white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: background-color var(--transition-speed) ease;
        }
        .practice-button:hover, .practice-button:focus-visible { background-color: var(--color-primary-main); }

        /* ----- Sección Práctica ----- */
        #practice-area {
            background-color: var(--color-surface);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            max-width: 800px;
            margin: 2rem auto 0;
        }
        .practice-block h3 { font-size: var(--font-size-h3); color: var(--color-primary-dark); margin-bottom: var(--spacing-md); }
        .difficulty-selector { display: flex; gap: var(--spacing-md); margin-bottom: 1.5rem; }
        .difficulty-btn {
            border: 1px solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            background-color: transparent;
            color: var(--color-text-primary);
            transition: all var(--transition-speed) ease;
        }
        .difficulty-btn.active, .difficulty-btn:hover { background-color: var(--color-primary-main); color: var(--color-white); border-color: var(--color-primary-main); }
        
        .problem-statement { font-size: 1.2rem; margin-bottom: 1.5rem; background-color: var(--color-bg); padding: var(--spacing-md); border-radius: var(--border-radius); }
        .answer-section { display: flex; gap: var(--spacing-md); }
        .answer-section input {
            flex-grow: 1;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            border: 2px solid var(--color-border);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
        }
        .submit-answer {
            background-color: var(--color-primary-dark);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
        .feedback { margin-top: var(--spacing-md); font-weight: 700; font-size: 1.1rem; height: 25px; transition: color var(--transition-speed) ease; }
        .feedback.correct { color: var(--color-success); }
        .feedback.incorrect { color: var(--color-danger); }
        
        .collaborate-button {
            margin-top: 1.5rem;
            width: 100%;
            background-color: var(--color-accent);
            border: none;
            color: white;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            font-weight: 700;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease;
        }
        .collaborate-button:hover { background-color: #ffb75e; }

        /* ----- Secciones con Formularios (Juntos, Ajustes) ----- */
        .form-section-card {
            background-color: var(--color-surface);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
            max-width: 600px;
            margin: 0 auto;
        }
        .form-section-card input[type="text"], 
        .form-section-card input[type="url"],
        .form-section-card select {
            width: 100%;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            margin-top: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            background-color: var(--color-bg);
            color: var(--color-text-primary);
        }
        .form-section-card button, .apply-settings {
            width: 100%;
            padding: var(--spacing-sm);
            border: none;
            background-color: var(--color-primary-dark);
            color: var(--color-white);
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: var(--spacing-md);
            font-weight: 600;
        }
        #deleteUserBtn { background-color: var(--color-danger); }
        #copy-code-btn { background: none; border: none; color: var(--color-primary-main); cursor: pointer; font-size: 1.1rem; padding: 0 var(--spacing-sm); }
        .status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        .status.online { background-color: var(--color-success); }
        .status.offline { background-color: var(--color-text-secondary); animation: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 180, 88, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 180, 88, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 180, 88, 0); } }

        /* ----- Sección Consejos ----- */
        .tips-list { list-style: none; max-width: 800px; margin: 0 auto; }
        .tips-list li {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            background-color: var(--color-surface);
            padding: var(--spacing-md);
            border-left: 5px solid var(--color-primary-main);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            box-shadow: var(--shadow-sm);
        }

        /* ----- Sección Ajustes Específicos ----- */
        .theme-switch-wrapper { display: flex; align-items: center; gap: var(--spacing-md); }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; }
        input:checked + .slider { background-color: var(--color-primary-main); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* ----- Pie de Página ----- */
        .main-footer { text-align: center; padding: var(--spacing-lg) 5%; background-color: #212529; color: var(--color-white); }
        html[data-theme='dark'] .main-footer { background-color: #000; }
        
        .hidden { display: none !important; }
        
        /* ----------------------------------------------------------------- */
        /*                          4. RESPONSIVIDAD                         */
        /* ----------------------------------------------------------------- */
        
        @media (max-width: 768px) {
            :root {
                --font-size-h1: 2.5rem;
                --font-size-h2: 2rem;
            }
            
            .main-nav ul {
                display: none;
                flex-direction: column;
                width: 100%;
                background-color: var(--color-primary-dark);
                position: absolute;
                top: 72px; /* Altura del header */
                left: 0;
                padding: var(--spacing-md) 0;
            }

            .main-nav.active ul { display: flex; }
            .main-nav li { width: 100%; text-align: center; }
            .main-nav a { padding: var(--spacing-md) 0; }
            
            .mobile-menu-button { display: block; }
            
            .hero-content p { font-size: 1.2rem; }
            
            .content-section { padding: 3rem 5%; }
            .answer-section { flex-direction: column; }
        }
    </style>
</head>
<body role="document">

    <!-- ================================================================= -->
    <!--                       CONTENIDO HTML (El Esqueleto)                  -->
    <!-- ================================================================= -->

    <!-- ==== Cabecera y Navegación Principal ==== -->
    <header class="main-header" role="banner">
        <div class="logo">
            <h1><i class="fa-solid fa-seedling" aria-hidden="true"></i> <span data-key="main_title">EcoMentes</span></h1>
        </div>
        <nav class="main-nav" aria-label="Navegación principal">
            <button class="mobile-menu-button" aria-label="Abrir menú" aria-expanded="false" aria-controls="main-nav-list">
                <i class="fa-solid fa-bars"></i>
            </button>
            <ul id="main-nav-list" role="menubar">
                <li role="none"><a href="#intro" data-key="nav_home" role="menuitem">Inicio</a></li>
                <li role="none"><a href="#conceptos" data-key="nav_concepts" role="menuitem">Conceptos</a></li>
                <li role="none"><a href="#practica" data-key="nav_practice" role="menuitem">Práctica</a></li>
                <li role="none"><a href="#aprendamos-juntos" data-key="nav_together" role="menuitem">Aprendamos Juntos</a></li>
                <li role="none"><a href="#consejos" data-key="nav_tips" role="menuitem">Consejos</a></li>
                <li role="none"><a href="#quienes-somos" data-key="nav_about" role="menuitem">Quiénes Somos</a></li>
                <li role="none"><a href="#ajustes" data-key="nav_settings" role="menuitem">Ajustes</a></li>
            </ul>
        </nav>
    </header>

    <main role="main">

        <!-- ==== Sección de Introducción Espectacular ==== -->
        <section id="intro" class="hero-intro" role="region" aria-labelledby="hero-title">
            <div class="hero-content">
                <h2 id="hero-title" data-key="hero_title">Bienvenido a tu Aventura del Conocimiento</h2>
                <p data-key="hero_subtitle">Un espacio donde aprender es un acto natural. Sumérgete en conceptos, practica con desafíos y colabora para crecer.</p>
                <a href="#conceptos" class="cta-button" data-key="hero_button">Empezar a Aprender</a>
            </div>
        </section>

        <!-- ==== Sección 1: Conceptos ==== -->
        <section id="conceptos" class="content-section" role="region" aria-labelledby="conceptos-titulo">
            <h2 id="conceptos-titulo" data-key="concepts_title">Conceptos Fundamentales</h2>
            <div class="search-container" role="search">
                <input type="search" id="buscadorConceptos" data-key-placeholder="search_placeholder" placeholder="Busca un concepto..." aria-label="Buscador de conceptos">
                <i class="fa fa-search search-icon" aria-hidden="true"></i>
            </div>
            <div id="concept-grid" class="concept-grid" aria-live="polite">
                <!-- Los conceptos se cargarán aquí dinámicamente con JavaScript -->
            </div>
        </section>

        <!-- ==== Sección 2: Práctica ==== -->
        <section id="practica" class="content-section" role="region" aria-labelledby="practica-titulo">
            <h2 id="practica-titulo" data-key="practice_title">Pon a Prueba tus Conocimientos</h2>
            <div id="practice-area" aria-live="polite">
                <p class="description" data-key="practice_subtitle">Aquí aparecerán los problemas cuando presiones "Practica" en un concepto.</p>
            </div>
        </section>

        <!-- ==== Sección 3: Aprendamos Juntos ==== -->
        <section id="aprendamos-juntos" class="content-section" role="region" aria-labelledby="aprendamos-titulo">
            <h2 id="aprendamos-titulo" data-key="together_title">Colabora y Crece</h2>
            <div class="form-section-card">
                <div id="user-login-area">
                    <p data-key="together_prompt">Crea un perfil para conectar con amigos.</p>
                    <label for="username-input" class="hidden" data-key="username_placeholder">Elige tu nombre de usuario</label>
                    <input type="text" id="username-input" data-key-placeholder="username_placeholder" placeholder="Elige tu nombre de usuario" aria-label="Nombre de usuario">
                    <button id="createUserBtn" data-key="create_user_btn">Crear Usuario</button>
                </div>
                <div id="user-info-area" class="hidden">
                    <p><span data-key="welcome_user">Bienvenido,</span> <strong id="username-display"></strong></p>
                    <p>
                        <span data-key="friend_code_label">Tu código de amigo:</span> 
                        <strong id="friend-code-display"></strong> 
                        <button id="copy-code-btn" aria-label="Copiar código de amigo"><i class="fa-solid fa-copy"></i></button>
                    </p>
                    <button id="deleteUserBtn" data-key="delete_user_btn">Eliminar Usuario</button>
                </div>
                <hr style="margin: 2rem 0; border: 1px solid var(--color-border);">
                <h4 data-key="friends_list_title">Lista de Amigos (Simulación)</h4>
                <div id="friend-list">
                    <!-- Amigos simulados que se actualizarán con JS -->
                </div>
            </div>
        </section>

        <!-- ==== Sección 4: Consejos de Estudio ==== -->
        <section id="consejos" class="content-section" role="region" aria-labelledby="consejos-titulo">
            <h2 id="consejos-titulo" data-key="tips_title">20 Consejos para Potenciar tu Estudio</h2>
            <ol class="tips-list">
                <li data-key="tip1"><strong>Técnica Pomodoro:</strong> Estudia en bloques de 25 minutos con descansos de 5 minutos. Aumenta la concentración y previene el agotamiento.</li>
                <li data-key="tip2"><strong>Aprendizaje Activo:</strong> En lugar de solo leer, hazte preguntas, crea mapas mentales, o intenta explicar el concepto con tus propias palabras.</li>
                <li data-key="tip3"><strong>Enseña lo que Aprendes:</strong> Explicarle un tema a otra persona es la prueba de fuego. Si puedes enseñarlo, lo has entendido de verdad.</li>
                <li data-key="tip4"><strong>Entorno Adecuado:</strong> Busca un lugar tranquilo, ordenado y libre de distracciones. Tu entorno físico afecta tu estado mental.</li>
                <li data-key="tip5"><strong>Repetición Espaciada:</strong> Repasa la información en intervalos crecientes (1 día, 3 días, 1 semana). Combate la "curva del olvido".</li>
                <li data-key="tip6"><strong>Intercala Materias:</strong> No dediques un día entero a un solo tema. Intercalar materias diferentes mantiene tu cerebro más ágil y mejora la retención.</li>
                <li data-key="tip7"><strong>Prioriza el Sueño:</strong> Dormir entre 7-9 horas es crucial. Durante el sueño, tu cerebro consolida los recuerdos y lo que has aprendido.</li>
                <li data-key="tip8"><strong>Conecta con Conocimientos Previos:</strong> Relaciona la nueva información con cosas que ya sabes. Crea "ganchos" mentales para recordar mejor.</li>
                <li data-key="tip9"><strong>Haz Ejercicio Físico:</strong> La actividad física regular mejora el flujo sanguíneo al cerebro, reduce el estrés y aumenta la capacidad de aprendizaje.</li>
                <li data-key="tip10"><strong>Alimentación Saludable:</strong> Evita el exceso de azúcar y carbohidratos simples. Alimentos como pescado, nueces y arándanos son buenos para el cerebro.</li>
                <li data-key="tip11"><strong>Hidrátate:</strong> La deshidratación, incluso leve, puede afectar negativamente la concentración y la memoria. Ten siempre agua a mano.</li>
                <li data-key="tip12"><strong>Establece Metas Claras y Pequeñas:</strong> En lugar de "estudiar biología", define "aprender las partes de la célula". Las metas pequeñas son menos abrumadoras.</li>
                <li data-key="tip13"><strong>Toma Apuntes a Mano:</strong> Escribir a mano activa más áreas del cerebro que teclear y te obliga a procesar y resumir la información.</li>
                <li data-key="tip14"><strong>Utiliza Mnemotecnias:</strong> Crea acrónimos, canciones o historias divertidas para recordar listas o procesos complejos.</li>
                <li data-key="tip15"><strong>Silencia las Notificaciones:</strong> Pon tu teléfono en modo avión o en otra habitación. Cada notificación rompe tu concentración.</li>
                <li data-key="tip16"><strong>Práctica de Autoevaluación:</strong> No esperes al examen. Ponte a prueba regularmente con preguntas que tú mismo prepares.</li>
                <li data-key="tip17"><strong>No Hagas Multitarea:</strong> Nuestro cerebro no está diseñado para hacer varias tareas complejas a la vez. Enfócate en una sola cosa.</li>
                <li data-key="tip18"><strong>Usa los Primeros Minutos Sabiamente:</strong> La atención es más alta al inicio de una sesión. Empieza con lo más difícil o importante.</li>
                <li data-key="tip19"><strong>Permítete Descansos Mentales:</strong> A veces, alejarse de un problema por un rato y volver más tarde te da una nueva perspectiva para resolverlo.</li>
                <li data-key="tip20"><strong>Sé Curioso:</strong> Aborda el estudio no como una obligación, sino como una oportunidad de descubrir algo nuevo. La curiosidad es el motor del aprendizaje.</li>
            </ol>
        </section>

        <!-- ==== Sección 5: Quiénes Somos ==== -->
        <section id="quienes-somos" class="content-section" role="region" aria-labelledby="somos-titulo">
            <h2 id="somos-titulo" data-key="about_title">Nuestro Equipo</h2>
            <p data-key="about_text" style="text-align: center; max-width: 800px; margin: 0 auto;">
                Somos un grupo de estudiantes apasionados por la tecnología y la educación ambiental. Nuestra misión con "EcoMentes" es crear una herramienta interactiva y accesible que no solo facilite el aprendizaje de conceptos complejos, sino que también fomente una conciencia sobre la importancia de cuidar nuestro planeta. Creemos que el conocimiento es la semilla del cambio, y a través de esta plataforma, esperamos inspirar a la próxima generación de pensadores y cuidadores del medio ambiente.
            </p>
        </section>

        <!-- ==== Sección 6: Ajustes Personalizados ==== -->
        <section id="ajustes" class="content-section" role="region" aria-labelledby="ajustes-titulo">
            <h2 id="ajustes-titulo" data-key="settings_title">Ajustes Personalizados</h2>
            <div class="form-section-card">
                <div class="setting-option">
                    <label for="language-select" data-key="language_label">Idioma:</label>
                    <select id="language-select" aria-label="Seleccionar idioma">
                        <option value="es" selected>Español</option>
                        <option value="en">English</option>
                        <option value="pt" data-key="lang_pt">Português</option>
                        <option value="de" data-key="lang_de">Deutsch</option>
                        <option value="fr" data-key="lang_fr">Français</option>
                    </select>
                </div>
                <div class="setting-option">
                     <label for="background-url" data-key="bg_url_label">Fondo desde URL:</label>
                     <input type="url" id="background-url" data-key-placeholder="url_placeholder" placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                <div class="setting-option">
                    <label for="background-upload" data-key="bg_upload_label">Fondo desde tu dispositivo:</label>
                    <input type="file" id="background-upload" accept="image/*" aria-label="Subir archivo de imagen para fondo">
                </div>
                 <div class="setting-option theme-switch-wrapper">
                    <label data-key="dark_mode_label">Modo Oscuro:</label>
                    <label class="theme-switch" for="theme-toggle">
                      <input type="checkbox" id="theme-toggle" />
                      <div class="slider round"></div>
                    </label>
                  </div>
            </div>
        </section>
    </main>

    <!-- ==== Pie de Página ==== -->
    <footer class="main-footer" role="contentinfo">
        <p data-key="footer_copy">&copy; 2025 EcoMentes. Todos los derechos reservados.</p>
        <p data-key="footer_subtitle">Un proyecto dedicado al aprendizaje y la conciencia ambiental.</p>
    </footer>


    <!-- ================================================================= -->
    <!--          CÓDIGO JAVASCRIPT INTEGRADO (JavaScript-in-HTML)         -->
    <!-- ================================================================= -->
    <script>
    /**
     * @file Aplicación EcoMentes
     * @description Lógica completa de la aplicación de aprendizaje interactivo.
     * Este script está encapsulado en una IIFE para evitar la contaminación del scope global.
     * @author Gemini AI Expert Coder
     * @version 2.0.0
     */
    (function() {
        'use strict';

        // --------------------------------------------------------------------
        //                             MÓDULO DE DATOS (Data Manager)
        // --------------------------------------------------------------------
        // Centraliza todos los datos de la aplicación: conceptos, problemas y
        // cadenas de texto para internacionalización (i18n).
        // --------------------------------------------------------------------
        const dataManager = {
            /**
             * Contiene todos los conceptos y sus problemas asociados.
             * Fácilmente extensible con nuevos conceptos.
             * @type {Array<Object>}
             */
            concepts: [
                { id: 'fotosintesis', problems: { easy: [{ q: 'Si 1 árbol absorbe 22 kg de CO2/año, ¿cuánto absorberán 50 árboles?', a: '1100' }], intermediate: [{ q: 'Una planta produce 30g de glucosa (C6H12O6). La ecuación es 6CO2 + 6H2O -> C6H12O6 + 6O2. Si masa molar CO2=44g y glucosa=180g, ¿cuántos gramos de CO2 consumió?', a: '44' }], hard: [{ q: '1 hectárea (10000 m²) reforestada absorbe 5 ton de CO2/año. La huella de un hogar es 2.5 ton/año. ¿Cuántos m² se necesitan para compensar a 3 hogares?', a: '15000' }]}},
                { id: 'reciclaje', problems: { easy: [{ q: 'Reciclar 1 tonelada de papel salva 17 árboles. ¿Cuántos se salvan con 5.5 toneladas?', a: '93.5' }], intermediate: [{ q: 'Una familia genera 1.2 kg de plástico/día. Si recicla el 25%, ¿cuántos kg de plástico NO reciclado genera en un mes de 30 días?', a: '27' }], hard: [{ q: 'Una lata de aluminio reciclado consume 5% de la energía de una nueva (100 UE). ¿Cuánta energía se ahorra en 2000 latas si el 70% son recicladas?', a: '133000' }]}},
                { id: 'ciclo_del_agua', problems: { easy: [{ q: 'Un lago pierde por evaporación 2,000 litros de agua por día. ¿Cuántos litros perderá en 7 días?', a: '14000' }], intermediate: [{ q: 'De 100u de lluvia, 40% se evapora, 10% va a ríos, el resto se infiltra. Si caen 500 litros, ¿cuántos se infiltran?', a: '250' }], hard: [{ q: 'Una planta transpira el 99% del agua que absorbe. Si absorbe 5L/semana pero la lluvia le devuelve el 20% de lo transpirado. ¿Cuál es su pérdida neta en L?', a: '3.96' }]}},
                { id: 'energia_renovable', problems: { easy: [{ q: 'Un panel solar genera 300W. Si recibe 5 horas de sol pico, ¿cuántos kWh genera? (1000W=1kW)', a: '1.5' }], intermediate: [{ q: 'Una turbina eólica produce 2MW. ¿Cuántos hogares que consumen 4000 kWh/año puede alimentar? (1 año = 8760 h, asume 30% de eficiencia de la turbina)', a: '1314' }], hard: [{ q: 'Un coche eléctrico tiene una batería de 60kWh y consume 15kWh/100km. Si lo cargo con solar (a $0.1/kWh) vs gasolina ($1.5/L y 8L/100km). ¿Cuánto ahorro en 100km?', a: '10.5' }]}},
                { id: 'biodiversidad', problems: { easy: [{ q: 'Un área tenía 50 especies de aves y perdió el 10%. ¿Cuántas especies quedan?', a: '45' }], intermediate: [{ q: 'En una reserva de 10km², hay 5 tigres. La densidad recomendada es 1 tigre/15km². ¿Está sobrepoblada?', a: 'Si' }], hard: [{ q: 'El índice de Simpson es D = Σ(n/N)². En un área con 2 especies, hay 20 de A y 80 de B (N=100). Calcula el valor D.', a: '0.68' }]}},
                { id: 'cadena_trofica', problems: { easy: [{ q: 'Si los productores tienen 10,000 kcal de energía, ¿cuánta energía llega a los consumidores terciarios, asumiendo una transferencia del 10% en cada nivel?', a: '10' }], intermediate: [{ q: 'Una plaga reduce los productores en un 50%. Si había 1000 conejos (consumidores primarios), ¿cuál sería la nueva población de soporte?', a: '500' }], hard: [{ q: 'Si se introduce una especie invasora que compite con los depredadores tope (secundarios). Si antes había 50 águilas. ¿Es esperable un aumento o una disminución?', a: 'Disminucion' }]}},
                { id: 'efecto_invernadero', problems: { easy: [{ q: 'Si la concentración de CO2 era 320 ppm en 1960 y 420 ppm hoy. ¿En qué porcentaje aumentó?', a: '31.25' }], intermediate: [{ q: 'Un coche emite 120 g CO2/km. ¿Cuántos kg de CO2 emite en un viaje de 500 km?', a: '60' }], hard: [{ q: 'Plantar un árbol compensa 20kg CO2/año. Si tus emisiones son 4 ton/año, ¿cuántos árboles necesitas plantar para ser carbono neutral?', a: '200' }]}},
                { id: 'huella_de_carbono', problems: { easy: [{ q: 'Si dejas una luz de 60W encendida 10 horas extra. ¿Cuántos kWh consumiste de más?', a: '0.6' }], intermediate: [{ q: 'Un vuelo de 1000km emite 250kg de CO2. Viajar en tren la misma distancia emite un 80% menos. ¿Cuánto emite el tren?', a: '50' }], hard: [{ q: 'Una persona promedio en el país A emite 15 toneladas/año. En el país B, 2 toneladas/año. ¿Cuántas veces mayor es la huella en A?', a: '7.5' }]}},
                { id: 'desarrollo_sostenible', problems: { easy: [{ q: 'Una empresa usaba 10000 hojas de papel/mes. Con digitalización, redujo su uso en un 90%. ¿Cuántas hojas usa ahora?', a: '1000' }], intermediate: [{ q: 'Una comunidad de 100 personas consume 15000L de agua/día. Instalan sistemas de recolección de lluvia que proveen 3000L/día. ¿Cuál es el nuevo consumo de la red por persona?', a: '120' }], hard: [{ q: 'Una inversión en eficiencia energética de $5000 ahorra $100/mes en electricidad. ¿En cuántos meses se recupera la inversión?', a: '50' }]}},
                { id: 'contaminacion_plastica', problems: { easy: [{ q: 'Una botella de plástico tarda 450 años en degradarse. Si se tiró en el año 1800, ¿ya se ha degradado?', a: 'No' }], intermediate: [{ q: 'Cada minuto, 1 millón de botellas de plástico se compran en el mundo. ¿Cuántas se compran en 1 día? (1 día = 1440 min)', a: '1440000000' }], hard: [{ q: 'Un país produce 100,000 ton de residuo plástico. Solo el 9% se recicla. El 12% se incinera. El resto acaba en vertederos/naturaleza. ¿Cuántas toneladas son?', a: '79000' }]}}
            ],

            /**
             * Textos para internacionalización (i18n).
             * @type {Object}
             */
            translations: {
                es: {
                    title: 'EcoMentes - Plataforma de Aprendizaje Verde', main_title: 'EcoMentes',
                    nav_home: 'Inicio', nav_concepts: 'Conceptos', nav_practice: 'Práctica', nav_together: 'Aprendamos Juntos', nav_tips: 'Consejos', nav_about: 'Quiénes Somos', nav_settings: 'Ajustes',
                    hero_title: 'Bienvenido a tu Aventura del Conocimiento', hero_subtitle: 'Un espacio donde aprender es un acto natural. Sumérgete en conceptos, practica con desafíos y colabora para crecer.', hero_button: 'Empezar a Aprender',
                    concepts_title: 'Conceptos Fundamentales', search_placeholder: 'Busca un concepto (ej. Reciclaje)...',
                    practice_title: 'Pon a Prueba tus Conocimientos', practice_subtitle: 'Aquí aparecerán los problemas cuando presiones "Practica" en un concepto.',
                    together_title: 'Colabora y Crece', together_prompt: 'Crea un perfil para conectar con amigos.', username_placeholder: 'Elige tu nombre de usuario', create_user_btn: 'Crear Usuario',
                    welcome_user: 'Bienvenido,', friend_code_label: 'Tu código de amigo:', delete_user_btn: 'Eliminar Usuario', friends_list_title: 'Lista de Amigos (Simulación)',
                    tips_title: '20 Consejos para Potenciar tu Estudio',
                    about_title: 'Nuestro Equipo', about_text: `Somos un grupo de estudiantes apasionados por la tecnología y la educación ambiental. Nuestra misión con "EcoMentes" es crear una herramienta interactiva y accesible que no solo facilite el aprendizaje de conceptos complejos, sino que también fomente una conciencia sobre la importancia de cuidar nuestro planeta. Creemos que el conocimiento es la semilla del cambio, y a través de esta plataforma, esperamos inspirar a la próxima generación de pensadores y cuidadores del medio ambiente.`,
                    settings_title: 'Ajustes Personalizados', language_label: 'Idioma:', bg_url_label: 'Fondo desde URL:', bg_upload_label: 'Fondo desde tu dispositivo:', url_placeholder: 'https://ejemplo.com/imagen.jpg', dark_mode_label: 'Modo Oscuro', lang_pt: 'Português', lang_de: 'Deutsch', lang_fr: 'Français',
                    practice_button: 'Practica', level_easy: 'Fácil', level_intermediate: 'Intermedio', level_hard: 'Difícil', problem_for: 'Práctica:', verify_btn: 'Verificar', collaborate_btn: 'Aprendamos Juntos', correct_feedback: '¡Correcto! Excelente trabajo.', incorrect_feedback: 'Respuesta incorrecta. ¡Sigue intentando!',
                    fotosintesis_title: 'Fotosíntesis', fotosintesis_def: 'Proceso químico de las plantas para convertir materia inorgánica (CO2, agua) en orgánica (glucosa) usando luz solar y liberando oxígeno.',
                    reciclaje_title: 'Reciclaje', reciclaje_def: 'Proceso para convertir residuos en nuevos productos o materia prima, reduciendo el consumo de recursos naturales.',
                    ciclo_del_agua_title: 'Ciclo del Agua', ciclo_del_agua_def: 'Circulación continua del agua en la Tierra (evaporación, condensación, precipitación), fundamental para la vida.',
                    energia_renovable_title: 'Energía Renovable', energia_renovable_def: 'Energía obtenida de fuentes naturales virtualmente inagotables (sol, viento, agua), que no producen gases de efecto invernadero.',
                    biodiversidad_title: 'Biodiversidad', biodiversidad_def: 'Variedad de seres vivos en la Tierra, desde genes y especies hasta ecosistemas. Es esencial para el equilibrio ecológico.',
                    cadena_trofica_title: 'Cadena Trófica', cadena_trofica_def: 'Secuencia de transferencia de materia y energía en forma de alimento de un organismo a otro en un ecosistema.',
                    efecto_invernadero_title: 'Efecto Invernadero', efecto_invernadero_def: 'Fenómeno natural por el que ciertos gases retienen parte del calor del sol en la atmósfera, manteniendo la temperatura terrestre. Su intensificación causa el calentamiento global.',
                    huella_de_carbono_title: 'Huella de Carbono', huella_de_carbono_def: 'Totalidad de gases de efecto invernadero emitidos directa o indirectamente por un individuo, organización, evento o producto.',
                    desarrollo_sostenible_title: 'Desarrollo Sostenible', desarrollo_sostenible_def: 'Desarrollo que satisface las necesidades del presente sin comprometer la capacidad de las futuras generaciones para satisfacer sus propias necesidades.',
                    contaminacion_plastica_title: 'Contaminación Plástica', contaminacion_plastica_def: 'Acumulación de productos de plástico en el medio ambiente que causa efectos adversos sobre la vida silvestre, su hábitat y los seres humanos.'
                },
                en: {
                    title: 'EcoMinds - Green Learning Platform', main_title: 'EcoMinds',
                    nav_home: 'Home', nav_concepts: 'Concepts', nav_practice: 'Practice', nav_together: 'Learn Together', nav_tips: 'Tips', nav_about: 'About Us', nav_settings: 'Settings',
                    hero_title: 'Welcome to Your Knowledge Adventure', hero_subtitle: 'A space where learning is a natural act. Dive into concepts, practice with challenges, and collaborate to grow.', hero_button: 'Start Learning',
                    concepts_title: 'Fundamental Concepts', search_placeholder: 'Search for a concept (e.g., Recycling)...',
                    practice_title: 'Test Your Knowledge', practice_subtitle: 'Problems will appear here when you press "Practice" on a concept.',
                    together_title: 'Collaborate and Grow', together_prompt: 'Create a profile to connect with friends.', username_placeholder: 'Choose your username', create_user_btn: 'Create User',
                    welcome_user: 'Welcome,', friend_code_label: 'Your friend code:', delete_user_btn: 'Delete User', friends_list_title: 'Friends List (Simulation)',
                    tips_title: '20 Tips to Boost Your Studies',
                    about_title: 'Our Team', about_text: `We are a group of students passionate about technology and environmental education. Our mission with "EcoMinds" is to create an interactive and accessible tool that not only facilitates learning complex concepts but also fosters awareness of the importance of caring for our planet. We believe that knowledge is the seed of change, and through this platform, we hope to inspire the next generation of thinkers and caretakers of the environment.`,
                    settings_title: 'Custom Settings', language_label: 'Language:', bg_url_label: 'Background from URL:', bg_upload_label: 'Background from your device:', url_placeholder: 'https://example.com/image.jpg', dark_mode_label: 'Dark Mode', lang_pt: 'Portuguese', lang_de: 'German', lang_fr: 'French',
                    practice_button: 'Practice', level_easy: 'Easy', level_intermediate: 'Intermediate', level_hard: 'Hard', problem_for: 'Practice:', verify_btn: 'Verify', collaborate_btn: 'Learn Together', correct_feedback: 'Correct! Excellent work.', incorrect_feedback: 'Incorrect answer. Keep trying!',
                    fotosintesis_title: 'Photosynthesis', fotosintesis_def: 'Chemical process in plants to convert inorganic matter (CO2, water) into organic matter (glucose) using sunlight and releasing oxygen.',
                    reciclaje_title: 'Recycling', reciclaje_def: 'Process to convert waste into new products or raw material, reducing the consumption of natural resources.',
                    ciclo_del_agua_title: 'Water Cycle', ciclo_del_agua_def: 'Continuous circulation of water on Earth (evaporation, condensation, precipitation), essential for life.',
                    energia_renovable_title: 'Renewable Energy', energia_renovable_def: 'Energy obtained from virtually inexhaustible natural sources (sun, wind, water), which do not produce greenhouse gases.',
                    biodiversidad_title: 'Biodiversity', biodiversidad_def: 'Variety of living beings on Earth, from genes and species to ecosystems. It is essential for ecological balance.',
                    cadena_trofica_title: 'Food Chain', cadena_trofica_def: 'Sequence of transfer of matter and energy in the form of food from one organism to another in an ecosystem.',
                    efecto_invernadero_title: 'Greenhouse Effect', efecto_invernadero_def: 'Natural phenomenon by which certain gases retain part of the sun\'s heat in the atmosphere, maintaining Earth\'s temperature. Its intensification causes global warming.',
                    huella_de_carbono_title: 'Carbon Footprint', huella_de_carbono_def: 'Totality of greenhouse gases emitted directly or indirectly by an individual, organization, event, or product.',
                    desarrollo_sostenible_title: 'Sustainable Development', desarrollo_sostenible_def: 'Development that meets the needs of the present without compromising the ability of future generations to meet their own needs.',
                    contaminacion_plastica_title: 'Plastic Pollution', contaminacion_plastica_def: 'Accumulation of plastic products in the environment that causes adverse effects on wildlife, their habitat, and humans.'
                }
            }
        };

        // --------------------------------------------------------------------
        //                           ESTADO DE LA APLICACIÓN (App State)
        // --------------------------------------------------------------------
        // Un objeto central para mantener el estado actual de la aplicación,
        // como el idioma, el usuario, etc. Facilita la gestión.
        // --------------------------------------------------------------------
        const appState = {
            currentLang: 'es',
            currentUser: null,
            currentTheme: 'light',
            currentProblem: null,
            friendStatusInterval: null
        };
        
        // --------------------------------------------------------------------
        //                    GESTOR DE LA INTERFAZ (UI Manager)
        // --------------------------------------------------------------------
        // Contiene todas las funciones que manipulan el DOM. Mantiene el
        // código limpio al separar la lógica de la presentación.
        // --------------------------------------------------------------------
        const uiManager = {
            // Un cache para los elementos del DOM que se usan frecuentemente
            elements: {},

            /**
             * Inicializa el cache de elementos del DOM.
             */
            init() {
                this.elements = {
                    conceptGrid: document.getElementById('concept-grid'),
                    searchInput: document.getElementById('buscadorConceptos'),
                    practiceArea: document.getElementById('practice-area'),
                    userLoginArea: document.getElementById('user-login-area'),
                    userInfoArea: document.getElementById('user-info-area'),
                    createUserInput: document.getElementById('username-input'),
                    createUserBtn: document.getElementById('createUserBtn'),
                    deleteUserBtn: document.getElementById('deleteUserBtn'),
                    usernameDisplay: document.getElementById('username-display'),
                    friendCodeDisplay: document.getElementById('friend-code-display'),
                    languageSelect: document.getElementById('language-select'),
                    themeToggle: document.getElementById('theme-toggle'),
                    friendList: document.getElementById('friend-list'),
                    mobileMenuButton: document.querySelector('.mobile-menu-button'),
                    mainNav: document.querySelector('.main-nav'),
                };
            },

            /**
             * Renderiza la cuadrícula de conceptos, opcionalmente filtrada.
             * @param {string} [filter=''] - El texto para filtrar los conceptos.
             */
            renderConcepts(filter = '') {
                this.elements.conceptGrid.innerHTML = '';
                const lang = appState.currentLang;
                const filteredConcepts = dataManager.concepts.filter(c => {
                    const title = dataManager.translations[lang][`${c.id}_title`] || '';
                    return title.toLowerCase().includes(filter.toLowerCase());
                });

                if (filteredConcepts.length === 0) {
                    this.elements.conceptGrid.innerHTML = `<p>${dataManager.translations[lang].no_results || 'No results.'}</p>`;
                    return;
                }

                filteredConcepts.forEach(concept => {
                    const card = document.createElement('article');
                    card.className = 'concept-card';
                    card.innerHTML = `
                        <h3>${dataManager.translations[lang][`${concept.id}_title`]}</h3>
                        <div class="concept-details">
                            <p><strong>${dataManager.translations.es.fotosintesis_def ? 'Definición' : 'Definition'}:</strong> ${dataManager.translations[lang][`${concept.id}_def`]}</p>
                        </div>
                        <a href="#practica" class="practice-button" data-concept-id="${concept.id}">${dataManager.translations[lang].practice_button}</a>`;
                    this.elements.conceptGrid.appendChild(card);
                });
            },
            
            /**
             * Renderiza el área de práctica para un concepto y dificultad.
             * @param {string} conceptId - El ID del concepto.
             * @param {string} difficulty - 'easy', 'intermediate', o 'hard'.
             */
            renderPractice(conceptId, difficulty) {
                const concept = dataManager.concepts.find(c => c.id === conceptId);
                const lang = appState.currentLang;
                if (!concept || !concept.problems[difficulty] || concept.problems[difficulty].length === 0) {
                    this.elements.practiceArea.innerHTML = `<p>${dataManager.translations[lang].no_problems || 'No problems available.'}</p>`;
                    return;
                }

                appState.currentProblem = concept.problems[difficulty][Math.floor(Math.random() * concept.problems[difficulty].length)];
                
                const conceptTitle = dataManager.translations[lang][`${concept.id}_title`];
                this.elements.practiceArea.innerHTML = `
                    <div class="practice-block">
                        <h3>${dataManager.translations[lang].problem_for} ${conceptTitle}</h3>
                        <div class="difficulty-selector">
                            <button class="difficulty-btn ${difficulty === 'easy' ? 'active' : ''}" data-concept-id="${conceptId}" data-difficulty="easy">${dataManager.translations[lang].level_easy}</button>
                            <button class="difficulty-btn ${difficulty === 'intermediate' ? 'active' : ''}" data-concept-id="${conceptId}" data-difficulty="intermediate">${dataManager.translations[lang].level_intermediate}</button>
                            <button class="difficulty-btn ${difficulty === 'hard' ? 'active' : ''}" data-concept-id="${conceptId}" data-difficulty="hard">${dataManager.translations[lang].level_hard}</button>
                        </div>
                        <div class="problem-statement">${appState.currentProblem.q}</div>
                        <div class="answer-section">
                            <input type="text" id="answer-input" placeholder="${dataManager.translations[lang].answer_placeholder || 'Your answer...'}" aria-label="Problem answer">
                            <button class="submit-answer">${dataManager.translations[lang].verify_btn}</button>
                        </div>
                        <div class="feedback" role="alert" aria-live="assertive"></div>
                        <button class="collaborate-button" data-key="collaborate_btn"><i class="fa-solid fa-users"></i> ${dataManager.translations[lang].collaborate_btn}</button>
                    </div>`;
            },
            
            /**
             * Muestra el feedback de la respuesta.
             * @param {boolean} isCorrect - Si la respuesta es correcta.
             */
            showFeedback(isCorrect) {
                const feedbackEl = this.elements.practiceArea.querySelector('.feedback');
                if (!feedbackEl) return;
                const lang = appState.currentLang;
                if (isCorrect) {
                    feedbackEl.textContent = dataManager.translations[lang].correct_feedback;
                    feedbackEl.className = 'feedback correct';
                } else {
                    feedbackEl.textContent = dataManager.translations[lang].incorrect_feedback;
                    feedbackEl.className = 'feedback incorrect';
                }
            },
            
            /**
             * Actualiza toda la UI con las traducciones del idioma seleccionado.
             */
            updateLanguageUI() {
                const lang = appState.currentLang;
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    if (dataManager.translations[lang][key]) el.textContent = dataManager.translations[lang][key];
                });
                document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-key-placeholder');
                    if (dataManager.translations[lang][key]) el.placeholder = dataManager.translations[lang][key];
                });
                this.renderConcepts(this.elements.searchInput.value);
                 this.elements.practiceArea.innerHTML = `<p class="description" data-key="practice_subtitle">${dataManager.translations[lang].practice_subtitle}</p>`;
            },
            
             /**
             * Actualiza la UI para mostrar el estado de login del usuario.
             */
            updateUserUI() {
                if (appState.currentUser) {
                    this.elements.userLoginArea.classList.add('hidden');
                    this.elements.userInfoArea.classList.remove('hidden');
                    this.elements.usernameDisplay.textContent = appState.currentUser;
                    this.elements.friendCodeDisplay.textContent = `${appState.currentUser}#${(appState.currentUser.length * 123) % 10000}`;
                } else {
                    this.elements.userLoginArea.classList.remove('hidden');
                    this.elements.userInfoArea.classList.add('hidden');
                }
            },

            /**
             * Simula la actualización del estado de amigos.
             */
            updateFriendStatus() {
                const friends = [{name: 'AmigoVerde123'}, {name: 'Creatividad99'}, {name: 'EcoGuerrero'}];
                this.elements.friendList.innerHTML = friends.map(friend => {
                    const isOnline = Math.random() > 0.5;
                    return `<p><span class="status ${isOnline ? 'online' : 'offline'}" aria-label="${isOnline ? 'Conectado' : 'Desconectado'}"></span> ${friend.name}</p>`;
                }).join('');
            }
        };

        // --------------------------------------------------------------------
        //                    LÓGICA PRINCIPAL (App Controller)
        // --------------------------------------------------------------------
        // Orquesta toda la aplicación, inicializa los componentes y maneja
        // la lógica de negocio.
        // --------------------------------------------------------------------
        const app = {
            /**
             * Punto de entrada de la aplicación.
             */
            init() {
                // Primero inicializar UI Manager para tener el cache de elementos
                uiManager.init();

                // Cargar configuraciones del usuario desde localStorage
                this.loadSettings();

                // Configurar todos los event listeners
                eventManager.init();
                
                // Renderizar contenido inicial
                uiManager.updateLanguageUI();
                uiManager.updateUserUI();

                // Simular la actualización del estado de amigos
                uiManager.updateFriendStatus();
                appState.friendStatusInterval = setInterval(uiManager.updateFriendStatus.bind(uiManager), 5000); // Actualiza cada 5 seg.

                console.log("EcoMentes App v2.0.0 inicializada.");
            },
            
            /**
             * Carga el estado guardado (usuario, tema, idioma) desde localStorage.
             */
            loadSettings() {
                // Cargar usuario
                appState.currentUser = localStorage.getItem('ecoMentesUser') || null;

                // Cargar y aplicar tema
                const savedTheme = localStorage.getItem('ecoMentesTheme') || 'light';
                this.setTheme(savedTheme);
                
                // Cargar y aplicar fondo de pantalla
                const savedBgUrl = localStorage.getItem('ecoMentesBgUrl');
                const savedBgFile = localStorage.getItem('ecoMentesBgFile');
                if (savedBgUrl) {
                    document.body.style.backgroundImage = `url('${savedBgUrl}')`;
                } else if (savedBgFile) {
                    document.body.style.backgroundImage = `url('${savedBgFile}')`;
                }

                // Cargar idioma (si hubiera sido guardado)
                appState.currentLang = localStorage.getItem('ecoMentesLang') || 'es';
                uiManager.elements.languageSelect.value = appState.currentLang;
            },
            
            /**
             * Cambia el idioma de la aplicación.
             * @param {string} lang - El código del idioma (e.g., 'en', 'es').
             */
            changeLanguage(lang) {
                if (dataManager.translations[lang]) {
                    appState.currentLang = lang;
                    localStorage.setItem('ecoMentesLang', lang);
                    uiManager.updateLanguageUI();
                }
            },
            
            /**
             * Establece el tema de la aplicación (claro u oscuro).
             * @param {string} theme - 'light' o 'dark'.
             */
            setTheme(theme) {
                appState.currentTheme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('ecoMentesTheme', theme);
                uiManager.elements.themeToggle.checked = theme === 'dark';
            },

            /**
             * Verifica la respuesta a un problema de práctica.
             */
            checkAnswer() {
                const userAnswer = uiManager.elements.practiceArea.querySelector('#answer-input').value.trim();
                const isCorrect = userAnswer.toLowerCase() === appState.currentProblem.a.toLowerCase();
                uiManager.showFeedback(isCorrect);
            },
            
            /**
             * Establece el fondo de pantalla desde una URL.
             * @param {string} url - La URL de la imagen.
             */
            setBackgroundFromUrl(url) {
                document.body.style.backgroundImage = `url('${url}')`;
                localStorage.setItem('ecoMentesBgUrl', url);
                localStorage.removeItem('ecoMentesBgFile');
            },

            /**
             * Establece el fondo de pantalla desde un archivo subido.
             * @param {File} file - El archivo de imagen.
             */
            setBackgroundFromFile(file) {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    try {
                        localStorage.setItem('ecoMentesBgFile', imageUrl);
                        localStorage.removeItem('ecoMentesBgUrl');
                    } catch(err) {
                        console.error("Error al guardar imagen en localStorage:", err);
                        alert("La imagen es muy grande para ser guardada permanentemente.");
                    }
                 };
                 reader.readAsDataURL(file);
            },
        };

        // --------------------------------------------------------------------
        //                           GESTOR DE EVENTOS (Event Manager)
        // --------------------------------------------------------------------
        // Centraliza la asignación de todos los listeners de eventos.
        // Mantiene el código de inicialización limpio.
        // --------------------------------------------------------------------
        const eventManager = {
            init() {
                // Evento de búsqueda de conceptos
                uiManager.elements.searchInput.addEventListener('input', (e) => {
                    uiManager.renderConcepts(e.target.value);
                });

                // Clics en la cuadrícula de conceptos (para el botón 'Practica')
                uiManager.elements.conceptGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('practice-button')) {
                        e.preventDefault();
                        const conceptId = e.target.dataset.conceptId;
                        uiManager.renderPractice(conceptId, 'easy');
                        uiManager.elements.practiceArea.scrollIntoView({ behavior: 'smooth' });
                    }
                });

                // Clics en el área de práctica
                uiManager.elements.practiceArea.addEventListener('click', (e) => {
                    if (e.target.classList.contains('difficulty-btn')) {
                        const { conceptId, difficulty } = e.target.dataset;
                        uiManager.renderPractice(conceptId, difficulty);
                    }
                    if (e.target.classList.contains('submit-answer')) {
                        app.checkAnswer();
                    }
                     if (e.target.classList.contains('collaborate-button')) {
                        this.handleCollaboration();
                    }
                });

                // Creación de usuario
                uiManager.elements.createUserBtn.addEventListener('click', this.handleUserCreation);

                // Borrado de usuario
                uiManager.elements.deleteUserBtn.addEventListener('click', this.handleUserDeletion);

                // Copiar código de amigo
                document.getElementById('copy-code-btn').addEventListener('click', this.copyFriendCode);

                // Cambiar idioma
                uiManager.elements.languageSelect.addEventListener('change', (e) => {
                    app.changeLanguage(e.target.value);
                });

                // Cambiar tema
                uiManager.elements.themeToggle.addEventListener('change', (e) => {
                    app.setTheme(e.target.checked ? 'dark' : 'light');
                });

                // Aplicar fondo desde URL
                document.getElementById('background-url').addEventListener('change', (e) => {
                    if(e.target.value.trim() !== "") app.setBackgroundFromUrl(e.target.value.trim());
                });

                // Aplicar fondo desde archivo
                document.getElementById('background-upload').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) app.setBackgroundFromFile(e.target.files[0]);
                });

                // Menú móvil
                uiManager.elements.mobileMenuButton.addEventListener('click', this.toggleMobileMenu);
            },
            
            handleCollaboration() {
                const problemText = uiManager.elements.practiceArea.querySelector('.problem-statement')?.textContent;
                if(problemText) {
                    const textToCopy = `¡Ayúdame con este problema en EcoMentes! \n\nProblema: "${problemText}"`;
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => alert('Problema copiado al portapapeles. ¡Compártelo!'))
                        .catch(err => console.error('Error al copiar:', err));
                }
            },
            
            handleUserCreation() {
                const username = uiManager.elements.createUserInput.value.trim();
                if (username) {
                    appState.currentUser = username;
                    localStorage.setItem('ecoMentesUser', username);
                    uiManager.updateUserUI();
                    uiManager.elements.createUserInput.value = '';
                }
            },
            
            handleUserDeletion() {
                if (confirm('¿Estás seguro de que quieres eliminar tu usuario? Esta acción no se puede deshacer.')) {
                    appState.currentUser = null;
                    localStorage.removeItem('ecoMentesUser');
                    uiManager.updateUserUI();
                }
            },

            copyFriendCode() {
                navigator.clipboard.writeText(uiManager.elements.friendCodeDisplay.textContent)
                    .then(() => alert('¡Código de amigo copiado!'))
                    .catch(err => console.error(err));
            },

            toggleMobileMenu() {
                 uiManager.elements.mainNav.classList.toggle('active');
                 const isExpanded = uiManager.elements.mainNav.classList.contains('active');
                 uiManager.elements.mobileMenuButton.setAttribute('aria-expanded', isExpanded);
            }
        };

        // --------------------------------------------------------------------
        //                           INICIALIZACIÓN DE LA APP
        // --------------------------------------------------------------------
        // Una vez que el DOM está completamente cargado, se inicia la aplicación.
        // --------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="mainTitle">Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      :root{
        --primary-gradient:linear-gradient(90deg, #1abc9c, #16a085);--primary-color:#16a085;--secondary-color:#2c3e50;
        --bg-color:#ecf0f1;--card-bg:#ffffff;--text-dark:#34495e;--text-light:#7f8c8d;
        --shadow:0 10px 30px rgba(0,0,0,0.07);--radius:16px;--online-color:#2ecc71;--offline-color:#bdc3c7;
        --font-base-size:16px;
      }
      body.large-text{--font-base-size:18px;} /* Aumento significativo para accesibilidad */
      body.dark-theme{ /* Tema de alto contraste */
        --primary-gradient:linear-gradient(90deg, #1abc9c, #1dd2af);--primary-color:#1abc9c;--secondary-color:#ecf0f1;
        --bg-color:#2c3e50;--card-bg:#34495e;--text-dark:#ecf0f1;--text-light:#95a5a6;
      }
      *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
      body{font-family:'Lato',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;transition:background-color .3s,color .3s;font-size:var(--font-base-size)}
      main{display:none} /* Se controla con JS para evitar FOUC (Flash Of Unstyled Content) */
      .page-section{display:none}.page-section.active{display:block;animation:fadeIn 0.5s ease-in-out forwards}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .container{max-width:1200px;margin:0 auto;padding:2rem}.page-header{margin-bottom:2.5rem;text-align:center}
      .page-header h1{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*2.2);color:var(--secondary-color)}.page-header p{font-size:calc(var(--font-base-size)*1.1);color:var(--text-light);max-width:700px;margin:.5rem auto 0}
      .btn{display:inline-block;padding:.8rem 1.8rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .2s ease,box-shadow .3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-base-size)}.btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(22,160,133,.4)}.btn-secondary{background:#95a5a6;box-shadow:0 4px 15px rgba(0,0,0,.1)}.btn-secondary:hover{background:#7f8c8d}.btn-back{display:block;width:fit-content;margin-top:2.5rem}
      .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);transition:transform .3s,box-shadow .3s, background-color .3s, color .3s}.card:hover{transform:translateY(-8px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
      .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dee2e6;background:var(--bg-color);color:var(--text-dark);border-radius:8px;font-size:var(--font-base-size);transition:border-color .2s,box-shadow .2s}
      .input-field:focus-visible{outline:2px solid var(--primary-color);box-shadow:0 0 0 3px rgba(22,160,133,.2)}
      /* Inicio */#view-inicio{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#1c2541}.inicio-content{animation:fadeIn 2s}.inicio-content h1{font-family:'Poppins',sans-serif;font-size:clamp(3rem, 10vw, 5.5rem);letter-spacing:2px}.inicio-content p{font-size:1.5rem;color:rgba(255,255,255,.8);margin-bottom:2rem}.inicio-content .btn{padding:1rem 3rem;font-size:1.2rem}
      /* Menu */.menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.menu-card{text-align:center;text-decoration:none;color:var(--text-dark);font-size:var(--font-base-size)}.menu-card .icon{font-size:3rem;color:var(--primary-color);margin-bottom:1rem;display:block}.menu-card h3{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.3)}#view-menu{position:relative;overflow:hidden;border-radius:var(--radius);padding:2rem;background-color:var(--bg-color);transition:none}
      #menu-background-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;background-image:linear-gradient(-45deg, #2ecc71, #1abc9c, #3498db, #2c3e50); background-size: 200% 200%; animation:gradientBG 15s ease infinite;}@keyframes gradientBG {0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}}
      /* Conceptos */#concept-detail-container h3{font-size:calc(var(--font-base-size)*1.5);color:var(--primary-color);margin-top:1.5rem}.content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.5rem}.content-card{cursor:pointer} .content-card h4{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.2)}.content-card p{font-size:var(--font-base-size);}.datalist-suggestions{max-height:150px;overflow-y:auto;border:1px solid #dee2e6;border-top:none;border-radius:0 0 8px 8px;background-color:var(--card-bg);position:absolute;width:100%;z-index:10}.datalist-suggestions option{padding:.5rem 1rem;cursor:pointer}.datalist-suggestions option:hover{background-color:#f1f3f5}
      /* Práctica */.problem-card{margin-bottom:1.5rem}.problem-card .response-form{margin-top:1rem;display:flex;gap:.5rem}.problem-card .feedback{margin-top:.5rem;padding:.5rem;border-radius:8px;display:none;font-weight:700;font-size:var(--font-base-size)}.problem-card .feedback.correct{background-color:#d4edda;color:#155724}.problem-card .feedback.incorrect{background-color:#f8d7da;color:#721c24}
      /* Chat */.chat-layout{display:grid;grid-template-columns:320px 1fr;gap:1.5rem;height:75vh;max-height:700px}#friends-list{overflow-y:auto;flex-grow:1}
      .friend-item{padding:.8rem 1rem;border-radius:8px;cursor:pointer;margin-bottom:.5rem;display:flex;align-items:center;gap:.75rem;font-weight:500;transition:background-color .2s;font-size:var(--font-base-size)}.friend-item:hover,.friend-item.active{background-color:#e0e6e8}
      .friend-status{width:10px;height:10px;border-radius:50%;background-color:var(--offline-color);transition:background-color .3s}.friend-status.online{background-color:var(--online-color)}.friend-delete{background:none;border:none;color:var(--text-light);cursor:pointer;opacity:0;transition:opacity .2s;margin-left:auto;font-size:calc(var(--font-base-size)*1.2)}.friend-item:hover .friend-delete{opacity:1}
      .chat-window{display:flex;flex-direction:column}.chat-messages{flex-grow:1;border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;overflow-y:auto;margin-bottom:1rem;background:var(--bg-color)}.message-bubble{position:relative;max-width:80%;width:fit-content;padding:.7rem 1.2rem;border-radius:20px;margin-bottom:.75rem;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;font-size:var(--font-base-size)}
      .message-bubble.sent{background:var(--primary-gradient);color:white;margin-left:auto;border-bottom-right-radius:5px}.message-bubble.received{background-color:#e9ecef;color:var(--text-dark);margin-right:auto;border-bottom-left-radius:5px}.message-delete{position:absolute;top:50%;transform:translateY(-50%);right:-25px;background:none;border:none;color:var(--text-light);cursor:pointer;opacity:0;transition:opacity .2s;font-size:var(--font-base-size)}.message-bubble.sent:hover .message-delete{opacity:1}
      /* Username Overlay */#username-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}
      /* Ajustes */.settings-container h3{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.3);color:var(--secondary-color)}.toggle-switch{display:flex;align-items:center;justify-content:space-between;width:100%;margin-top:.5rem}.toggle-switch p{font-size:var(--font-base-size);margin:0}.toggle-switch input{opacity:0;width:0;height:0}
      .slider{position:relative;cursor:pointer;width:50px;height:26px;background-color:#ccc;border-radius:26px;transition:.4s}.slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background-color:white;border-radius:50%;transition:.4s}input:checked+.slider{background-color:var(--primary-color)}input:checked+.slider:before{transform:translateX(24px)}
      /* Accesibilidad */ .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}:focus-visible{outline:3px solid var(--primary-color) !important; outline-offset: 2px;}
    </style>
</head>
<body>
    <section id="view-inicio" class="page-section" aria-labelledby="welcome-title"><h1 class="sr-only" data-lang-key="mainTitle">Potencia tu Mente - Pantalla de Bienvenida</h1><div id="particles-js" aria-hidden="true"></div><div class="inicio-content" role="dialog" aria-labelledby="welcome-title"><h2 id="welcome-title" data-lang-key="mainTitle">Potencia tu Mente</h2><p data-lang-key="welcomeSlogan">Tu viaje al dominio de las matemáticas comienza ahora.</p><a href="#view-menu" class="btn nav-link" role="button" aria-label="Entrar al menú principal" data-lang-key="enterButton">Entrar</a></div></section>
    
    <main><header class="sr-only"><h1>Contenido Principal de Potencia tu Mente</h1></header><div class="container">
        <section id="view-menu" class="page-section card" role="region" aria-labelledby="menu-title"><div class="page-header"><h2 id="menu-title" data-lang-key="menuTitle">Menú Principal</h2></div><div class="menu-grid"><a href="#view-conceptos" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-book-open"></i></div><h3 data-lang-key="conceptsTitle">Conceptos</h3><p data-lang-key="conceptsMenuDesc">Explora todos los temas.</p></a><a href="#view-practica" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-brain"></i></div><h3 data-lang-key="practiceTitle">Práctica</h3><p data-lang-key="practiceMenuDesc">Ejercicios aleatorios.</p></a><a href="#view-consejos" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-lightbulb"></i></div><h3 data-lang-key="tipsTitle">Consejos</h3><p data-lang-key="tipsMenuDesc">Mejora tus habilidades.</p></a><a href="#view-chat" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-comments"></i></div><h3 data-lang-key="chatTitle">Aprendamos Juntos</h3><p data-lang-key="chatMenuDesc">Resuelve dudas con amigos.</p></a><a href="#view-quienes-somos" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-users"></i></div><h3 data-lang-key="whoTitle">Quiénes Somos</h3><p data-lang-key="whoMenuDesc">Conoce al equipo.</p></a><a href="#view-ajustes" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-cog"></i></div><h3 data-lang-key="settingsTitle">Ajustes</h3><p data-lang-key="settingsMenuDesc">Personaliza tu experiencia.</p></a></div></section>
        
        <section id="view-conceptos" class="page-section" role="region" aria-labelledby="conceptos-title"><div class="page-header"><h2 id="conceptos-title" data-lang-key="conceptsTitle">Conceptos Matemáticos</h2><p data-lang-key="conceptsPageDesc">Encuentra el tema que necesitas.</p></div><div class="filter-bar" role="search"><label for="concept-search" class="sr-only" data-lang-key="searchConceptLabel">Buscar tema</label><input type="search" id="concept-search" class="input-field" placeholder="Buscar tema..." list="concept-suggestions" aria-autocomplete="list" aria-controls="concept-suggestions" aria-label="Introduce el nombre de un concepto para buscar"></div><datalist id="concept-suggestions"></datalist><div id="concepts-grid" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-concepto-detalle" class="page-section" role="region" aria-labelledby="concepto-detalle-title"><div id="concept-detail-container" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-practica" class="page-section" role="region" aria-labelledby="practica-title"><div class="page-header"><h2 id="practica-title" data-lang-key="practiceTitle">Centro de Práctica</h2><p id="practice-header" data-lang-key="practicePageDesc">Genera ejercicios y situaciones problemáticas.</p></div><div class="filter-bar" role="search"><label for="practice-search" class="sr-only" data-lang-key="searchPracticeLabel">Buscar tema de práctica</label><input type="search" id="practice-search" class="input-field" placeholder="Buscar tema de práctica..." list="practice-suggestions" aria-autocomplete="list" aria-controls="practice-suggestions" aria-label="Introduce el nombre de un concepto para practicar"></div><datalist id="practice-suggestions"></datalist><div id="practice-grid" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-consejos" class="page-section" role="region" aria-labelledby="consejos-title"><div class="page-header"><h2 id="consejos-title" data-lang-key="tipsTitle">Consejos para Estudiantes</h2><p data-lang-key="tipsPageDesc">Estrategias para potenciar tu aprendizaje.</p></div><div id="consejos-container" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-chat" class="page-section" role="region" aria-labelledby="chat-title"><div id="username-overlay" role="dialog" aria-modal="true" aria-labelledby="username-form-title"><div class="card" style="width:100%;max-width:400px;text-align:center;"><h3 id="username-form-title" data-lang-key="chatOverlayTitle">Crea tu Perfil de Estudiante</h3><p style="margin-bottom:1rem;" data-lang-key="chatOverlayDesc">Elige un nombre para mostrar. Se te asignará un código único para agregar amigos.</p><form id="username-form" class="input-group"><label for="username-input" class="sr-only" data-lang-key="usernameLabel">Nombre de usuario</label><input type="text" id="username-input" class="input-field" placeholder="TuUsuario123" required minlength="3" aria-describedby="username-info"><span id="username-info" class="sr-only">El nombre de usuario debe tener al menos 3 caracteres.</span><button type="submit" class="btn" data-lang-key="saveAndEnterBtn">Guardar y Entrar</button></form></div></div><div class="page-header"><h2 id="chat-title" data-lang-key="chatTitle">Aprendamos Juntos</h2></div><div class="chat-layout"><aside class="card"><p data-lang-key="helloText">Hola, <strong id="your-username" style="color:var(--primary-color);"></strong></p><p style="font-size: 0.9em; color: var(--text-light); margin-top: -5px;" data-lang-key="yourCodeIsText">Tu código de amigo es: <strong id="your-code" title="Clic para copiar" style="cursor: pointer; user-select: all;" aria-label="Tu código de amigo, haz clic para copiar"></strong></p><h3 style="margin-top:1.5rem;font-family:'Poppins';" data-lang-key="friendsTitle">Amigos</h3><p style="font-size:0.9em;color:var(--text-light);margin-bottom:1rem;" data-lang-key="friendsDesc">Añade amigos usando su código único.</p><form id="add-friend-form" class="input-group"><label for="friend-code-input" class="sr-only" data-lang-key="friendCodeLabel">Código del amigo</label><input id="friend-code-input" class="input-field" placeholder="Código del amigo..." required aria-label="Introduce el código de amigo"><button type="submit" class="btn" aria-label="Añadir amigo" data-lang-key="addFriendBtn">+</button></form><div id="friends-list" aria-live="polite"></div></aside><div class="card chat-window" role="log" aria-labelledby="chat-header-title"><h3 id="chat-header" style="font-family:'Poppins';" data-lang-key="selectFriendText">Selecciona un amigo</h3><div class="chat-messages" id="chat-messages" aria-live="polite"></div><form id="chat-form" class="input-group"><label for="chat-input" class="sr-only" data-lang-key="writeMessageLabel">Escribe un mensaje</label><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled aria-label="Escribe tu mensaje aquí"><button type="submit" class="btn" disabled aria-label="Enviar mensaje" data-lang-key="sendButton">Enviar</button></form></div></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-quienes-somos" class="page-section" role="region" aria-labelledby="quienes-somos-title"><div class="page-header"><h2 id="quienes-somos-title" data-lang-key="whoTitle">¿Quiénes somos?</h2></div><div class="card" id="quienes-somos-container" style="line-height:1.8;color:var(--text-light);" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-ajustes" class="page-section" role="region" aria-labelledby="ajustes-title"><div class="page-header"><h2 id="ajustes-title" data-lang-key="settingsTitle">Ajustes</h2></div><div class="card"><div class="settings-container" style="display:flex;flex-direction:column;gap:2.5rem;"><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="languageSettingsTitle">Idioma de la Interfaz</h3><select id="language-selector" class="input-field" aria-label="Selector de idioma"><option value="es" data-lang-key="langES">Español</option><option value="en" data-lang-key="langEN">English</option><option value="zh" data-lang-key="langZH">中文 (Chino)</option><option value="de" data-lang-key="langDE">Deutsch (Alemán)</option><option value="fr" data-lang-key="langFR">Français (Francés)</option><option value="pt" data-lang-key="langPT">Português (Brasil)</option></select></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="accessibilitySettingsTitle">Accesibilidad</h3><div class="toggle-switch"><p data-lang-key="largeTextToggle">Texto más grande</p><label for="font-size-toggle" class="switch" aria-label="Activar texto más grande"><input type="checkbox" id="font-size-toggle" role="switch" aria-checked="false"><span class="slider"></span></label></div><div class="toggle-switch" style="margin-top: 1rem;"><p data-lang-key="contrastToggle">Modo de Alto Contraste</p><label for="contrast-toggle" class="switch" aria-label="Activar modo de alto contraste"><input type="checkbox" id="contrast-toggle" role="switch" aria-checked="false"><span class="slider"></span></label></div></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="menuBackgroundSettingsTitle">Fondo del Menú</h3><p data-lang-key="uploadBackgroundDesc">Sube una imagen o video local para usar de fondo.</p><input type="file" id="background-upload" accept="image/*,video/*" class="input-field" aria-label="Subir archivo para fondo de menú"></div><div><p data-lang-key="pasteUrlBackgroundDesc">O pega un enlace URL.</p><form id="background-url-form" class="input-group"><label for="background-url-input" class="sr-only">URL para fondo de menú</label><input type="url" id="background-url-input" class="input-field" placeholder="https://ejemplo.com/imagen.jpg" aria-label="Introduce la URL del fondo del menú"><button type="submit" class="btn" data-lang-key="applyButton">Aplicar</button></form></div><div><button id="background-reset" class="btn btn-secondary" aria-label="Quitar fondo personalizado" data-lang-key="resetBackgroundButton">Quitar fondo</button></div></div></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
    </div></main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATABASE & CONTENT ---
        const mathConcepts = { // ID for database (unique, simple)
            Algebra: { 
                nameKey: "algebraName", 
                topicKey: "math", 
                descriptionKey: "algebraDesc", 
                howToKey: "algebraHowTo", 
                typesKey: "algebraTypes", 
                errorsKey: "algebraErrors",
                image: "https://images.unsplash.com/photo-1635070049444-96429a3928a3?w=300&h=150&fit=crop&q=80"
            },
            Geometria: { 
                nameKey: "geometriaName", 
                topicKey: "math", 
                descriptionKey: "geometriaDesc", 
                howToKey: "geometriaHowTo", 
                typesKey: "geometriaTypes", 
                errorsKey: "geometriaErrors",
                image: "https://images.unsplash.com/photo-1558285547-483586a146b9?w=300&h=150&fit=crop&q=80"
            },
            Trigonometria: { 
                nameKey: "trigonometriaName", 
                topicKey: "math", 
                descriptionKey: "trigonometriaDesc", 
                howToKey: "trigonometriaHowTo", 
                typesKey: "trigonometriaTypes", 
                errorsKey: "trigonometriaErrors",
                image: "https://images.unsplash.com/photo-1509228627-129334a62174?w=300&h=150&fit=crop&q=80"
            },
            Funciones: { 
                nameKey: "funcionesName", 
                topicKey: "math", 
                descriptionKey: "funcionesDesc", 
                howToKey: "funcionesHowTo", 
                typesKey: "funcionesTypes", 
                errorsKey: "funcionesErrors",
                image: "https://images.unsplash.com/photo-1579705745811-a32bef7a25a3?w=300&h=150&fit=crop&q=80"
            },
            EstadisticaYProbabilidad: { 
                nameKey: "estadisticaName", 
                topicKey: "math", 
                descriptionKey: "estadisticaDesc", 
                howToKey: "estadisticaHowTo", 
                typesKey: "estadisticaTypes", 
                errorsKey: "estadisticaErrors",
                image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=300&h=150&fit=crop&q=80"
            },
            Calculo: { 
                nameKey: "calculoName", 
                topicKey: "math", 
                descriptionKey: "calculoDesc", 
                howToKey: "calculoHowTo", 
                typesKey: "calculoTypes", 
                errorsKey: "calculoErrors",
                image: "https://plus.unsplash.com/premium_photo-1677553953531-41e2472d8293?w=300&h=150&fit=crop&q=80"
            },
            OperacionesConEnteros: {
                nameKey: "operacionesConEnterosName", topicKey: "math", 
                descriptionKey: "operacionesConEnterosDesc", howToKey: "operacionesConEnterosHowTo", 
                typesKey: "operacionesConEnterosTypes", errorsKey: "operacionesConEnterosErrors",
                image: "https://images.unsplash.com/photo-1596707211993-8472f534148e?w=300&h=150&fit=crop&q=80"
            },
            FraccionesYDecimales: {
                nameKey: "fraccionesYDecimalesName", topicKey: "math",
                descriptionKey: "fraccionesYDecimalesDesc", howToKey: "fraccionesYDecimalesHowTo",
                typesKey: "fraccionesYDecimalesTypes", errorsKey: "fraccionesYDecimalesErrors",
                image: "https://images.unsplash.com/photo-1593560704563-f176a2eb61db?w=300&h=150&fit=crop&q=80"
            },
            EcuacionesCuadraticas: {
                nameKey: "ecuacionesCuadraticasName", topicKey: "math",
                descriptionKey: "ecuacionesCuadraticasDesc", howToKey: "ecuacionesCuadraticasHowTo",
                typesKey: "ecuacionesCuadraticasTypes", errorsKey: "ecuacionesCuadraticasErrors",
                image: "https://images.unsplash.com/photo-1629181197356-943df3132770?w=300&h=150&fit=crop&q=80"
            },
            Matrices: {
                nameKey: "matricesName", topicKey: "math",
                descriptionKey: "matricesDesc", howToKey: "matricesHowTo",
                typesKey: "matricesTypes", errorsKey: "matricesErrors",
                image: "https://images.unsplash.com/photo-1616432422582-824f2b115649?w=300&h=150&fit=crop&q=80"
            }
        };

        const consejosData=[{icon:"fa-brain",titleKey:"tip1Title",textKey:"tip1Text"},{icon:"fa-pencil-alt",titleKey:"tip2Title",textKey:"tip2Text"},{icon:"fa-check-circle",titleKey:"tip3Title",textKey:"tip3Text"},{icon:"fa-chalkboard-teacher",titleKey:"tip4Title",textKey:"tip4Text"},{icon:"fa-lightbulb",titleKey:"tip5Title",textKey:"tip5Text"},{icon:"fa-book",titleKey:"tip6Title",textKey:"tip6Text"},{icon:"fa-users",titleKey:"tip7Title",textKey:"tip7Text"},{icon:"fa-clock",titleKey:"tip8Title",textKey:"tip8Text"},{icon:"fa-question",titleKey:"tip9Title",textKey:"tip9Text"},{icon:"fa-chart-line",titleKey:"tip10Title",textKey:"tip10Text"},{icon:"fa-dumbbell",titleKey:"tip11Title",textKey:"tip11Text"},{icon:"fa-bed",titleKey:"tip12Title",textKey:"tip12Text"}];
        const quienesSomosText=`<p data-lang-key="quienesSomosText1">Somos un grupo de estudiantes de Educación para el Trabajo que hemos creado el proyecto “Potencia tu mente con matemáticas”, una plataforma web diseñada para apoyar el aprendizaje de las matemáticas de manera sencilla, práctica e interactiva. Nuestro objetivo es brindar a los estudiantes una herramienta accesible y motivadora que les permita reforzar sus conocimientos y superar las dificultades más comunes en esta área.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText2">Nos caracterizamos por ser un equipo responsable, creativo y comprometido con la innovación educativa. Cada integrante aporta sus ideas, habilidades y talentos, lo que nos permite trabajar de manera colaborativa y complementaria. Nos guía la convicción de que la educación es la clave para el desarrollo personal y social, y que el uso de la tecnología puede convertirse en un aliado poderoso para mejorar los procesos de enseñanza y aprendizaje.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText3">A través de este proyecto, buscamos ofrecer un servicio que no solo enseñe matemáticas, sino que también despierte en los estudiantes la confianza y el gusto por aprender. Queremos que “Potencia tu mente con matemáticas” sea un espacio digital donde cada usuario se sienta acompañado en su proceso educativo, encontrando materiales claros, niveles de práctica graduados y actividades interactivas que hagan del aprendizaje una experiencia dinámica.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText4">Creemos firmemente que nuestro esfuerzo contribuirá al desarrollo académico de los estudiantes y al fortalecimiento de sus competencias matemáticas, demostrando que con constancia, innovación y dedicación se puede transformar la manera en que aprendemos.</p>`;
        const translations={
            es:{
                mainTitle:"Potencia tu Mente",welcomeSlogan:"Tu viaje al dominio de las matemáticas comienza ahora.",enterButton:"Entrar",
                menuTitle:"Menú Principal",conceptsTitle:"Conceptos",conceptsMenuDesc:"Explora todos los temas.",practiceTitle:"Práctica",practiceMenuDesc:"Ejercicios aleatorios.",tipsTitle:"Consejos",tipsMenuDesc:"Mejora tus habilidades.",chatTitle:"Aprendamos Juntos",chatMenuDesc:"Resuelve dudas con amigos.",whoTitle:"Quiénes Somos",whoMenuDesc:"Conoce al equipo.",settingsTitle:"Ajustes",settingsMenuDesc:"Personaliza tu experiencia.",
                conceptsPageDesc:"Encuentra el tema que necesitas.",practicePageDesc:"Genera ejercicios y situaciones problemáticas.",tipsPageDesc:"Estrategias para potenciar tu aprendizaje.",
                backButton:"Regresar",usernameLabel:"Nombre de usuario", chatOverlayTitle:"Crea tu Perfil de Estudiante",chatOverlayDesc:"Elige un nombre para mostrar. Se te asignará un código único para agregar amigos.",
                saveAndEnterBtn:"Guardar y Entrar", helloText:"Hola",yourCodeIsText:"Tu código de amigo es:",friendsTitle:"Amigos",friendsDesc:"Añade amigos usando su código único.",friendCodeLabel:"Código del amigo",addFriendBtn:"+",
                selectFriendText:"Selecciona un amigo",writeMessageLabel:"Escribe un mensaje",sendButton:"Enviar",copyCodeAlert:"¡Código de amigo copiado!",
                languageSettingsTitle:"Idioma de la Interfaz", accessibilitySettingsTitle:"Accesibilidad", largeTextToggle:"Texto más grande", contrastToggle:"Modo de Alto Contraste",
                menuBackgroundSettingsTitle:"Fondo del Menú", uploadBackgroundDesc:"Sube una imagen o video local para usar de fondo.",pasteUrlBackgroundDesc:"O pega un enlace URL.",applyButton:"Aplicar",resetBackgroundButton:"Quitar fondo",
                noConceptsFoundText:"No se encontraron temas.",noPracticeFoundText:"No hay ejercicios para este tema.",conceptNotFoundText:"Concepto no encontrado.",noPracticeForTopicText:"No se pudo generar un problema único para este tema.",
                exerciseText:"Ejercicio",problemText:"Situación Problemática",yourAnswerText:"Tu respuesta",typeYourAnswerPlaceholder:"Escribe tu respuesta...",checkAnswerButton:"Comprobar",
                correctAnswerText:"¡Correcto!",incorrectAnswerText:"Incorrecto. La respuesta era",solveTogetherButton:"Resolvamoslo Juntos",selectFriendShareProblemAlert:"Selecciona un amigo para compartirle el problema.",
                deleteFriendAriaLabel:"Eliminar amigo",confirmDeleteFriendText:"¿Seguro que quieres eliminar a este amigo?",confirmDeleteMessageText:"¿Seguro que quieres eliminar este mensaje?",
                youText: "Tú", statusOnline: "Conectado", statusOffline: "Desconectado",
                descriptionTitle:"Descripción", howToTitle:"¿Cómo se resuelve?", typesTitle:"Tipos Comunes", errorsTitle:"Errores Frecuentes", practiceButton:"Practiquemos", startButton:"Comenzar",
                // Concept specific
                algebraName:"Álgebra",math:"Matemáticas",algebraDesc:"El álgebra es la rama de las matemáticas que estudia las estructuras y reglas de operaciones usando símbolos (como letras) para representar valores desconocidos. Es la ciencia de las ecuaciones y expresiones.",algebraHowTo:"Se busca despejar la incógnita (como 'x'). Los términos se mueven entre los lados de una igualdad invirtiendo su operación (suma a resta, multiplicación a división) para aislar la variable.",algebraTypes:"Elemental (ecuaciones lineales), Lineal (vectores, matrices), Abstracta (grupos, anillos).",algebraErrors:"Distribuir mal un signo negativo, no respetar la jerarquía de operaciones, fallos en leyes de exponentes (ej. (a+b)² ≠ a²+b²).",
                geometriaName:"Geometría",geometriaDesc:"Es la rama que estudia las propiedades del espacio, como puntos, líneas, figuras y sólidos.",geometriaHowTo:"Se aplica mediante el uso de teoremas y fórmulas para calcular propiedades como área, perímetro, volumen y ángulos. La visualización es clave.",geometriaTypes:"Plana (2D), del Espacio (3D), Analítica (con coordenadas).",geometriaErrors:"Confundir la fórmula del perímetro con la del área, errores de unidades (cm vs m), olvidar pasos (como el ½ en el área del triángulo).",
                trigonometriaName:"Trigonometría",trigonometriaDesc:"Estudia las relaciones entre los ángulos y los lados de los triángulos, basándose en las razones trigonométricas (seno, coseno, tangente).",trigonometriaHowTo:"Se identifican los catetos (opuesto, adyacente) y la hipotenusa en un triángulo rectángulo para aplicar las razones y resolver por ángulos o lados desconocidos.",trigonometriaTypes:"Plana, Esférica, funciones inversas (arcoseno).",trigonometriaErrors:"Identificar incorrectamente el cateto opuesto y adyacente, confundir grados con radianes.",
                funcionesName:"Funciones",funcionesDesc:"Una función es una regla que asocia a cada valor de entrada (x) un único valor de salida (y). Se escribe como y = f(x).",funcionesHowTo:"Se evalúa la función sustituyendo la variable 'x' por un número para encontrar 'y'. Se analizan su dominio y rango.",funcionesTypes:"Lineales, cuadráticas, exponenciales, logarítmicas.",funcionesErrors:"Confundir dominio y rango, no pasar la 'prueba de la línea vertical'.",
                estadisticaName:"Estadística y Probabilidad",estadisticaDesc:"La estadística recolecta, analiza e interpreta datos. La probabilidad mide la certeza de que ocurra un evento.",estadisticaHowTo:"La estadística usa medidas como media, mediana y moda. La probabilidad se calcula como (casos favorables) / (casos totales).",estadisticaTypes:"Descriptiva, Inferencial. Probabilidad Clásica, Frecuencial.",estadisticaErrors:"Confundir correlación con causalidad, confundir media con mediana.",
                calculoName:"Cálculo",calculoDesc:"Rama que estudia el cambio continuo. La derivada mide la tasa de cambio instantánea y la integral calcula acumulados.",calculoHowTo:"Se aplican reglas de derivación e integración para encontrar la pendiente de una curva o el área bajo ella.",calculoTypes:"Diferencial (derivadas) e Integral (integrales).",calculoErrors:"Dificultad con el concepto de límite, confundir las reglas de derivación, olvidar la constante de integración.",
                operacionesConEnterosName: "Operaciones con Enteros", operacionesConEnterosDesc: "Aprende a sumar, restar, multiplicar y dividir números positivos y negativos, un pilar fundamental de la matemática.", operacionesConEnterosHowTo: "Se utiliza la regla de los signos. Para sumas y restas, signos iguales se suman y mantienen el signo; signos diferentes se restan y se usa el signo del mayor. Para multiplicación y división, signos iguales dan positivo (+), signos diferentes dan negativo (-).", operacionesConEnterosTypes: "Suma, resta, multiplicación, división y potencias.", operacionesConEnterosErrors: "Olvidar la regla de los signos, especialmente al restar un número negativo (ej. 5 - (-3) = 8).",
                fraccionesYDecimalesName: "Fracciones y Decimales", fraccionesYDecimalesDesc: "Representan partes de un todo. Es clave para entender proporciones y porcentajes.", fraccionesYDecimalesHowTo: "Para sumar o restar fracciones, deben tener un denominador común. La multiplicación es directa (numerador por numerador). Para dividir, se multiplica en cruz.", fraccionesYDecimalesTypes: "Propias, impropias, mixtas. Decimales exactos y periódicos.", fraccionesYDecimalesErrors: "Sumar o restar sin encontrar el denominador común. Confundir la multiplicación con la suma.",
                ecuacionesCuadraticasName: "Ecuaciones Cuadráticas", ecuacionesCuadraticasDesc: "Ecuaciones donde la incógnita está elevada al cuadrado. Pueden tener hasta dos soluciones.", ecuacionesCuadraticasHowTo: "Se resuelven usando la fórmula general (la resolvente) o factorizando la expresión.", ecuacionesCuadraticasTypes:"Completas (ax² + bx + c = 0) e incompletas.", ecuacionesCuadraticasErrors:"Calcular mal el discriminante (b² - 4ac) en la fórmula general.",
                matricesName: "Matrices", matricesDesc: "Las matrices son arreglos rectangulares de números. Se usan para representar sistemas de ecuaciones lineales y transformaciones geométricas.", matricesHowTo: "Se operan con sumas, restas, multiplicación por escalar y multiplicación entre matrices, siguiendo reglas específicas de dimensiones.", matricesTypes: "Fila, columna, nula, cuadrada, identidad, transpuesta.", matricesErrors: "Intentar sumar/restar matrices de diferente dimensión; multiplicar matrices con dimensiones incompatibles.",
                // Environmental phrases
                waterConsumptionProblem: "Una comunidad de [CONSUMO] personas redujo su consumo de agua en un [REDUCCION]% durante [DIAS] días. Si antes cada persona usaba 100L/día, ¿cuántos litros ahorraron en total?",
                plasticWasteProblem: "[FAMILIAS] familias producen [PLASTICO] kg de plástico/semana. Si [RECICLA]% es reciclado, ¿cuánto plástico se recicla en [SEMANAS] semanas?",
                deforestationProblem: "[ARBOLES] árboles fueron deforestados en un área de [HECTAREAS] hectáreas. ¿Cuántos árboles hay por hectárea? (redondea a 2 decimales)",
                // Practice generic problem text elements
                searchConceptPlaceholder: "Buscar tema...", searchPracticePlaceholder: "Buscar tema de práctica...", usernamePlaceholder: "TuUsuario123", friendCodePlaceholder: "Código del amigo...", typeYourAnswerPlaceholder: "Escribe tu respuesta...",
                searchConceptLabel: "Introduce el nombre de un concepto para buscar", searchPracticeLabel: "Introduce el nombre de un concepto para practicar",
                // Practice specific phrases
                solveXText: "Resuelve para x", calculateText: "Calcula", perimeterText: "perímetro", squareText: "cuadrado",
                areaRectText: "Calcula el área de un rectángulo con lados de [LADO1] u y [LADO2] u.", perimSquareText: "El perímetro de un cuadrado de lado [LADO] u es.",
                sineCalculationText: "Calcula el seno de [ANGULO] grados (con 2 decimales).", tanCalculationText: "Calcula la tangente de [ANGULO] grados (con 2 decimales).",
                ifFxText: "Si f(x) = [VAR]x + [N2]", calcFxText: "calcula f([N3])", isConstOrLinearText: "¿Es f(x) = [N1] una función constante o lineal?",
                constantText: "constante",
                probabilityCoinsText: "Lanzas [MONEDAS] monedas al aire. ¿Cuál es la probabilidad de que todas salgan cara? (Decimal, 4 decimales)",
                avgDailyTempText: "Las temperaturas de 3 días fueron [D1]°C, [D2]°C y [D3]°C. ¿Cuál fue la temperatura promedio? (Decimal, 2 decimales)",
                derivativeOfX2Text: "Si y = x², ¿cuál es su derivada?", integralOf1Text: "La integral de 1 es...",
                solveQuadraticEquationText: "Resuelve: x² + [C1]x + [C2] = 0 (dame la solución más pequeña, redondeada a 2 decimales).",
                sumMatrixText: "Suma la matriz [[a, b], [c, d]] con [[1, 0], [0, 1]].", // [a,b,c,d] passed to replac
                // Placeholder texts specific for translation keys in problem generation (like [VAR] or [LADO1])
                // Add more here if they appear in dynamic problem strings and need translation.
                // Examples if the 'genProblem' function builds strings with specific markers.
            },
            en:{ // English translations
                mainTitle:"Power Up Your Mind",welcomeSlogan:"Your journey to math mastery starts now.",enterButton:"Enter",
                menuTitle:"Main Menu",conceptsTitle:"Concepts",conceptsMenuDesc:"Explore all topics.",practiceTitle:"Practice",practiceMenuDesc:"Generate random exercises.",tipsTitle:"Tips",tipsMenuDesc:"Improve your skills.",chatTitle:"Let's Learn Together",chatMenuDesc:"Solve doubts with friends.",whoTitle:"Who We Are",whoMenuDesc:"Meet the team.",settingsTitle:"Settings",settingsMenuDesc:"Personalize your experience.",
                conceptsPageDesc:"Find the topic you need.",practicePageDesc:"Generate exercises and problem situations.",tipsPageDesc:"Strategies to boost your learning.",
                backButton:"Back",usernameLabel:"Username",chatOverlayTitle:"Create Your Student Profile",chatOverlayDesc:"Choose a display name. You will be assigned a unique code to add friends.",
                saveAndEnterBtn:"Save & Enter",helloText:"Hello",yourCodeIsText:"Your friend code is:",friendsTitle:"Friends",friendsDesc:"Add friends using their unique code.",friendCodeLabel:"Friend code",addFriendBtn:"+",
                selectFriendText:"Select a friend",writeMessageLabel:"Write a message",sendButton:"Send",copyCodeAlert:"Friend code copied!",
                languageSettingsTitle:"Interface Language",accessibilitySettingsTitle:"Accessibility",largeTextToggle:"Larger Text",contrastToggle:"High Contrast Mode",
                menuBackgroundSettingsTitle:"Menu Background",uploadBackgroundDesc:"Upload a local image or video to use as background.",pasteUrlBackgroundDesc:"Or paste a URL link.",applyButton:"Apply",resetBackgroundButton:"Remove background",
                noConceptsFoundText:"No concepts found.",noPracticeFoundText:"No exercises found for this topic.",conceptNotFoundText:"Concept not found.",noPracticeForTopicText:"Could not generate a unique problem for this topic.",
                exerciseText:"Exercise",problemText:"Problem Situation",yourAnswerText:"Your answer",typeYourAnswerPlaceholder:"Type your answer...",checkAnswerButton:"Check",
                correctAnswerText:"Correct!",incorrectAnswerText:"Incorrect. The answer was",solveTogetherButton:"Let's Solve Together",selectFriendShareProblemAlert:"Select a friend to share the problem with.",
                deleteFriendAriaLabel:"Delete friend",confirmDeleteFriendText:"Are you sure you want to delete this friend?",confirmDeleteMessageText:"Are you sure you want to delete this message?",
                youText: "You", statusOnline: "Online", statusOffline: "Offline",
                descriptionTitle:"Description", howToTitle:"How to Solve?", typesTitle:"Common Types", errorsTitle:"Frequent Errors", practiceButton:"Practice Now", startButton:"Start",
                // Concept specific translations (e.g., algebraName -> Algebra)
                algebraName:"Algebra", math:"Mathematics", algebraDesc:"Algebra studies structures and rules using symbols to represent unknown values. It is the science of equations and expressions.", algebraHowTo:"The goal is to isolate the unknown (like 'x') by moving terms across an equality, inverting operations (addition to subtraction, multiplication to division).", algebraTypes:"Elementary (linear equations), Linear (vectors, matrices), Abstract (groups).", algebraErrors:"Incorrectly distributing a negative sign, not respecting the order of operations, exponent law mistakes (e.g. (a+b)² ≠ a²+b²).",
                geometriaName:"Geometry", geometriaDesc:"It is the branch that studies the properties of space, such as points, lines, figures, and solids.", geometriaHowTo:"It is applied through the use of theorems and formulas to calculate properties like area, perimeter, volume, and angles. Visualization is key.", geometriaTypes:"Plane (2D), Space (3D), Analytical (with coordinates).", geometriaErrors:"Confusing the perimeter formula with the area formula, unit errors (cm vs m), forgetting steps (like ½ in the area of a triangle).",
                trigonometriaName:"Trigonometry", trigonometriaDesc:"Studies the relationships between angles and sides of triangles, based on trigonometric ratios (sine, cosine, tangent).", trigonometriaHowTo:"Identify the opposite and adjacent legs and the hypotenuse in a right triangle to apply the ratios and solve for unknown angles or sides.", trigonometriaTypes:"Plane, Spherical, inverse functions (arcsin).", trigonometriaErrors:"Incorrectly identifying the opposite and adjacent legs, confusing degrees with radians.",
                funcionesName:"Functions", funcionesDesc:"A function is a rule that associates each input (x) with a single output (y). It is written as y = f(x).", funcionesHowTo:"The function is evaluated by substituting the variable 'x' with a given number to find 'y'. Its domain and range are also analyzed.", funcionesTypes:"Linear, quadratic, exponential, logarithmic.", funcionesErrors:"Confusing domain and range, failing the 'vertical line test'.",
                estadisticaName:"Statistics & Probability", estadisticaDesc:"Statistics collects, analyzes, and interprets data. Probability measures the certainty of an event occurring.", estadisticaHowTo:"Statistics uses measures like mean, median, and mode. Probability is calculated as (favorable cases) / (total cases).", estadisticaTypes:"Descriptive, Inferential. Classical, Frequential, Conditional Probability.", estadisticaErrors:"Confusing correlation with causation, confusing mean with median.",
                calculoName:"Calculus", calculoDesc:"Branch that studies continuous change. The derivative measures the instantaneous rate of change and the integral calculates accumulated values.", calculoHowTo:"Apply differentiation and integration rules to find the slope of a curve or the area under it.", calculoTypes:"Differential (derivatives) and Integral (integrals).", calculoErrors:"Difficulty with the concept of limit, confusing differentiation rules, forgetting the constant of integration.",
                operacionesConEnterosName: "Operations with Integers", operacionesConEnterosDesc: "Learn to add, subtract, multiply, and divide positive and negative numbers, a fundamental pillar of mathematics.", operacionesConEnterosHowTo: "Use the rule of signs: same signs yield positive (+), different signs yield negative (-). For sums, same signs are added, different signs are subtracted with the sign of the larger number. For multiplication and division, same signs yield positive (+), different signs yield negative (-).", operacionesConEnterosTypes: "Addition, subtraction, multiplication, division, and powers.", operacionesConEnterosErrors: "Forgetting the rule of signs, especially when subtracting a negative number (e.g. 5 - (-3) = 8).",
                fraccionesYDecimalesName: "Fractions and Decimals", fraccionesYDecimalesDesc: "Represent parts of a whole. Key to understanding proportions and percentages.", fraccionesYDecimalesHowTo: "To add or subtract fractions, find a common denominator. Multiplication is direct (numerator by numerator). For division, cross-multiply.", fraccionesYDecimalesTypes: "Proper, improper, mixed. Exact and periodic decimals.", fraccionesYDecimalesErrors: "Adding or subtracting without finding the common denominator. Confusing multiplication with addition.",
                ecuacionesCuadraticasName: "Quadratic Equations", ecuacionesCuadraticasDesc: "Equations where the unknown is squared. They can have up to two solutions.", ecuacionesCuadraticasHowTo: "They are solved using the general formula (quadratic formula) or by factoring the expression.", ecuacionesCuadraticasTypes:"Complete (ax² + bx + c = 0) and incomplete.", ecuacionesCuadraticasErrors:"Incorrectly calculating the discriminant (b² - 4ac) in the general formula.",
                matricesName: "Matrices", matricesDesc: "Matrices are rectangular arrays of numbers. They are used to represent systems of linear equations and geometric transformations.", matricesHowTo: "They are operated with additions, subtractions, scalar multiplication, and matrix multiplication, following specific dimension rules.", matricesTypes: "Row, column, null, square, identity, transpose.", matricesErrors: "Attempting to add/subtract matrices of different dimensions; multiplying matrices with incompatible dimensions.",
                // Practice specific phrases (Placeholders are also translated)
                solveXText: "Solve for x", calculateText: "Calculate", perimeterText: "perimeter", squareText: "square", units: "units", unitsSquared: "units²",
                areaRectText: "Calculate the area of a rectangle with sides of [LADO1] units and [LADO2] units.", perimSquareText: "The perimeter of a square with side [LADO] units is.",
                sineCalculationText: "Calculate the sine of [ANGULO] degrees (to 2 decimal places).", tanCalculationText: "Calculate the tangent of [ANGULO] degrees (to 2 decimal places).",
                ifFxText: "If f(x) = [VAR]x + [N2]", calcFxText: "calculate f([N3])", isConstOrLinearText: "Is f(x) = [N1] a constant or linear function?",
                constantText: "constant",
                probabilityCoinsText: "You toss [MONEDAS] coins. What is the probability that all land heads? (Decimal, 4 decimal places)",
                avgDailyTempText: "Daily temperatures were [D1]°C, [D2]°C, and [D3]°C. What was the average temperature? (Decimal, 2 decimal places)",
                derivativeOfX2Text: "If y = x², what is its derivative?", integralOf1Text: "The integral of 1 is...",
                solveQuadraticEquationText: "Solve: x² + [C1]x + [C2] = 0 (give the smallest solution, rounded to 2 decimal places).",
                sumMatrixText: "Add matrix A=[[${n1}, ${n2}],[${n3}, ${n4}]] with matrix B=[[1,0],[0,1]].",
                // Environmental phrases - now dynamic values
                waterConsumptionProblem: "A community of [CONSUMO] people reduced water use by [REDUCCION]% for [DIAS] days. If each person used 100L/day, how many liters were saved in total?",
                plasticWasteProblem: "[FAMILIAS] families produce [PLASTICO] kg plastic/week. If [RECICLA]% is recycled, how much plastic is recycled in [SEMANAS] weeks?",
                deforestationProblem: "[ARBOLES] trees deforested over [HECTAREAS] hectares. How many trees per hectare? (round to 2 decimals)",
                defineTextForTopic: "Define the key concept of", reviewConceptsText: "Review the concepts section.", noSpecificProblemsText: "No specific problems generated for this topic."
            },
            zh: { // Simplified Chinese translations
                mainTitle:" Potencia Tu Mente",welcomeSlogan:"你的数学学习之旅现在开始。",enterButton:"进入",menuTitle:"主菜单",conceptsTitle:"概念",conceptsMenuDesc:"探索所有主题。",practiceTitle:"练习",practiceMenuDesc:"随机练习。",tipsTitle:"技巧",tipsMenuDesc:"提高你的技能。",chatTitle:"一起学习",chatMenuDesc:"与朋友解决问题。",whoTitle:"关于我们",whoMenuDesc:"认识团队。",settingsTitle:"设置",settingsMenuDesc:"自定义你的体验。",
                conceptsPageDesc:"找到你需要的主题。",practicePageDesc:"生成练习和情景问题。",tipsPageDesc:"提高学习效率的策略。",
                backButton:"返回",usernameLabel:"用户名", chatOverlayTitle:"创建你的学生档案",chatOverlayDesc:"选择一个显示名称。你将获得一个独特的代码来添加朋友。",saveAndEnterBtn:"保存并进入",helloText:"你好",yourCodeIsText:"你的朋友代码是：",friendsTitle:"朋友",friendsDesc:"使用他们的独特代码添加朋友。",friendCodeLabel:"朋友代码",addFriendBtn:"+",
                selectFriendText:"选择一位朋友",writeMessageLabel:"写消息",sendButton:"发送",copyCodeAlert:"朋友代码已复制！",
                languageSettingsTitle:"界面语言",accessibilitySettingsTitle:"无障碍",largeTextToggle:"更大字体",contrastToggle:"高对比模式",
                menuBackgroundSettingsTitle:"菜单背景",uploadBackgroundDesc:"上传本地图片或视频作为背景。",pasteUrlBackgroundDesc:"或粘贴URL链接。",applyButton:"应用",resetBackgroundButton:"移除背景",
                noConceptsFoundText:"未找到概念。",noPracticeFoundText:"此主题无练习。",conceptNotFoundText:"未找到概念。",noPracticeForTopicText:"未能为此主题生成独特问题。",
                exerciseText:"练习",problemText:"情境问题",yourAnswerText:"你的答案",typeYourAnswerPlaceholder:"输入你的答案...",checkAnswerButton:"检查",
                correctAnswerText:"正确！",incorrectAnswerText:"不正确。答案是",solveTogetherButton:"一起解决",selectFriendShareProblemAlert:"选择一位朋友分享问题。",
                deleteFriendAriaLabel:"删除朋友",confirmDeleteFriendText:"你确定要删除这个朋友吗？",confirmDeleteMessageText:"你确定要删除这条消息吗？",
                youText: "你", statusOnline: "在线", statusOffline: "离线",
                descriptionTitle:"描述", howToTitle:"如何解决？", typesTitle:"常见类型", errorsTitle:"常见错误", practiceButton:"开始练习", startButton:"开始",
                algebraName:"代数",math:"数学",algebraDesc:"代数是数学的一个分支，它使用符号（如字母）来表示未知值，研究抽象结构和运算规则。",algebraHowTo:"通过在等式两边进行反向运算（加法变为减法，乘法变为除法）来隔离未知数（如“x”）。",algebraTypes:"初等代数（线性方程）、线性代数（向量、矩阵）、抽象代数（群）。",algebraErrors:"错误分配负号，不尊重运算顺序，指数定律错误。",
                geometriaName:"几何",geometriaDesc:"几何学是研究空间属性和关系的数学分支，包括点、线、图形和实体。",geometriaHowTo:"通过使用定理和公式计算面积、周长、体积和角度等属性。可视化是关键。",geometriaTypes:"平面几何（2D）、空间几何（3D）、解析几何（带坐标）。",geometriaErrors:"混淆周长和面积公式，单位错误，遗忘步骤（例如三角形面积的½）。",
                trigonometriaName:"三角函数",trigonometriaDesc:"研究三角形（特别是直角三角形）角度和边之间关系的数学分支。",trigonometriaHowTo:"在直角三角形中识别对边、邻边和斜边，应用三角函数解决未知角或边。",trigonometriaTypes:"平面三角学、球面三角学、反函数（反正弦）。",trigonometriaErrors:"错误识别对边和邻边，混淆角度和弧度。",
                funcionesName:"函数",funcionesDesc:"函数是一种规则，将每个输入（x）值关联到一个唯一的输出（y）值。",funcionesHowTo:"通过将变量'x'替换为给定数字来计算函数值'y'。还分析其定义域和值域。",funcionesTypes:"线性、二次、指数、对数、三角。",funcionesErrors:"混淆定义域和值域，不通过'垂直线测试'。",
                estadisticaName:"统计与概率",estadisticaDesc:"统计学收集、分析和解释数据。概率衡量事件发生的确定性。",estadisticaHowTo:"统计学使用平均值、中位数和众数等度量来描述数据。概率计算为（有利情况）/（总情况）。",estadisticaTypes:"描述性、推论性。经典概率、频率概率、条件概率。",estadisticaErrors:"混淆相关性与因果关系，混淆平均值与中位数。",
                calculoName:"微积分",calculoDesc:"研究连续变化的数学分支。导数测量瞬时变化率，积分计算累积量。",calculoHowTo:"应用导数和积分规则来找到曲线的斜率或其下面的面积。",calculoTypes:"微分（导数）和积分（积分）。",calculoErrors:"难以理解极限概念，混淆导数规则，忘记积分常数。",
                operacionesConEnterosName:"整数运算",operacionesConEnterosDesc:"学习加、减、乘、除正数和负数，这是数学的基本支柱。",operacionesConEnterosHowTo:"使用符号规则。对于加减法，相同符号相加并保持符号；不同符号相减并使用较大数的符号。对于乘除法，相同符号得到正数（+），不同符号得到负数（-）。",operacionesConEnterosTypes:"加法、减法、乘法、除法和幂。",operacionesConEnterosErrors:"忘记负数相减时的符号变化（例如 5 - (-3) = 8）。",
                fraccionesYDecimalesName:"分数和小数",fraccionesYDecimalesDesc:"表示整体的一部分。理解比例和百分比的关键。",fraccionesYDecimalesHowTo:"对于加减法，找到公分母。乘法是直接的（分子乘分子）。对于除法，交叉相乘。",fraccionesYDecimalesTypes:"真分数、假分数、带分数。精确小数和循环小数。",fraccionesYDecimalesErrors:"加减时不找公分母。混淆乘法和加法。",
                ecuacionesCuadraticasName:"二次方程",ecuacionesCuadraticasDesc:"未知数平方的方程。最多可以有两个解。",ecuacionesCuadraticasHowTo:"使用通用公式（二次公式）或分解表达式求解。",ecuacionesCuadraticasTypes:"完全式（ax² + bx + c = 0）和不完全式。",ecuacionesCuadraticasErrors:"通用公式中判别式（b² - 4ac）计算错误。",
                matricesName:"矩阵",matricesDesc:"矩阵是数字的矩形排列。它们用于表示线性方程组和几何变换。",matricesHowTo:"通过加法、减法、标量乘法和矩阵乘法进行运算，遵循特定的维度规则。",matricesTypes:"行、列、零、方、单位、转置。",matricesErrors:"试图添加/减去不同维度的矩阵；乘法矩阵的维度不兼容。",
            },
            de:{ // German translations
                mainTitle:"Gedankenkraft",welcomeSlogan:"Ihre Reise zur Mathematikbeherrschung beginnt jetzt.",enterButton:"Eintreten",menuTitle:"Hauptmenü",conceptsTitle:"Konzepte",practiceTitle:"Übung",tipsTitle:"Tipps",chatTitle:"Lasst uns zusammen lernen",whoTitle:"Wer wir sind",settingsTitle:"Einstellungen",conceptsPageDesc:"Finden Sie das gewünschte Thema.",practicePageDesc:"Zufällige Übungen und Problemlösungen generieren.",tipsPageDesc:"Strategien zur Verbesserung Ihres Lernens.",usernameLabel:"Benutzername",chatOverlayTitle:"Erstellen Sie Ihr Schülerprofil",chatOverlayDesc:"Wählen Sie einen Anzeigenamen. Sie erhalten einen einzigartigen Code, um Freunde hinzuzufügen.",saveAndEnterBtn:"Speichern & Eintreten",helloText:"Hallo,",yourCodeIsText:"Ihr Freundescode ist:",friendsTitle:"Freunde",friendsDesc:"Fügen Sie Freunde mit ihrem einzigartigen Code hinzu.",friendCodeLabel:"Freundescode",addFriendBtn:"+",selectFriendText:"Wählen Sie einen Freund",writeMessageLabel:"Nachricht schreiben",sendButton:"Senden",copyCodeAlert:"Freundescode kopiert!",languageSettingsTitle:"Oberflächensprache",accessibilitySettingsTitle:"Barrierefreiheit",largeTextToggle:"Größerer Text",contrastToggle:"Hoher Kontrastmodus",menuBackgroundSettingsTitle:"Menühintergrund",uploadBackgroundDesc:"Laden Sie ein lokales Bild oder Video als Hintergrund hoch.",pasteUrlBackgroundDesc:"Oder fügen Sie einen URL-Link ein.",applyButton:"Anwenden",resetBackgroundButton:"Hintergrund entfernen",noConceptsFoundText:"Keine Konzepte gefunden.",noPracticeFoundText:"Keine Übungen zu diesem Thema gefunden.",conceptNotFoundText:"Konzept nicht gefunden.",noPracticeForTopicText:"Es konnte kein eindeutiges Problem für dieses Thema generiert werden.",exerciseText:"Übung",problemText:"Problemsituation",yourAnswerText:"Ihre Antwort",typeYourAnswerPlaceholder:"Geben Sie Ihre Antwort ein...",checkAnswerButton:"Prüfen",correctAnswerText:"Korrekt!",incorrectAnswerText:"Falsch. Die Antwort war",solveTogetherButton:"Lass uns zusammen lösen",selectFriendShareProblemAlert:"Wählen Sie einen Freund aus, um das Problem zu teilen.",deleteFriendAriaLabel:"Freund löschen",confirmDeleteFriendText:"Sind Sie sicher, dass Sie diesen Freund löschen möchten?",confirmDeleteMessageText:"Sind Sie sicher, dass Sie diese Nachricht löschen möchten?",youText: "Sie", statusOnline: "Online", statusOffline: "Offline",algebraName:"Algebra",math:"Mathematik",algebraDesc:"Algebra ist der Zweig der Mathematik, der abstrakte Strukturen und Operationsregeln mithilfe von Symbolen (wie Buchstaben) zur Darstellung unbekannter Werte untersucht.",algebraHowTo:"Es geht darum, die Unbekannte (wie 'x') zu isolieren, indem Terme mit umgekehrter Operation über das Gleichheitszeichen bewegt werden (Addition zu Subtraktion, Multiplikation zu Division).",algebraTypes:"Elementar (lineare Gleichungen), Linear (Vektoren, Matrizen), Abstrakt (Gruppen).",algebraErrors:"Negativzeichen falsch verteilen, Operatorenreihenfolge nicht beachten, Exponentenregelfehler.",
            },
            fr: { /* French translations */ }, pt: { /* Portuguese translations */ }
        };
        
        // --- STATE, UI, SOCKET ---
        const state = { myUsername: localStorage.getItem('myUsername'), myCode: localStorage.getItem('myCode'), friends: JSON.parse(localStorage.getItem('myFriends')) || [], activeChat: null, messages: JSON.parse(localStorage.getItem('myMessages')) || {}, onlineFriends: [] };
        const ui = { 
            main: document.querySelector('main'), inicio: document.getElementById('view-inicio'), sections: document.querySelectorAll('.page-section'),
            navLinks: document.querySelectorAll('.nav-link'), backButtons: document.querySelectorAll('.btn-back'), 
            chat: { overlay: document.getElementById('username-overlay'), form: document.getElementById('username-form'), input: document.getElementById('username-input'), yourUsername: document.getElementById('your-username'), yourCode: document.getElementById('your-code'), addForm: document.getElementById('add-friend-form'), friendInput: document.getElementById('friend-code-input'), list: document.getElementById('friends-list'), header: document.getElementById('chat-header'), messages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('chat-form').querySelector('button') }, 
            concepts: { grid: document.getElementById('concepts-grid'), search: document.getElementById('concept-search'), suggestions: document.getElementById('concept-suggestions'), detail: document.getElementById('concept-detail-container') }, 
            practice: { header: document.getElementById('practice-header'), grid: document.getElementById('practice-grid'), search: document.getElementById('practice-search'), suggestions: document.getElementById('practice-suggestions') }, 
            consejos: { container: document.getElementById('consejos-container') }, 
            quienes: { container: document.getElementById('quienes-somos-container') }, 
            ajustes: { lang: document.getElementById('language-selector'), bgUpload: document.getElementById('background-upload'), bgUrlForm: document.getElementById('background-url-form'), bgUrlInput: document.getElementById('background-url-input'), bgReset: document.getElementById('background-reset'),
                fontSizeToggle: document.getElementById('font-size-toggle'), contrastToggle: document.getElementById('contrast-toggle') }
        };
        const socket = io();

        // --- UTILITIES ---
        function getTranslatedText(key, lang = localStorage.getItem('appLanguage') || 'es') {
            const langPack = translations[lang] || translations.es;
            return langPack[key] !== undefined ? langPack[key] : translations.es[key] || key; 
        }

        // --- APP LOGIC ---
        function setupApp() {
            setupNavigation();
            setupChat();
            setupConcepts();
            setupPractice();
            setupConsejos();
            setupSettings();
            renderStaticContent();
            showInitialView(); // Called after all setups are complete
        }

        // --- NAVIGATION ---
        function setupNavigation(){
            ui.navLinks.forEach(link=>link.addEventListener('click',handleNav));
            ui.backButtons.forEach(btn=>btn.addEventListener('click',()=>history.back()));
            window.addEventListener('popstate',()=>showView(location.hash,history.state));
        }
        function handleNav(e){e.preventDefault();const href=e.currentTarget.getAttribute('href');history.pushState({},'',href);sessionStorage.setItem('visitedBefore','true');showView(href);}
        
        function showView(hash,data){
            let viewId = hash ? hash.substring(1) : (sessionStorage.getItem('visitedBefore') ? 'view-menu' : 'view-inicio');
            
            // Set base styles before manipulating sections
            document.body.style.overflow = viewId === 'view-inicio' ? 'hidden' : 'auto';
            ui.main.style.display = viewId === 'view-inicio' ? 'none' : 'block';
            ui.inicio.style.display = viewId === 'view-inicio' ? 'flex' : 'none';
            
            ui.sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(viewId);
            if (activeSection) { activeSection.classList.add('active'); } else { document.getElementById('view-menu').classList.add('active'); viewId='view-menu'; } 
            
            // Re-apply translations for dynamic content and new views
            applyTranslations(localStorage.getItem('appLanguage') || 'es');

            // View-specific initialization/rendering
            if (viewId === 'view-conceptos') renderConcepts();
            if (viewId === 'view-practica') {
                if (data?.topicId) { // Direct practice for a specific topic
                    ui.practice.search.value = getTranslatedText(mathData[data.topicId]?.nameKey || "");
                } else {
                    ui.practice.search.value = "";
                }
                renderPracticeSearch(data?.topicId); 
            }
            if (viewId === 'view-concepto-detalle' && data?.topicId) renderConceptDetail(data.topicId);
            if (viewId === 'view-chat') handleChatEntry(data);
            if (viewId === 'view-ajustes') initSettingsDisplay(); // This is correctly placed

            // Hide keyboard on mobile after navigation
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }
        }
        function showInitialView(){
            // Determine initial view (splash screen vs menu)
            const initialHash = location.hash;
            if (!sessionStorage.getItem('visitedBefore') && initialHash !== '#view-menu') {
                showView('#view-inicio');
            } else {
                showView(initialHash || '#view-menu');
            }
        }

        // --- CHAT LOGIC ---
        function setupChat(){
            initUser();
            ui.chat.form.addEventListener('submit',handleUsernameRegister);
            ui.chat.yourCode.addEventListener('click',copyUserCode);
            ui.chat.addForm.addEventListener('submit',addFriend);
            ui.chat.list.addEventListener('click',handleFriendListClick);
            ui.chat.chatForm.addEventListener('submit',sendChatMessage);
            ui.chat.messages.addEventListener('click',handleMessageDelete);
            
            socket.on('private message',handleNewMessage);
            socket.on('online users update',updateOnlineFriends);
            socket.on('system message',displaySystemMessage);

            socket.on('connect', () => { 
                if (state.myUsername) { 
                    socket.emit('register user', state.myUsername, res => {
                        if (res.success) { 
                            ui.chat.yourUsername.textContent = state.myUsername; 
                            ui.chat.yourCode.textContent = state.myCode; 
                            renderFriends();
                        } else {
                             console.warn("Re-registration failed for known user:", res.message); // Log instead of alert here
                        }
                    });
                }
            });
        }

        function initUser(){
            if(state.myUsername&&state.myCode){
                ui.chat.overlay.style.display='none';
                socket.emit('register user',state.myUsername,res=>{
                    if(res.success){
                        ui.chat.yourUsername.textContent=state.myUsername;
                        ui.chat.yourCode.textContent=state.myCode;
                        renderFriends();
                    } else {
                        alert(getTranslatedText('usernameTakenAlert', res.message));
                        localStorage.clear(); 
                        state.myUsername = null;
                        state.myCode = null;
                        initUser(); 
                    }
                });
            }else{ui.chat.overlay.style.display='flex';}
        }
        function handleUsernameRegister(e){e.preventDefault();const name=ui.chat.input.value.trim();if(name.length<3)return alert(getTranslatedText('usernameMinLengthAlert'));socket.emit('register user',name,res=>{if(res.success){state.myUsername=res.username;state.myCode=res.userCode;localStorage.setItem('myUsername',state.myUsername);localStorage.setItem('myCode',state.myCode);initUser();}else{alert(getTranslatedText('usernameTakenAlert', res.message));}});}
        function copyUserCode(){navigator.clipboard.writeText(state.myCode).then(()=>alert(getTranslatedText('copyCodeAlert'))); }
        function addFriend(e){e.preventDefault();const code=ui.chat.friendInput.value.trim();if(code&&code!==state.myCode&&!state.friends.find(f=>f.code===code)){socket.emit('add friend',code,res=>{if(res.success){state.friends.push(res);localStorage.setItem('myFriends',JSON.stringify(state.friends));renderFriends();}else{alert(getTranslatedText('friendNotFoundAlert', res.message));}});}
        ui.chat.friendInput.value='';}
        function renderFriends(){
            ui.chat.list.innerHTML='';
            state.friends.forEach(f=>{
                const el=document.createElement('div');
                el.className='friend-item';
                el.dataset.code=f.code;
                el.dataset.username=f.username;
                const isOnline=state.onlineFriends.includes(f.username);
                el.innerHTML=`
                    <div class="friend-info" style="display:flex;align-items:center;gap:0.75rem;">
                        <span class="friend-status ${isOnline?'online':''}" aria-label="${isOnline ? getTranslatedText('statusOnline') : getTranslatedText('statusOffline')}"></span>
                        <span class="sr-only">${isOnline ? getTranslatedText('statusOnline') : getTranslatedText('statusOffline')}</span>
                        <span>${f.username}</span>
                    </div>
                    <button class="friend-delete" title="${getTranslatedText('deleteFriendAriaLabel')}" aria-label="${getTranslatedText('deleteFriendAriaLabel')} ${f.username}">&times;</button>
                `;
                if(f.code===state.activeChat)el.classList.add('active');
                ui.chat.list.appendChild(el);
            });
        }
        function setActiveChat(code){const friend=state.friends.find(f=>f.code===code);if(friend){state.activeChat=code;ui.chat.header.textContent=`${getTranslatedText('chatWithText')} ${friend.username}`;ui.chat.chatInput.disabled=false;ui.chat.sendBtn.disabled=false;renderFriends();renderMessages();ui.chat.chatInput.focus();}}
        function handleFriendListClick(e){const friendItem=e.target.closest('.friend-item');if(e.target.matches('.friend-delete')){const code=friendItem.dataset.code;const friendName=friendItem.dataset.username;if(confirm(`${getTranslatedText('confirmDeleteFriendText')} ${friendName}?`)){deleteFriend(code);}}else if(friendItem){setActiveChat(friendItem.dataset.code);}}
        function deleteFriend(codeToDelete) { 
            state.friends = state.friends.filter(f => f.code !== codeToDelete);
            localStorage.setItem('myFriends', JSON.stringify(state.friends));
            if (state.activeChat === codeToDelete) {
                state.activeChat = null;
                ui.chat.header.textContent = getTranslatedText('selectFriendText');
                ui.chat.chatInput.disabled = true;
                ui.chat.sendBtn.disabled = true;
            }
            renderFriends();
            renderMessages();
        }
        function sendChatMessage(e){e.preventDefault();const msgText = ui.chat.chatInput.value.trim();if(msgText&&state.activeChat){const message={id:Date.now(),text:msgText};socket.emit('private message',{toCode:state.activeChat,message});handleNewMessage(state.myUsername,message,true);}
        ui.chat.chatInput.value='';}
        function handleNewMessage(from,message,self=false){const friend=state.friends.find(f=>f.username===from);const partnerCode=self?state.activeChat:(friend?friend.code:null);if(partnerCode){if(!state.messages[partnerCode])state.messages[partnerCode]=[];state.messages[partnerCode].push({from,id:message.id,text:message.text});localStorage.setItem('myMessages',JSON.stringify(state.messages));if(partnerCode===state.activeChat)renderMessages();}}
        function updateOnlineFriends(users){state.onlineFriends=users;renderFriends();}
        function displaySystemMessage({recipient,text}){if(state.activeChat===recipient){const el=document.createElement('p');el.style.textAlign='center';el.style.color='var(--text-light)';el.textContent=text;ui.chat.messages.appendChild(el);}}
        function renderMessages(){ui.chat.messages.innerHTML='';if(state.activeChat&&state.messages[state.activeChat]){state.messages[state.activeChat].forEach(({from,id,text})=>{const bubble=document.createElement('div');bubble.className=`message-bubble ${from===state.myUsername?'sent':'received'}`;bubble.innerHTML=`<span class="sr-only">${from === state.myUsername ? getTranslatedText('youText') : from}: </span><span>${text.replace(/\n/g,'<br>')}</span>`;if(from===state.myUsername){const delBtn=document.createElement('button');delBtn.className='message-delete';delBtn.innerHTML='&times;';delBtn.dataset.id=id;delBtn.setAttribute('aria-label', getTranslatedText('deleteMessageAriaLabel'));bubble.appendChild(delBtn);}
                ui.chat.messages.appendChild(bubble);});ui.chat.messages.scrollTop=ui.chat.messages.scrollHeight;}}
        function handleMessageDelete(e){if(e.target.matches('.message-delete')){const messageId=Number(e.target.dataset.id);if(confirm(getTranslatedText('confirmDeleteMessageText'))){state.messages[state.activeChat]=state.messages[state.activeChat].filter(msg=>msg.id!==messageId);localStorage.setItem('myMessages',JSON.stringify(state.messages));renderMessages();}}}
        function handleChatEntry(data){initUser();if(data?.problem){setTimeout(()=>{alert(getTranslatedText('selectFriendShareProblemAlert'));ui.chat.chatInput.value=data.problem;history.replaceState({},'',location.pathname+location.hash);},500);}}
        
        // --- CONCEPTS LOGIC ---
        function setupConcepts(){
            ui.concepts.search.addEventListener('input',renderConcepts);
            // Fill datalist suggestions
            Object.keys(mathData).forEach(key => {
                const option = document.createElement('option');
                option.value = getTranslatedText(mathData[key].nameKey);
                ui.concepts.suggestions.appendChild(option);
            });
            renderConcepts(); // Initial render
        }
        
        function renderConcepts(){
            const term = ui.concepts.search.value.toLowerCase();
            ui.concepts.grid.innerHTML='';
            let conceptsToRender = Object.keys(mathData);

            // Filter based on search term
            const filteredKeys = conceptsToRender.filter(key => 
                getTranslatedText(mathData[key].nameKey).toLowerCase().includes(term) ||
                getTranslatedText(mathData[key].topicKey).toLowerCase().includes(term)
            );
            
            if(filteredKeys.length===0){ui.concepts.grid.innerHTML=`<p class="card" data-lang-key="noConceptsFoundText"></p>`;applyTranslations(); return;}

            // Render cards
            filteredKeys.forEach(key => {
                const item=mathData[key];
                const card=document.createElement('div'); card.className='content-card card';
                card.setAttribute('role', 'article'); 
                card.setAttribute('tabindex', '0'); 
                card.setAttribute('aria-labelledby', `concept-name-${key}`);
                card.innerHTML=`<h4 id="concept-name-${key}" data-lang-key="${item.nameKey}"></h4><p data-lang-key="${item.topicKey}Desc"></p>`;
                card.addEventListener('click',()=>{history.pushState({topicId:key},'','#view-concepto-detalle');showView('#view-concepto-detalle',{topicId:key});});
                ui.concepts.grid.appendChild(card);
            });
            applyTranslations(); // Translate newly rendered content
        }
        
        function renderConceptDetail(topicId){
            const item=mathData[topicId];
            if(!item){ui.concepts.detail.innerHTML=`<p class="card" data-lang-key="conceptNotFoundText"></p>`;applyTranslations(); return;}
            ui.concepts.detail.innerHTML=`
                <h1 class="sr-only" data-lang-key="${item.nameKey}"></h1>
                <div class="page-header">
                    <h2 id="concepto-detalle-title" data-lang-key="${item.nameKey}"></h2>
                    <p data-lang-key="${item.topicKey}Desc"></p>
                </div>
                <div class="card" role="article" aria-labelledby="concepto-detalle-title">
                    <h3 data-lang-key="descriptionTitle"></h3><p data-lang-key="${item.descriptionKey}"></p>
                    <h3 data-lang-key="howToTitle"></h3><p data-lang-key="${item.howToKey}"></p>
                    <h3 data-lang-key="typesTitle"></h3><p data-lang-key="${item.typesKey}"></p>
                    <h3 data-lang-key="errorsTitle"></h3><p data-lang-key="${item.errorsKey}"></p>
                    <button class="btn practiquemos-btn" data-topic-id="${topicId}" style="margin-top:1.5rem;" data-lang-key="practiceButton"></button>
                </div>`;
            applyTranslations(); 
            // Accessibility fix: Re-attaching event listener to a newly created button
            ui.concepts.detail.querySelector('.practiquemos-btn').addEventListener('click',e=>{
                const id=e.target.dataset.topicId;history.pushState({topicId:id},'','#view-practica');
                showView('#view-practica',{topicId:id});
            });
        }

    // --- PRACTICE LOGIC ---
    let solvedProblems = new Set(); 
    let problemSetForSession = new Set(); // Stores problems seen in current session
    function setupPractice() {
        ui.practice.search.addEventListener('input',renderPracticeSearch);
        // Fill datalist suggestions for practice search
        Object.keys(mathData).forEach(key => {
            const option = document.createElement('option');
            option.value = getTranslatedText(mathData[key].nameKey);
            ui.practice.suggestions.appendChild(option);
        });
        renderPracticeSearch(); // Initial render
    }
    
    function renderPracticeSearch(defaultTopicId=null){
        ui.practice.header.textContent=getTranslatedText('practicePageDesc');
        const term=ui.practice.search.value.toLowerCase();
        ui.practice.grid.innerHTML='';
        let keys = Object.keys(mathData);

        if(defaultTopicId && keys.includes(defaultTopicId)) { 
            keys = [defaultTopicId]; 
        } else {
            keys = keys.filter(key=>getTranslatedText(mathData[key].nameKey).toLowerCase().includes(term));
        }

        if(keys.length===0){ui.practice.grid.innerHTML=`<p class="card" data-lang-key="noPracticeFoundText"></p>`;applyTranslations(); return;}
        
        keys.forEach(key=>{
            const item=mathData[key];
            const card=document.createElement('div'); card.className='content-card card';
            card.setAttribute('role', 'article');
            card.setAttribute('tabindex', '0');
            card.setAttribute('aria-labelledby', `practice-topic-name-${key}`);
            card.innerHTML=`<h4 id="practice-topic-name-${key}" data-lang-key="${item.nameKey}"></h4><p data-lang-key="${item.topicKey}Desc"></p><button class="btn" data-topic-id="${key}" data-lang-key="startButton" aria-label="${getTranslatedText('startButton')} ${getTranslatedText(item.nameKey)}"></button>`;
            card.querySelector('button').addEventListener('click',e=>{
                const topicId=e.target.dataset.topicId;
                solvedProblems.clear(); // Reset problems for new practice session
                generatePracticeContent(topicId);
            });
            ui.practice.grid.appendChild(card);
        });
        applyTranslations(); // Apply translations
    }
    
    function generatePracticeContent(topicId){
        const item=mathData[topicId];
        ui.practice.header.textContent=`${getTranslatedText('exercisesForText')}: ${getTranslatedText(item.nameKey)}`;
        ui.practice.grid.innerHTML='';
        let sessionUsedProblems=new Set(); 

        for(let i=0;i<5;i++){ // Generate 5 problems
            const problem = genProblem(topicId, i < 3, sessionUsedProblems); // Pass Set for unique checking
            if (!problem || !problem.question || !problem.answer) { // Ensure problem is valid
                console.warn(`Could not generate valid problem for ${topicId}. Attempting fallback.`);
                problem = { typeKey: 'problemText', question: getTranslatedText('noPracticeForTopicText'), answer: 'N/A' };
            } else {
                 sessionUsedProblems.add(problem.question);
            }

            const card=document.createElement('div');card.className='problem-card card';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-labelledby', `problem-${topicId}-${i}-title`);
            card.setAttribute('tabindex', '0');
            card.innerHTML=`
                <h4 id="problem-${topicId}-${i}-title" class="sr-only">${getTranslatedText(problem.typeKey)} para ${getTranslatedText(item.nameKey)}</h4>
                <p><strong><span data-lang-key="${problem.typeKey}"></span>:</strong> ${problem.question}</p>
                <div class="response-form">
                    <label for="response-${topicId}-${i}" class="sr-only">${getTranslatedText('yourAnswerText')}</label>
                    <input type="text" id="response-${topicId}-${i}" class="input-field problem-answer" placeholder="${getTranslatedText('typeYourAnswerPlaceholder')}" aria-label="${getTranslatedText('yourAnswerText')}">
                    <button class="btn check-answer-btn" data-lang-key="checkAnswerButton" aria-label="${getTranslatedText('checkAnswerButton')}"></button>
                </div>
                <div class="feedback" role="alert" aria-live="assertive"></div>
                <button class="btn solve-together-btn" style="margin-top: 1rem;" data-lang-key="solveTogetherButton" aria-label="${getTranslatedText('solveTogetherButton')}"></button>
            `;
            ui.practice.grid.appendChild(card);
            
            card.querySelector('.check-answer-btn').addEventListener('click', e=>{
                const input=e.target.previousElementSibling;
                const feedback=e.target.parentElement.nextElementSibling;
                const userAnswer=input.value.trim().toLowerCase();
                const correctAnswer=String(problem.answer).trim().toLowerCase();
                
                if(userAnswer === correctAnswer){
                    feedback.textContent=getTranslatedText('correctAnswerText');
                    feedback.className='feedback correct';
                }else{
                    feedback.textContent=`${getTranslatedText('incorrectAnswerText')} ${correctAnswer}`;
                    feedback.className='feedback incorrect';
                }
                feedback.style.display='block';
                e.target.disabled = true; // Disable check button after one try
                input.disabled = true; // Disable input
            });
        }
        document.querySelectorAll('.solve-together-btn').forEach(btn=>btn.addEventListener('click',e=>{
            const problem=e.target.parentElement.querySelector('p').textContent; // Get the problem text
            history.pushState({problem},'',`#view-chat`); 
            showView(`#view-chat`, {problem: problem});
        }));
        applyTranslations(); // Apply translations after rendering problems
    }

    function genProblem(topicId,isExercise,usedProblems){
        let question,answer,typeKey;
        const n1=Math.floor(Math.random()*50)+1; const n2=Math.floor(Math.random()*15)+2; const n3=Math.floor(Math.random()*25)+5; 
        const n4=Math.floor(Math.random()*10)+1; const n5=Math.floor(Math.random()*7)+1; 
        
        typeKey = isExercise ? "exerciseText" : "problemText";
        
        let problemAttempt = null;
        let attemptCount = 0;
        let uniqueProblemFound = false;

        while(!uniqueProblemFound && attemptCount < 50) { // Limit attempts to find unique problem
            attemptCount++;
            let currentQuestion = '';
            let currentAnswer = '';
            
            switch (topicId) {
                case 'Algebra': 
                    if(Math.random() > 0.5){
                       currentQuestion = `${getTranslatedText('solveXText')}: ${n1}x + ${n2} = ${n1 * 3 + n2}`; currentAnswer = `3`; 
                    } else {
                       currentQuestion = `${getTranslatedText('calculateText')}: ${n1} - (${-n2}) * ${n3}.`; currentAnswer = (n1 - (-n2) * n3).toFixed(0); 
                    }
                    break;
                case 'Geometria':
                    if(Math.random() > 0.5){
                        currentQuestion = `${getTranslatedText('areaRectText', [n2,n3])}`; currentAnswer = (n2 * n3).toFixed(0);
                    } else {
                        currentQuestion = `${getTranslatedText('perimSquareText', [n2])}`; currentAnswer = (4 * n2).toFixed(0);
                    }
                    break;
                case 'Trigonometria':
                    const angle = [30,45,60][Math.floor(Math.random()*3)];
                    currentQuestion = `${getTranslatedText('sineCalculationText', [angle])}.`; currentAnswer = (Math.sin(angle * Math.PI / 180)).toFixed(2);
                    break;
                case 'Funciones':
                    if(Math.random() > 0.5){
                        currentQuestion = `${getTranslatedText('ifFxText', [n1,n2])}. ${getTranslatedText('calcFxText', [n3])}.`; currentAnswer = (n1 * n3 + n2).toFixed(0);
                    } else {
                        currentQuestion = `${getTranslatedText('isConstOrLinearText', [n1])}?`; currentAnswer = getTranslatedText('constantText');
                    }
                    break;
                case 'EstadisticaYProbabilidad':
                    if(Math.random() > 0.5){
                         currentQuestion = `${getTranslatedText('probabilityCoinsText', [n2])}`; currentAnswer = Math.pow(0.5,n2).toFixed(Math.min(n2,4));
                    } else {
                        currentQuestion = `${getTranslatedText('avgDailyTempText', [n1,n2,n3])}`; currentAnswer = ((n1+n2+n3)/3).toFixed(2);
                    }
                    break;
                case 'Calculo':
                    if(Math.random() > 0.5){
                        currentQuestion = `${getTranslatedText('derivativeOfX2Text')}`; currentAnswer = `2x`;
                    } else {
                        currentQuestion = `${getTranslatedText('integralOf1Text')}`; currentAnswer = `x+C`;
                    }
                    break;
                case 'OperacionesConEnteros':
                    currentQuestion = `${getTranslatedText('calculateText')}: ${n1} + (${n2}) * ${n3} - ${n4}.`; currentAnswer = (n1 + n2 * n3 - n4).toFixed(0);
                    break;
                case 'FraccionesYDecimales':
                    currentQuestion = `${getTranslatedText('solveText')}: ${n1}/${n2} + ${n3}/${n4} (redondea a 2 decimales).`; currentAnswer = ( (n1*n4 + n3*n2) / (n2*n4) ).toFixed(2);
                    break;
                case 'EcuacionesCuadraticas':
                    currentQuestion = `${getTranslatedText('solveQuadraticEquationText', [n1 + n2, n1 * n2])}`; // Using correct variable names from ES/translations
                    let rootVal = (n1 + n2)*(n1 + n2) - 4 * (n1*n2);
                    if (rootVal < 0) rootVal = 0; // Prevent complex numbers in basic random problems
                    let root1 = (-(n1+n2) + Math.sqrt(rootVal)) / 2;
                    let root2 = (-(n1+n2) - Math.sqrt(rootVal)) / 2;
                    currentAnswer = Math.min(root1, root2).toFixed(2); 
                    break;
                case 'Matrices':
                    currentQuestion = `${getTranslatedText('sumMatrixText', [n1,n2,n3,n4])}`; 
                    currentAnswer = `[[${n1+1},${n2}],[${n3},${n4+1}]]`; 
                    break;
                default:
                    currentQuestion = getTranslatedText('defineTextForTopic', getTranslatedText(mathConcepts[topicId]?.nameKey || topicId));
                    currentAnswer = getTranslatedText('reviewConceptsText');
            }

            // Environmental problems (if isExercise is false, these override generic ones)
            if (!isExercise) {
                switch(Math.floor(Math.random() * 3)) { // 3 types of environmental problems
                    case 0: 
                        currentQuestion = getTranslatedText('waterConsumptionProblem', [n1 * 100, n2, n3]);
                        currentAnswer = ((n1 * 100 * n2 / 100) * n3).toFixed(0);
                        break;
                    case 1: 
                        currentQuestion = getTranslatedText('plasticWasteProblem', [n1, n2, n3, n4]);
                        currentAnswer = ( (n1 * n2) * (n3 / 100) * n4 ).toFixed(0);
                        break;
                    case 2: 
                        currentQuestion = getTranslatedText('deforestationProblem', [n1 * 100, n2]);
                        currentAnswer = (n1 * 100 / n2).toFixed(2);
                        break;
                    default: 
                        currentQuestion = getTranslatedText('problemText'); currentAnswer = "N/A"; 
                        break;
                }
            }
            
            problemAttempt = { typeKey, question: currentQuestion, answer: currentAnswer };
            if (!usedProblems.has(problemAttempt.question)) {
                uniqueProblemFound = true;
            }
        } while(!uniqueProblemFound && attemptCount < 50);

        if (!uniqueProblemFound) {
             console.warn(`Could not generate unique problem for ${topicId} after ${attemptCount} attempts. Skipping.`);
             return { typeKey: 'problemText', question: getTranslatedText('noPracticeForTopicText'), answer: 'N/A' };
        }
        
        return problemAttempt;
    }
    
    // --- OTHER SECTIONS ---
    function setupConsejos(){ui.consejos.container.innerHTML = ''; consejosData.forEach(c => {const card = document.createElement('div'); card.className = 'card'; card.setAttribute('role', 'article'); card.setAttribute('aria-labelledby', `tip-title-${c.icon}`); card.setAttribute('tabindex', '0'); card.innerHTML = `<h3 id="tip-title-${c.icon}"><i class="fas ${c.icon}" aria-hidden="true" style="color:var(--primary-color); margin-right: 0.5rem;"></i><span data-lang-key="${c.titleKey}"></span></h3><p data-lang-key="${c.textKey}"></p>`; ui.consejos.container.appendChild(card);}); applyTranslations(); }
    function renderQuienesSomos(){ui.quienes.container.innerHTML = quienesSomosText; applyTranslations(); }
    
    // --- SETTINGS LOGIC ---
    function setupSettings(){
        ui.ajustes.lang.addEventListener('change',e=>{applyTranslations(e.target.value); location.reload();}); 
        ui.ajustes.bgUpload.addEventListener('change',e=>{const file=e.target.files[0];if(file)handleFileUpload(file);});
        ui.ajustes.bgUrlForm.addEventListener('submit',e=>{e.preventDefault();const url=ui.ajustes.bgUrlInput.value.trim();if(url)applyBackground(url);});
        ui.ajustes.bgReset.addEventListener('click', resetBackground);
        ui.ajustes.fontSizeToggle.addEventListener('change', e => {
            document.body.classList.toggle('large-text', e.target.checked);
            localStorage.setItem('fontSizeEnabled', e.target.checked);
            applyTranslations(); 
        });
        ui.ajustes.contrastToggle.addEventListener('change', e => {
            document.body.classList.toggle('dark-theme', e.target.checked);
            localStorage.setItem('highContrastEnabled', e.target.checked);
        });
        initSettingsDisplay(); 
    }

    function handleFileUpload(file) {
        if (!file.type.match('image.*') && !file.type.match('video.*')) {
            alert(getTranslatedText('invalidFileTypeAlert'));
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => applyBackground(e.target.result);
        reader.readAsDataURL(file);
    }

    function initSettingsDisplay(){
        ui.ajustes.lang.value = localStorage.getItem('appLanguage') || 'es';
        ui.ajustes.fontSizeToggle.checked = localStorage.getItem('fontSizeEnabled') === 'true';
        document.body.classList.toggle('large-text', ui.ajustes.fontSizeToggle.checked);
        ui.ajustes.contrastToggle.checked = localStorage.getItem('highContrastEnabled') === 'true';
        document.body.classList.toggle('dark-theme', ui.ajustes.contrastToggle.checked);

        const savedBg = localStorage.getItem('menuBackground');
        if(savedBg) applyBackground(savedBg);
    }
    
    function applyTranslations(lang = localStorage.getItem('appLanguage') || 'es'){
        const langPack = translations[lang] || translations.es;
        // Translate elements with data-lang-key
        document.querySelectorAll('[data-lang-key]').forEach(el=>{
            const key = el.dataset.langKey;
            // Input placeholders
            if (el.tagName === 'INPUT' && langPack[key + 'Placeholder']) {
                el.placeholder = langPack[key + 'Placeholder']; 
            } else if (el.tagName === 'BUTTON' && el.getAttribute('aria-label') && langPack[key]) {
                if (el.dataset.originalLabel === undefined) { el.dataset.originalLabel = el.textContent; }
                el.setAttribute('aria-label', `${langPack[key]} ${getTranslatedText(el.dataset.originalLabel)}`);
                el.textContent = langPack[key];
            } else if (el.tagName === 'A' && el.getAttribute('aria-label') && langPack[key]) { // For nav links in menu card
                if (el.dataset.originalLabel === undefined) { el.dataset.originalLabel = el.querySelector('h3').textContent; }
                el.setAttribute('aria-label', `${langPack[key]} ${getTranslatedText(el.dataset.originalLabel)}`);
            }
            // All other text content
            else if (langPack[key] !== undefined) {
                el.textContent = langPack[key];
            }
        });
        
        // Update datalists manually as they don't respond to data-lang-key
        // This is important because concepts and practice cards rely on translated names for searching
        if (ui.concepts.suggestions) { 
             ui.concepts.suggestions.innerHTML = Object.keys(mathConcepts).map(key => `<option value="${getTranslatedText(mathConcepts[key].nameKey)}"></option>`).join('');
        }
        if (ui.practice.suggestions) {
            ui.practice.suggestions.innerHTML = Object.keys(mathConcepts).map(key => `<option value="${getTranslatedText(mathConcepts[key].nameKey)}"></option>`).join('');
        }

        document.documentElement.lang = lang;
        localStorage.setItem('appLanguage', lang);
    }
    
    function applyBackground(url){
        const menuView=document.getElementById('view-menu');
        let backgroundLayer = document.getElementById('menu-background-layer');
        if (!backgroundLayer) {
            backgroundLayer = document.createElement('div');
            backgroundLayer.id = 'menu-background-layer';
            menuView.prepend(backgroundLayer);
        }
        backgroundLayer.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;';
        backgroundLayer.innerHTML = ''; // Clear existing content (video or image)

        if(url.startsWith('data:video') || url.match(/\.(mp4|webm|ogg)$/i)) { // Check for video type or extension
            const video=document.createElement('video');video.style.cssText='width:100%;height:100%;object-fit:cover;';
            video.src=url;video.autoplay=true;video.loop=true;video.muted=true;video.setAttribute('aria-hidden', 'true');
            backgroundLayer.appendChild(video);
        } else {
            backgroundLayer.style.backgroundImage=`url(${url})`;
            backgroundLayer.style.backgroundSize='cover';
            backgroundLayer.style.backgroundPosition='center';
        }
        localStorage.setItem('menuBackground', url);
    }
    function resetBackground() { localStorage.removeItem('menuBackground'); location.reload(); }

    // Utility function to get translated text (with fallback)
    function getTranslatedText(key, lang = localStorage.getItem('appLanguage') || 'es') {
        const langPack = translations[lang] || translations.es;
        // This handles cases where template string placeholders need to be filled.
        // e.g., getTranslatedText('areaRectText', [10, 5])
        if (Array.isArray(lang)) { // The second arg is an array for placeholders
            let translated = langPack[key] !== undefined ? langPack[key] : translations.es[key] || key;
            lang.forEach((placeholder, index) => {
                translated = translated.replace(`[PARAM${index+1}]`, placeholder); // Example if placeholders are [PARAM1], [PARAM2]
            });
            return translated;
        } else {
             // For regular keys, with fallback logic
            return langPack[key] !== undefined ? langPack[key] : translations.es[key] || key; 
        }
    }


    // --- INITIALIZATION ---
    function showInitialView() { 
        const initialHash = location.hash;
        if (!sessionStorage.getItem('visitedBefore') && initialHash !== '#view-menu') {
             showView('#view-inicio');
        } else {
            showView(initialHash || '#view-menu');
        }
    }
    
    function init() {
        // Particles.js for splash screen background
        if(document.getElementById('particles-js'))particlesJS('particles-js',{"particles":{"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.5,"random":false,"anim":{"enable":true,"speed":1,"opacity_min":0.1,"sync":false}},"size":{"value":3,"random":true,"anim":{"enable":false,"size_min":0.1,"sync":false}},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.4,"width":1},"move":{"enable":true,"speed":6,"direction":"none","random":false,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"},"resize":true},"modes":{"grab":{"distance":200,"line_linked":{"opacity":1}},"push":{"particles_nb":4},"repulse":{"distance":200,"duration":0.4}}}});
        
        setupApp(); // Call main setup function to initialize modules
        showInitialView(); // Determine and show the first view
    }
    init(); // Start the app!
});
</script>

    })();
    </script>

</body>
</html>