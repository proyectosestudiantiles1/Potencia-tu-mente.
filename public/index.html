<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="mainTitle">Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root{
            --primary-gradient:linear-gradient(90deg, #1abc9c, #1dd2af); /* Verde Turquesa Vibrante */
            --primary-color:#1abc9c;
            --secondary-color:#34495e; /* Azul Oscuro de Contraste */
            --bg-color:#ecf0f1; /* Fondo Gris Claro Suave */
            --card-bg:#FFFFFF; /* Blanco Puro para Tarjetas */
            --text-dark:#34495e; /* Texto Oscuro Principal */
            --text-light:#95a5a6; /* Texto Gris Claro para Notas */
            --shadow:0 10px 30px rgba(0,0,0,0.07);
            --radius:16px;
            --online-color:#2ecc71; /* Verde Online */
            --offline-color:#bdc3c7; /* Gris Offline */
            
            /* Accesibilidad - Tamaño de Fuente (Default) */
            --font-scale: 1; /* Default: 1 = 16px base */
            --font-base-size: calc(16px * var(--font-scale));
            --font-h1-size: calc(3rem * var(--font-scale));
            --font-h2-size: calc(2.5rem * var(--font-scale));
            --font-h3-size: calc(1.5rem * var(--font-scale));
            --font-h4-size: calc(1.2rem * var(--font-scale));
            --font-p-size: calc(1rem * var(--font-scale));
            --font-small-size: calc(0.9em * var(--font-scale));
            --font-button-size: calc(1rem * var(--font-scale));
        }

        /* Tema Oscuro para Accesibilidad */
        body.dark-theme{
            --primary-gradient:linear-gradient(90deg, #16a085, #007bff);
            --primary-color:#007bff;
            --secondary-color:#ecf0f1; /* Texto blanco en modo oscuro */
            --bg-color:#2c3e50; /* Fondo muy oscuro */
            --card-bg:#34495e; /* Tarjetas más oscuras */
            --text-dark:#ecf0f1;
            --text-light:#bdc3c7;
        }

        /* Aumento del tamaño base para accesibilidad */
        body.large-text { --font-scale: 1.25; /* Escala base aumentada */ }


        * { margin:0;padding:0;box-sizing:border-box }
        html{scroll-behavior:smooth}
        body{font-family:'Lato',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;transition:background-color .3s,color .3s;font-size:var(--font-base-size)}
        
        /* Main Layout */
        main{display:none}
        .page-section{display:none}
        .page-section.active{display:block;animation:fadeIn 0.5s ease-in-out forwards}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        .container{max-width:1200px;margin:0 auto;padding:2rem}
        .page-header{margin-bottom:2.5rem;text-align:center}
        .page-header h1{font-family:'Poppins',sans-serif;font-size:var(--font-h1-size);color:var(--secondary-color)}
        .page-header p{font-size:var(--font-p-size);color:var(--text-light);max-width:700px;margin:.5rem auto 0}
        
        /* Buttons */
        .btn{display:inline-block;padding:.8rem 1.8rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .2s ease,box-shadow .3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-button-size)}
        .btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(22,160,133,.4)}
        .btn-secondary{background:#95a5a6;box-shadow:0 4px 15px rgba(0,0,0,.1)}.btn-secondary:hover{background:#7f8c8d}
        .btn-back{display:block;width:fit-content;margin-top:2.5rem}

        /* Cards and Inputs */
        .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);transition:transform .3s,box-shadow .3s, background-color .3s, color .3s}.card:hover{transform:translateY(-8px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
        .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dee2e6;background-color:var(--card-bg);color:var(--text-dark);border-radius:8px;font-size:var(--font-p-size);transition:border-color .2s,box-shadow .2s}
        .input-field:focus-visible{outline:2px solid var(--primary-color);box-shadow:0 0 0 3px rgba(22,160,133,.2)}
        
        /* Vista de Inicio */
        #view-inicio{position:fixed;inset:0;display:none;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#2c3e50; /* Base de fondo más oscura para animación */ background-image:linear-gradient(-45deg, #1c2541, #3a506b, #1abc9c, #16a085); background-size: 200% 200%; animation:gradientBG 15s ease infinite;}
        @keyframes gradientBG {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
        #particles-js{position:absolute;width:100%;height:100%;z-index:-1}
        .inicio-content{animation:fadeIn 2s}.inicio-content h1{font-family:'Poppins',sans-serif;font-size:clamp(3rem, 10vw, 5.5rem);letter-spacing:2px}.inicio-content p{font-size:1.5rem;color:rgba(255,255,255,.8);margin-bottom:2rem}.inicio-content .btn{padding:1rem 3rem;font-size:1.2rem}
        
        /* Menú Principal */
        .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.menu-card{text-align:center;text-decoration:none;color:var(--text-dark);height:100%;}.menu-card .icon{font-size:3rem;color:var(--primary-color);margin-bottom:1rem;display:block}.menu-card h3{font-family:'Poppins',sans-serif}
        #view-menu{position:relative;overflow:hidden;border-radius:var(--radius);padding:2rem;background-color:var(--bg-color);transition:none}
        #menu-background-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.1;background-image:linear-gradient(45deg, #2ecc71, #1abc9c, #3498db, #2c3e50);background-size:200% 200%;animation:gradientBG 20s ease infinite;} /* Fondo animado por defecto */
        
        /* Conceptos y Práctica */
        #concept-detail-container img{display:none} .content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.5rem}.content-card{cursor:pointer} .content-card h4{font-family:'Poppins',sans-serif}
        .content-card p {font-size: var(--font-small-size);} /* Texto pequeño */
        .problem-card{margin-bottom:1.5rem}.problem-card .response-form{margin-top:1rem;display:flex;gap:.5rem}.problem-card .feedback{margin-top:.5rem;padding:.5rem;border-radius:8px;display:none;font-weight:700;font-size:var(--font-p-size)}.problem-card .feedback.correct{background-color:#d4edda;color:#155724}.problem-card .feedback.incorrect{background-color:#f8d7da;color:#721c24}
        
        /* Chat */
        .chat-layout{display:grid;grid-template-columns:320px 1fr;gap:1.5rem;height:75vh;max-height:700px}#friends-list{overflow-y:auto;flex-grow:1}
        .friend-item{padding:.8rem 1rem;border-radius:8px;cursor:pointer;margin-bottom:.5rem;display:flex;align-items:center;gap:.75rem;font-weight:500;transition:background-color .2s}.friend-item:hover,.friend-item.active{background-color:#e0e6e8}
        .friend-status{width:10px;height:10px;border-radius:50%;background-color:var(--offline-color);transition:background-color .3s}.friend-status.online{background-color:var(--online-color)}
        .friend-delete{background:none;border:none;color:var(--text-light);cursor:pointer;opacity:0;transition:opacity .2s;margin-left:auto;font-size:1.2rem}.friend-item:hover .friend-delete{opacity:1}
        .chat-window{display:flex;flex-direction:column}.chat-messages{flex-grow:1;border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;overflow-y:auto;margin-bottom:1rem;background:var(--bg-color)}
        .message-bubble{position:relative;max-width:80%;width:fit-content;padding:.7rem 1.2rem;border-radius:20px;margin-bottom:.75rem;line-height:1.5;white-space:pre-wrap;word-wrap:break-word}
        .message-bubble.sent{background:var(--primary-gradient);color:white;margin-left:auto;border-bottom-right-radius:5px}.message-bubble.received{background-color:#e9ecef;color:var(--text-dark);margin-right:auto;border-bottom-left-radius:5px}
        .message-delete{position:absolute;top:50%;transform:translateY(-50%);right:-25px;background:none;border:none;color:var(--text-light);cursor:pointer;opacity:0;transition:opacity .2s;font-size:.8em}.message-bubble.sent:hover .message-delete{opacity:1}
        #username-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}

        /* Ajustes - Controles */
        .toggle-switch{display:flex;align-items:center;justify-content:space-between;width:100%}.toggle-switch p {font-size:var(--font-p-size); margin:0;} .toggle-switch input{opacity:0;width:0;height:0}
        .slider{position:relative;cursor:pointer;width:50px;height:26px;background-color:#ccc;border-radius:26px;transition:.4s}.slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background-color:white;border-radius:50%;transition:.4s}input:checked+.slider{background-color:var(--primary-color)}input:checked+.slider:before{transform:translateX(24px)}
        
        /* Accesibilidad (Screen Reader Only) */
        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
        /* Focus styles for keyboard navigation */
        :focus-visible{outline:3px solid var(--primary-color) !important; outline-offset: 2px;}

    </style>
</head>
<body>
    <section id="view-inicio" class="page-section"><h1 class="sr-only" data-lang-key="mainTitle">Potencia tu Mente - Pantalla de Bienvenida</h1><div id="particles-js" aria-hidden="true"></div><div class="inicio-content" role="dialog" aria-labelledby="welcome-title"><h2 id="welcome-title" data-lang-key="mainTitle">Potencia tu Mente</h2><p data-lang-key="welcomeSlogan">Tu viaje al dominio de las matemáticas comienza ahora.</p><a href="#view-menu" class="btn nav-link" role="button" aria-label="Entrar al menú principal" data-lang-key="enterButton">Entrar</a></div></section>
    
    <main role="main"><header class="sr-only"><h1>Contenido Principal de Potencia tu Mente</h1></header><div class="container">
        <section id="view-menu" class="page-section card" role="region" aria-labelledby="menu-title"><div class="page-header"><h2 id="menu-title" data-lang-key="menuTitle">Menú Principal</h2></div><div class="menu-grid"><a href="#view-conceptos" class="menu-card nav-link card" role="link" aria-label="Ir a la sección Conceptos"><div class="icon" aria-hidden="true"><i class="fas fa-book-open"></i></div><h3 data-lang-key="conceptsTitle">Conceptos</h3><p data-lang-key="conceptsMenuDesc">Explora todos los temas.</p></a><a href="#view-practica" class="menu-card nav-link card" role="link" aria-label="Ir a la sección Práctica"><div class="icon" aria-hidden="true"><i class="fas fa-brain"></i></div><h3 data-lang-key="practiceTitle">Práctica</h3><p data-lang-key="practiceMenuDesc">Ejercicios aleatorios.</p></a><a href="#view-consejos" class="menu-card nav-link card" role="link" aria-label="Ir a la sección Consejos"><div class="icon" aria-hidden="true"><i class="fas fa-lightbulb"></i></div><h3 data-lang-key="tipsTitle">Consejos</h3><p data-lang-key="tipsMenuDesc">Mejora tus habilidades.</p></a><a href="#view-chat" class="menu-card nav-link card" role="link" aria-label="Ir a la sección Aprendamos Juntos (Chat)"><div class="icon" aria-hidden="true"><i class="fas fa-comments"></i></div><h3 data-lang-key="chatTitle">Aprendamos Juntos</h3><p data-lang-key="chatMenuDesc">Resuelve dudas con amigos.</p></a><a href="#view-quienes-somos" class="menu-card nav-link card" role="link" aria-label="Ir a la sección Quiénes Somos"><div class="icon" aria-hidden="true"><i class="fas fa-users"></i></div><h3 data-lang-key="whoTitle">Quiénes Somos</h3><p data-lang-key="whoMenuDesc">Conoce al equipo.</p></a><a href="#view-ajustes" class="menu-card nav-link card" role="link" aria-label="Ir a la sección Ajustes"><div class="icon" aria-hidden="true"><i class="fas fa-cog"></i></div><h3 data-lang-key="settingsTitle">Ajustes</h3><p data-lang-key="settingsMenuDesc">Personaliza tu experiencia.</p></a></div></section>
        
        <section id="view-conceptos" class="page-section" role="region" aria-labelledby="conceptos-title"><div class="page-header"><h2 id="conceptos-title" data-lang-key="conceptsTitle">Conceptos Matemáticos</h2><p data-lang-key="conceptsPageDesc">Encuentra el tema que necesitas.</p></div><div class="filter-bar" role="search"><label for="concept-search" class="sr-only">Buscar tema</label><input type="search" id="concept-search" class="input-field" placeholder="Buscar tema (ej. Álgebra, Geometría...)" list="concept-suggestions" aria-autocomplete="list" aria-controls="concept-suggestions" aria-label="Introduce el nombre de un concepto para buscar"></div><datalist id="concept-suggestions"></datalist><div id="concepts-grid" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-concepto-detalle" class="page-section" role="region" aria-labelledby="concepto-detalle-title"><div id="concept-detail-container"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-practica" class="page-section" role="region" aria-labelledby="practica-title"><div class="page-header"><h2 id="practica-title" data-lang-key="practiceTitle">Centro de Práctica</h2><p id="practice-header" data-lang-key="practicePageDesc">Genera ejercicios y situaciones problemáticas.</p></div><div class="filter-bar" role="search"><label for="practice-search" class="sr-only">Buscar tema de práctica</label><input type="search" id="practice-search" class="input-field" placeholder="Buscar tema de práctica..." list="practice-suggestions" aria-autocomplete="list" aria-controls="practice-suggestions" aria-label="Introduce el nombre de un concepto para practicar"></div><datalist id="practice-suggestions"></datalist><div id="practice-grid" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-consejos" class="page-section" role="region" aria-labelledby="consejos-title"><div class="page-header"><h2 id="consejos-title" data-lang-key="tipsTitle">Consejos para Estudiantes</h2><p data-lang-key="tipsPageDesc">Estrategias para potenciar tu aprendizaje.</p></div><div id="consejos-container" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-chat" class="page-section" role="region" aria-labelledby="chat-title"><div id="username-overlay" role="dialog" aria-modal="true" aria-labelledby="username-form-title"><div class="card" style="width:100%;max-width:400px;text-align:center;"><h3 id="username-form-title" data-lang-key="chatOverlayTitle">Crea tu Perfil de Estudiante</h3><p style="margin-bottom:1rem;" data-lang-key="chatOverlayDesc">Elige un nombre para mostrar. Se te asignará un código único para agregar amigos.</p><form id="username-form" class="input-group"><label for="username-input" class="sr-only" data-lang-key="usernameLabel">Nombre de usuario</label><input type="text" id="username-input" class="input-field" placeholder="TuUsuario123" required minlength="3" aria-describedby="username-info"><span id="username-info" class="sr-only">El nombre de usuario debe tener al menos 3 caracteres.</span><button type="submit" class="btn" data-lang-key="saveAndEnterBtn">Guardar y Entrar</button></form></div></div><div class="page-header"><h2 id="chat-title" data-lang-key="chatTitle">Aprendamos Juntos</h1></div><div class="chat-layout"><aside class="card"><p data-lang-key="helloText">Hola, <strong id="your-username" style="color:var(--primary-color);"></strong></p><p style="font-size: 0.9em; color: var(--text-light); margin-top: -5px;" data-lang-key="yourCodeIsText">Tu código de amigo es: <strong id="your-code" title="Clic para copiar" style="cursor: pointer; user-select: all;" aria-label="Tu código de amigo, haz clic para copiar"></strong></p><h3 style="margin-top:1.5rem;font-family:'Poppins';" data-lang-key="friendsTitle">Amigos</h3><p style="font-size:0.9em;color:var(--text-light);margin-bottom:1rem;" data-lang-key="friendsDesc">Añade amigos usando su código único.</p><form id="add-friend-form" class="input-group"><label for="friend-code-input" class="sr-only" data-lang-key="friendCodeLabel">Código del amigo</label><input id="friend-code-input" class="input-field" placeholder="Código del amigo..." required aria-label="Introduce el código de amigo"><button type="submit" class="btn" aria-label="Añadir amigo" data-lang-key="addFriendBtn">+</button></form><div id="friends-list" aria-live="polite"></div></aside><div class="card chat-window" role="log" aria-labelledby="chat-header-title"><h3 id="chat-header" style="font-family:'Poppins';" data-lang-key="selectFriendText">Selecciona un amigo</h3><div class="chat-messages" id="chat-messages"></div><form id="chat-form" class="input-group"><label for="chat-input" class="sr-only" data-lang-key="writeMessageLabel">Escribe un mensaje</label><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled aria-label="Escribe tu mensaje aquí"><button type="submit" class="btn" disabled aria-label="Enviar mensaje" data-lang-key="sendButton">Enviar</button></form></div></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-quienes-somos" class="page-section" role="region" aria-labelledby="quienes-somos-title"><div class="page-header"><h2 id="quienes-somos-title" data-lang-key="whoTitle">¿Quiénes somos?</h2></div><div class="card" id="quienes-somos-container" style="line-height:1.8;color:var(--text-light);" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-ajustes" class="page-section" role="region" aria-labelledby="ajustes-title"><div class="page-header"><h2 id="ajustes-title" data-lang-key="settingsTitle">Ajustes</h1></div><div class="card"><div class="settings-container" style="display:flex;flex-direction:column;gap:2.5rem;"><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="languageSettingsTitle">Idioma de la Interfaz</h3><select id="language-selector" class="input-field" aria-label="Selector de idioma"><option value="es" data-lang-key="langES">Español</option><option value="en" data-lang-key="langEN">English</option><option value="zh" data-lang-key="langZH">中文 (Chino)</option><option value="de" data-lang-key="langDE">Deutsch (Alemán)</option><option value="fr" data-lang-key="langFR">Français (Francés)</option><option value="pt" data-lang-key="langPT">Português (Brasil)</option></select></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="accessibilitySettingsTitle">Accesibilidad</h3><div class="toggle-switch"><p data-lang-key="largeTextToggle">Texto más grande</p><label for="font-size-toggle" class="switch" aria-label="Activar texto más grande"><input type="checkbox" id="font-size-toggle"><span class="slider"></span></label></div><div class="toggle-switch" style="margin-top: 1rem;"><p data-lang-key="contrastToggle">Modo de Alto Contraste</p><label for="contrast-toggle" class="switch" aria-label="Activar modo de alto contraste"><input type="checkbox" id="contrast-toggle"><span class="slider"></span></label></div></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="menuBackgroundSettingsTitle">Fondo del Menú</h3><p data-lang-key="uploadBackgroundDesc">Sube una imagen o video local para usar de fondo.</p><input type="file" id="background-upload" accept="image/*,video/*" class="input-field" aria-label="Subir archivo para fondo de menú"></div><div><p data-lang-key="pasteUrlBackgroundDesc">O pega un enlace URL.</p><form id="background-url-form" class="input-group"><label for="background-url-input" class="sr-only" data-lang-key="backgroundUrlLabel">URL para fondo de menú</label><input type="url" id="background-url-input" class="input-field" placeholder="https://ejemplo.com/imagen.jpg" aria-label="Introduce la URL del fondo del menú"><button type="submit" class="btn" data-lang-key="applyButton">Aplicar</button></form></div><div><button id="background-reset" class="btn btn-secondary" aria-label="Quitar fondo personalizado" data-lang-key="resetBackgroundButton">Quitar fondo</button></div></div></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la página anterior" data-lang-key="backButton">Regresar</button></section>
    </div></main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATABASE ---
        const mathData = {
            Algebra: { nameKey: "algebraName", topicKey: "math", descriptionKey: "algebraDesc", howToKey: "algebraHowTo", typesKey: "algebraTypes", errorsKey: "algebraErrors" },
            Geometria: { nameKey: "geometriaName", topicKey: "math", descriptionKey: "geometriaDesc", howToKey: "geometriaHowTo", typesKey: "geometriaTypes", errorsKey: "geometriaErrors" },
            Trigonometria: { nameKey: "trigonometriaName", topicKey: "math", descriptionKey: "trigonometriaDesc", howToKey: "trigonometriaHowTo", typesKey: "trigonometriaTypes", errorsKey: "trigonometriaErrors" },
            Funciones: { nameKey: "funcionesName", topicKey: "math", descriptionKey: "funcionesDesc", howToKey: "funcionesHowTo", typesKey: "funcionesTypes", errorsKey: "funcionesErrors" },
            EstadisticaYProbabilidad: { nameKey: "estadisticaName", topicKey: "math", descriptionKey: "estadisticaDesc", howToKey: "estadisticaHowTo", typesKey: "estadisticaTypes", errorsKey: "estadisticaErrors" },
            Calculo: { nameKey: "calculoName", topicKey: "math", descriptionKey: "calculoDesc", howToKey: "calculoHowTo", typesKey: "calculoTypes", errorsKey: "calculoErrors" }
        };
        const consejosData = [{ icon: "fa-brain", titleKey: "tip1Title" }, { icon: "fa-pencil-alt", titleKey: "tip2Title" }, { icon: "fa-check-circle", titleKey: "tip3Title" }, { icon: "fa-chalkboard-teacher", titleKey: "tip4Title" }, { icon: "fa-lightbulb", titleKey: "tip5Title" }, { icon: "fa-book", titleKey: "tip6Title" }, { icon: "fa-users", titleKey: "tip7Title" }, { icon: "fa-clock", titleKey: "tip8Title" }, { icon: "fa-question", titleKey: "tip9Title" }, { icon: "fa-chart-line", titleKey: "tip10Title" }, { icon: "fa-dumbbell", titleKey: "tip11Title" }, { icon: "fa-bed", titleKey: "tip12Title" }];
        const quienesSomosText = `<p data-lang-key="quienesSomosText1">Somos un grupo de estudiantes de Educación para el Trabajo que hemos creado el proyecto “Potencia tu mente con matemáticas”, una plataforma web diseñada para apoyar el aprendizaje de las matemáticas de manera sencilla, práctica e interactiva. Nuestro objetivo es brindar a los estudiantes una herramienta accesible y motivadora que les permita reforzar sus conocimientos y superar las dificultades más comunes en esta área.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText2">Nos caracterizamos por ser un equipo responsable, creativo y comprometido con la innovación educativa. Cada integrante aporta sus ideas, habilidades y talentos, lo que nos permite trabajar de manera colaborativa y complementaria. Nos guía la convicción de que la educación es la clave para el desarrollo personal y social, y que el uso de la tecnología puede convertirse en un aliado poderoso para mejorar los procesos de enseñanza y aprendizaje.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText3">A través de este proyecto, buscamos ofrecer un servicio que no solo enseñe matemáticas, sino que también despierte en los estudiantes la confianza y el gusto por aprender. Queremos que “Potencia tu mente con matemáticas” sea un espacio digital donde cada usuario se sienta acompañado en su proceso educativo, encontrando materiales claros, niveles de práctica graduados y actividades interactivas que hagan del aprendizaje una experiencia dinámica.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText4">Creemos firmemente que nuestro esfuerzo contribuirá al desarrollo académico de los estudiantes y al fortalecimiento de sus competencias matemáticas, demostrando que con constancia, innovación y dedicación se puede transformar la manera en que aprendemos.</p>`;
        const translations = {
            es: { mainTitle: "Potencia tu Mente", menuTitle: "Menú Principal", conceptsTitle: "Conceptos", practiceTitle: "Práctica", tipsTitle: "Consejos", chatTitle: "Aprendamos Juntos", whoTitle: "Quiénes Somos", settingsTitle: "Ajustes",
                conceptsPageDesc:"Encuentra el tema que necesitas.", practicePageDesc:"Genera ejercicios y situaciones problemáticas.", tipsPageDesc:"Estrategias para potenciar tu aprendizaje.",
                enterButton:"Entrar", welcomeSlogan: "Tu viaje al dominio de las matemáticas comienza ahora.", backButton:"Regresar",
                usernameLabel:"Nombre de usuario", chatOverlayTitle:"Crea tu Perfil de Estudiante",chatOverlayDesc:"Elige un nombre para mostrar. Se te asignará un código único para agregar amigos.",
                saveAndEnterBtn:"Guardar y Entrar", helloText:"Hola",yourCodeIsText:"Tu código de amigo es:",friendsTitle:"Amigos",friendsDesc:"Añade amigos usando su código único.",friendCodeLabel:"Código del amigo",addFriendBtn:"+",
                selectFriendText:"Selecciona un amigo",writeMessageLabel:"Escribe un mensaje",sendButton:"Enviar",
                languageSettingsTitle:"Idioma de la Interfaz", accessibilitySettingsTitle:"Accesibilidad", largeTextToggle:"Texto más grande", contrastToggle:"Modo de Alto Contraste",
                menuBackgroundSettingsTitle:"Fondo del Menú", uploadBackgroundDesc:"Sube una imagen o video local para usar de fondo.",pasteUrlBackgroundDesc:"O pega un enlace URL.",applyButton:"Aplicar",resetBackgroundButton:"Quitar fondo",
                algebraName:"Álgebra", math:"Matemáticas", algebraDesc:"El álgebra es la rama de las matemáticas que estudia las estructuras y reglas de operaciones usando símbolos (como letras) para representar valores desconocidos. Es la ciencia de las ecuaciones y expresiones.", algebraHowTo:"Se busca despejar la incógnita (como 'x'). Los términos se mueven entre los lados de una igualdad invirtiendo su operación (suma a resta, multiplicación a división) para aislar la variable.", algebraTypes:"Elemental (ecuaciones lineales), Lineal (vectores, matrices), Abstracta (grupos, anillos).", algebraErrors:"Distribuir mal un signo negativo, no respetar la jerarquía de operaciones, fallos en leyes de exponentes (ej. (a+b)² ≠ a²+b²).",
                geometriaName:"Geometría", geometriaDesc:"Es la rama que estudia las propiedades del espacio, como puntos, líneas y figuras.", geometriaHowTo:"Se aplica mediante el uso de teoremas y fórmulas para calcular propiedades como área, perímetro, volumen y ángulos. La visualización es clave.", geometriaTypes:"Plana (2D), del Espacio (3D), Analítica (con coordenadas).", geometriaErrors:"Confundir la fórmula del perímetro con la del área, errores de unidades (cm vs m), olvidar pasos (como el ½ en el área del triángulo).",
                trigonometriaName:"Trigonometría", trigonometriaDesc:"Estudia las relaciones entre los ángulos y los lados de los triángulos, basándose en las razones trigonométricas (seno, coseno, tangente).", trigonometriaHowTo:"Se identifican los catetos (opuesto, adyacente) y la hipotenusa en un triángulo rectángulo para aplicar las razones y resolver por ángulos o lados desconocidos.", trigonometriaTypes:"Plana, Esférica, funciones inversas (arcoseno).", trigonometriaErrors:"Identificar incorrectamente el cateto opuesto y adyacente, confundir grados con radianes.",
                funcionesName:"Funciones", funcionesDesc:"Una función es una regla que asocia a cada valor de entrada (x) un único valor de salida (y). Se escribe como y = f(x).", funcionesHowTo:"Se evalúa la función sustituyendo la variable 'x' por un número para encontrar 'y'. Se analizan su dominio y rango.", funcionesTypes:"Lineales, cuadráticas, exponenciales, logarítmicas.", funcionesErrors:"Confundir dominio y rango, no pasar la 'prueba de la línea vertical'.",
                estadisticaName:"Estadística y Probabilidad", estadisticaDesc:"La estadística recolecta, analiza e interpreta datos. La probabilidad mide la certeza de que ocurra un evento.", estadisticaHowTo:"La estadística usa medidas como media, mediana y moda. La probabilidad se calcula como (casos favorables) / (casos totales).", estadisticaTypes:"Descriptiva, Inferencial. Probabilidad Clásica, Frecuencial.", estadisticaErrors:"Confundir correlación con causalidad, confundir media con mediana.",
                calculoName:"Cálculo", calculoDesc:"Rama que estudia el cambio continuo. La derivada mide la tasa de cambio instantánea y la integral calcula acumulados.", calculoHowTo:"Se aplican reglas de derivación e integración para encontrar la pendiente de una curva o el área bajo ella.", calculoTypes:"Diferencial (derivadas) e Integral (integrales).", calculoErrors:"Dificultad con el concepto de límite, confundir las reglas de derivación, olvidar la constante de integración.",
                tip1Title:"Entiende, no memorices", tip1Text:"Las fórmulas son importantes, pero entender por qué funcionan te permitirá resolver cualquier tipo de problema.", tip2Title:"Practica todos los días", tip2Text:"La consistencia es clave. Dedica al menos 20-30 minutos diarios a resolver ejercicios.", tip3Title:"Analiza tus errores", tip3Text:"Equivocarse es una oportunidad para aprender. Cuando falles, entiende el proceso y dónde te equivocaste.", tip4Title:"Intenta enseñar el concepto", tip4Text:"Si puedes explicar un tema a un amigo de forma sencilla, significa que realmente lo has dominado.",tip5Title:"Crea un glosario propio",tip5Text:"Anota términos y símbolos nuevos con tus propias palabras. Te ayudará a recordarlos mejor.",tip6Title:"Lee el problema con atención",tip6Text:"Antes de resolver, lee el problema varias veces. Asegúrate de entender qué te están pidiendo y qué datos tienes.",tip7Title:"Colabora con compañeros",tip7Text:"Estudiar en grupo permite ver diferentes formas de resolver un problema y aclarar dudas mutuamente.",tip8Title:"Gestiona tu tiempo",tip8Text:"No te quedes atascado en un solo problema por mucho tiempo. Si no avanzas, déjalo y vuelve a él más tarde con una mente fresca.",tip9Title:"Haz preguntas",tip9Text:"Nunca te quedes con una duda. Pregúntale a tu profesor o a tus compañeros.",tip10Title:"Visualiza los problemas",tip10Text:"Dibuja diagramas o gráficos. Convertir un problema abstracto en algo visual puede revelar la solución.",tip11Title:"Fortalece tus bases",tip11Text:"Muchos errores en temas avanzados provienen de bases débiles. Asegúrate de dominar la aritmética y el álgebra elemental.",tip12Title:"Descansa adecuadamente",tip12Text:"Un cerebro cansado no aprende bien. Dormir lo suficiente es tan importante como estudiar para consolidar la información.",
                langES: "Español", langEN: "English", langZH: "中文 (Chino)", langDE: "Deutsch (Alemán)", langFR: "Français (Francés)", langPT: "Português (Brasil)",
                noConceptsFoundText: "No se encontraron temas.", noPracticeFoundText: "No hay ejercicios para este tema.", chatWithText: "Chat con", selectFriendText: "Selecciona un amigo", copyCodeAlert: "¡Código de amigo copiado!",
                confirmDeleteFriendText: "¿Seguro que quieres eliminar a este amigo?",confirmDeleteMessageText: "¿Seguro que quieres eliminar este mensaje?",
                searchConceptPlaceholder: "Buscar tema (ej. Álgebra, Geometría...)", searchPracticePlaceholder: "Buscar tema de práctica",
                usernamePlaceholder: "TuUsuario123", friendCodePlaceholder: "Código del amigo...", typeYourAnswerPlaceholder: "Escribe tu respuesta aquí...",
                startButton: "Comenzar", practiceButton: "Practiquemos", checkAnswerButton: "Comprobar", solveTogetherButton: "Resolvamoslo Juntos",
                exerciseText: "Ejercicio", problemText: "Situación Problemática",
                correctAnswerText: "¡Correcto!", incorrectAnswerText: "Incorrecto. La respuesta era",
                // Environmental problems (only first 3 for brevity, more can be added)
                envProb1_q: "En una comunidad, se reciclan {0} kg de plástico al mes. Si aumenta el 10% el reciclaje, ¿cuántos kg se reciclarán el próximo mes?", // {0} will be replaced
                envProb1_a: (val) => val * 1.1,
                envProb2_q: "Una fábrica contamina el río con {0} litros de desechos tóxicos cada hora. Si se implementa un filtro que reduce el 25% de la contaminación, ¿cuántos litros de desecho seguirá vertiendo por hora?",
                envProb2_a: (val) => val * 0.75,
                envProb3_q: "En una granja se usan {0} litros de agua para regar. Si se instala un sistema de riego por goteo que ahorra 30%, ¿cuánta agua se ahorrará?",
                envProb3_a: (val) => val * 0.30
            },
            en: { // English translations, simplified for brevity
                mainTitle: "Power Up Your Mind",menuTitle:"Main Menu",conceptsTitle:"Concepts",practiceTitle:"Practice",tipsTitle:"Tips",chatTitle:"Let's Learn Together",whoTitle:"Who We Are",settingsTitle:"Settings",
                conceptsPageDesc:"Find the topic you need.", practicePageDesc:"Generate random exercises and problems.", tipsPageDesc:"Strategies to boost your learning.",
                enterButton:"Enter", welcomeSlogan: "Your journey to math mastery starts now.", backButton:"Back",
                usernameLabel:"Username", chatOverlayTitle:"Create Your Student Profile",chatOverlayDesc:"Choose a display name. You will be assigned a unique code to add friends.",
                saveAndEnterBtn:"Save & Enter", helloText:"Hello",yourCodeIsText:"Your friend code is:",friendsTitle:"Friends",friendsDesc:"Add friends using their unique code.",friendCodeLabel:"Friend code",addFriendBtn:"+",
                selectFriendText:"Select a friend",writeMessageLabel:"Write a message",sendButton:"Send",
                languageSettingsTitle:"Interface Language", accessibilitySettingsTitle:"Accessibility", largeTextToggle:"Larger Text", contrastToggle:"High Contrast Mode",
                menuBackgroundSettingsTitle:"Menu Background", uploadBackgroundDesc:"Upload a local image or video to use as background.",pasteUrlBackgroundDesc:"Or paste a URL link.",applyButton:"Apply",resetBackgroundButton:"Remove background",
                algebraName:"Algebra", math:"Mathematics", algebraDesc:"Algebra studies structures and rules using symbols to represent unknown values.", algebraHowTo:"Solve by isolating the unknown (like 'x') by moving terms across the equality, inverting operations.", algebraTypes:"Elementary (linear equations), Linear (vectors), Abstract (groups).", algebraErrors:"Incorrectly distributing a negative sign, not respect order of operations, exponent law mistakes.",
                geometriaName:"Geometry", geometriaDesc:"Branch that studies the properties of space, like points, lines, and figures.",
                trigonometriaName:"Trigonometry", trigonometriaDesc:"Studies the relationships between angles and sides of triangles.",
                funcionesName:"Functions", funcionesDesc:"A function associates each input (x) with a single output (y).",
                estadisticaName:"Statistics & Probability", estadisticaDesc:"Statistics collects, analyzes data. Probability measures event certainty.",
                calculoName:"Calculus", calculoDesc:"Branch that studies continuous change through derivatives and integrals.",
                tip1Title:"Understand, don't memorize", tip1Text:"Understanding why formulas work will enable you to solve any problem.",tip2Title:"Practice every day",tip2Text:"Consistency is key. 20-30 daily minutes build confidence and skill.",tip3Title:"Analyze your mistakes",tip3Text:"Mistakes are an opportunity. Understand the process and where you went wrong.",tip4Title:"Try to teach the concept",tip4Text:"If you can explain a topic to a friend simply, you've mastered it.",
                noConceptsFoundText: "No concepts found.", noPracticeFoundText: "No exercises for this topic.", chatWithText: "Chat with", copyCodeAlert: "Friend code copied!",
                startButton: "Start", practiceButton: "Practice", checkAnswerButton: "Check", solveTogetherButton: "Solve Together",
                exerciseText: "Exercise", problemText: "Problem", correctAnswerText: "Correct!", incorrectAnswerText: "Incorrect. The answer was",
                // Environmental problems - Q stands for question, A for answer. {0} is placeholder for random value
                envProb1_q: "In a community, {0} kg of plastic are recycled monthly. If recycling increases by 10%, how many kg will be recycled next month?", envProb1_a: (val) => val * 1.1,
                envProb2_q: "A factory pollutes the river with {0} liters of toxic waste per hour. If a filter reduces pollution by 25%, how many liters of waste will still be discharged per hour?", envProb2_a: (val) => val * 0.75,
                envProb3_q: "On a farm, {0} liters of water are used for irrigation. If a drip irrigation system is installed that saves 30%, how much water will be saved?", envProb3_a: (val) => val * 0.30
            },
            zh: { // Simplified Chinese
                mainTitle: "提升思维", menuTitle: "主菜单", conceptsTitle: "概念", practiceTitle: "练习", tipsTitle: "提示", chatTitle: "一起学习", whoTitle: "关于我们", settingsTitle: "设置", backButton: "返回",
                algebraName: "代数", math: "数学", algebraDesc: "代数研究使用符号表示未知值的结构和运算规则。", algebraHowTo: "通过在等式两边移动项并颠倒运算来求解未知数 ('x')。", algebraTypes: "基础（线性方程），线性（向量），抽象（群）。", algebraErrors: "负号分配不正确，不遵守运算顺序，指数定律错误。",
                geometriaName: "几何", geometriaDesc: "研究空间属性，如点、线和图形的数学分支。", trigonometriaName: "三角学", funcionesName: "函数", estadisticaName: "统计与概率", calculoName: "微积分",
                tip1Title: "理解，不背诵", tip1Text: "理解公式的原理，可以解决任何问题。", tip2Title: "每天练习", tip2Text: "坚持是关键。每天花20-30分钟做练习。",
                selectFriendText: "选择一位朋友", typeYourAnswerPlaceholder: "输入您的答案...", checkAnswerButton: "检查"
            },
            de: { // German
                mainTitle: "Geist stärken", menuTitle: "Hauptmenü", conceptsTitle: "Konzepte", practiceTitle: "Übung", tipsTitle: "Tipps", chatTitle: "Lasst uns gemeinsam lernen", whoTitle: "Wer wir sind", settingsTitle: "Einstellungen", backButton: "Zurück",
                algebraName: "Algebra", math: "Mathematik", algebraDesc: "Algebra erforscht Strukturen und Regeln von Operationen mit Symbolen.", algebraHowTo:"Löse nach der Unbekannten ('x'), indem du Terme in der Gleichung verschiebst.", algebraTypes:"Elementare (lineare Gleichungen), Lineare (Vektoren), Abstrakte (Gruppen).", algebraErrors:"Negatives Vorzeichen falsch verteilen, Rechenreihenfolge nicht beachten, Fehler bei Potenzgesetzen.",
                geometriaName: "Geometrie", geometriaDesc: "Studium der Eigenschaften des Raums, wie Punkte, Linien und Figuren.",
                selectFriendText: "Freund auswählen", typeYourAnswerPlaceholder: "Ihre Antwort eingeben...", checkAnswerButton: "Überprüfen"
            },
            fr: { // French
                mainTitle: "Puisez dans votre esprit", menuTitle: "Menu principal", conceptsTitle: "Concepts", practiceTitle: "Pratique", tipsTitle: "Conseils", chatTitle: "Apprenons ensemble", whoTitle: "Qui sommes-nous", settingsTitle: "Paramètres", backButton: "Retour",
                algebraName: "Algèbre", math: "Mathématiques", algebraDesc: "L'algèbre étudie les structures et règles des opérations utilisant des symboles.", algebraHowTo:"Résolvez en isolant l'inconnue ('x') en déplaçant les termes de l'égalité.", algebraTypes:"Élémentaire (équations linéaires), Linéaire (vecteurs), Abstraite (groupes).", algebraErrors:"Distribuer incorrectement un signe négatif, ne pas respecter l'ordre des opérations, erreurs sur les lois des exposants.",
                geometriaName: "Géométrie", geometriaDesc: "Branche qui étudie les propriétés de l'espace, comme les points, les lignes et les figures.",
                selectFriendText: "Sélectionner un ami", typeYourAnswerPlaceholder: "Écrivez votre réponse ici...", checkAnswerButton: "Vérifier"
            },
            pt: { // Portuguese (Brazil)
                mainTitle: "Potencialize Sua Mente", menuTitle: "Menu Principal", conceptsTitle:"Conceitos", practiceTitle:"Prática", tipsTitle:"Dicas", chatTitle:"Vamos Aprender Juntos",whoTitle:"Quem Somos",settingsTitle:"Ajustes",backButton:"Voltar",
                algebraName:"Álgebra", math:"Matemática", algebraDesc:"A álgebra estuda estruturas e regras de operações usando símbolos para representar valores desconhecidos.", algebraHowTo:"Busca-se isolar a incógnita ('x') movendo os termos na igualdade.", algebraTypes:"Elementar (equações lineares), Linear (vetores), Abstrata (grupos).", algebraErrors:"Distribuir um sinal negativo incorretamente, não respeitar a ordem das operações, erros em leis de expoentes.",
                geometriaName:"Geometria", geometriaDesc:"Ramo que estuda as propriedades do espaço, como pontos, linhas e figuras.",
                selectFriendText: "Selecionar um amigo", typeYourAnswerPlaceholder: "Escreva sua resposta aqui...", checkAnswerButton: "Verificar"
            }
        };
        
        // --- STATE, UI, SOCKET ---
        const state = { 
            myUsername: localStorage.getItem('myUsername'), myCode: localStorage.getItem('myCode'), 
            friends: JSON.parse(localStorage.getItem('myFriends')) || [], 
            activeChat: null, messages: JSON.parse(localStorage.getItem('myMessages')) || {}, 
            onlineFriends: [] 
        };
        const ui = { 
            main: document.querySelector('main'), 
            inicio: document.getElementById('view-inicio'), 
            sections: document.querySelectorAll('.page-section'), 
            navLinks: document.querySelectorAll('.nav-link'), 
            backButtons: document.querySelectorAll('.btn-back'), 
            chat: { 
                overlay: document.getElementById('username-overlay'), form: document.getElementById('username-form'), input: document.getElementById('username-input'), 
                yourUsername: document.getElementById('your-username'), yourCode: document.getElementById('your-code'), addForm: document.getElementById('add-friend-form'), 
                friendInput: document.getElementById('friend-code-input'), list: document.getElementById('friends-list'), header: document.getElementById('chat-header'), 
                messages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('chat-form').querySelector('button') 
            }, 
            concepts: { 
                grid: document.getElementById('concepts-grid'), search: document.getElementById('concept-search'), detail: document.getElementById('concept-detail-container'), suggestions: document.getElementById('concept-suggestions') 
            }, 
            practice: { 
                header: document.getElementById('practice-header'), grid: document.getElementById('practice-grid'), search: document.getElementById('practice-search'), suggestions: document.getElementById('practice-suggestions') 
            }, 
            consejos: { container: document.getElementById('consejos-container') }, 
            quienes: { container: document.getElementById('quienes-somos-container') }, 
            ajustes: { 
                lang: document.getElementById('language-selector'), bgUpload: document.getElementById('background-upload'), bgUrlForm: document.getElementById('background-url-form'), bgUrlInput: document.getElementById('background-url-input'), bgReset: document.getElementById('background-reset'),
                fontSizeToggle: document.getElementById('font-size-toggle'), contrastToggle: document.getElementById('contrast-toggle') 
            } 
        };
        const socket = io();

        // --- ACCESSIBILITY UTILITIES ---
        function applyAccessibilitySettings() {
            if (localStorage.getItem('fontSizeEnabled') === 'true') {
                document.body.classList.add('large-text');
                ui.ajustes.fontSizeToggle.checked = true;
            }
            if (localStorage.getItem('highContrastEnabled') === 'true') {
                document.body.classList.add('dark-theme');
                ui.ajustes.contrastToggle.checked = true;
            }
        }
        
        // --- TRANSLATION UTILITY ---
        function getTranslatedText(key, lang = localStorage.getItem('appLanguage') || 'es') {
            return translations[lang] && translations[lang][key] !== undefined ? translations[lang][key] : translations.es[key] || key;
        }

        function updateAllTranslations(lang = localStorage.getItem('appLanguage') || 'es') {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                const translatedText = getTranslatedText(key, lang);
                // Handle different types of elements for translation
                if (el.tagName === 'INPUT' && el.placeholder) {
                    el.placeholder = translatedText;
                } else if (el.tagName === 'OPTGROUP' || el.tagName === 'OPTION') {
                    // Options and Optgroups textContent is handled
                    el.textContent = translatedText;
                }
                else {
                    el.textContent = translatedText;
                }
            });
            // Specific placeholder updates not caught by data-lang-key
            if(ui.concepts.search) ui.concepts.search.placeholder = getTranslatedText('searchConceptPlaceholder', lang);
            if(ui.practice.search) ui.practice.search.placeholder = getTranslatedText('searchPracticePlaceholder', lang);
            if(ui.chat.input) ui.chat.input.placeholder = getTranslatedText('usernamePlaceholder', lang);
            if(ui.chat.friendInput) ui.chat.friendInput.placeholder = getTranslatedText('friendCodePlaceholder', lang);
            if(ui.chat.chatInput) ui.chat.chatInput.placeholder = getTranslatedText('writeMessageLabel', lang); // Use writeMessageLabel for chat input placeholder
            if(ui.ajustes.bgUrlInput) ui.ajustes.bgUrlInput.placeholder = getTranslatedText('backgroundUrlPlaceholder', lang);

            // Re-render components that contain dynamic, translatable content
            renderConcepts();
            renderConsejos();
            // renderPracticeSearch() and renderFriends/Messages will be called upon view activation/chat updates
        }
        // --- NAVIGATION ---
        function showView(hash, data){
            let viewId = hash ? hash.substring(1) : (sessionStorage.getItem('visitedBefore') ? 'view-menu' : 'view-inicio');
            
            // Si es la primera visita y no se especifica el menú, siempre ir al inicio
            if (!sessionStorage.getItem('visitedBefore') && hash !== '#view-menu' && hash !== '') {
                viewId = 'view-inicio';
            } else if (sessionStorage.getItem('visitedBefore') && viewId === 'view-inicio') {
                viewId = 'view-menu'; // Si ya visitó antes, no mostrar intro de nuevo
            }
            
            document.body.style.overflow = viewId === 'view-inicio' ? 'hidden' : 'auto';
            ui.main.style.display = viewId === 'view-inicio' ? 'none' : 'block';
            ui.inicio.style.display = viewId === 'view-inicio' ? 'flex' : 'none';
            
            ui.sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(viewId);
            if (activeSection) {
                activeSection.classList.add('active');
            } else {
                document.getElementById('view-menu').classList.add('active'); // Fallback to menu
            }

            // Llamadas de inicialización específicas por vista
            if (viewId === 'view-practica') renderPracticeSearch(data?.topicId);
            if (viewId === 'view-concepto-detalle' && data?.topicId) renderConceptDetail(data.topicId);
            if (viewId === 'view-chat') handleChatEntry(data);
            updateAllTranslations(); // Aplicar traducciones cada vez que cambia la vista
        }
        
        function setupNavigation(){
            ui.navLinks.forEach(link=>link.addEventListener('click',e=>{e.preventDefault();history.pushState(data, '', href);showView(href,data); }));
            ui.backButtons.forEach(btn=>btn.addEventListener('click',()=>history.back()));
            window.addEventListener('popstate',()=>showView(location.hash,history.state));
            
            // Enlazar event listener para que el botón de 'Entrar' de la portada también establezca la navegación.
            document.querySelector('#view-inicio .nav-link').addEventListener('click', e => {
                e.preventDefault();
                history.pushState({}, '', '#view-menu');
                sessionStorage.setItem('visitedBefore', 'true');
                showView('#view-menu');
            });
        }
        
        // --- CHAT LOGIC --- (Funciones de chat aquí...)
        
        // --- INITIALIZATION ---
        function init() {
            // Partículas de fondo para la pantalla de inicio
            if(document.getElementById('particles-js'))particlesJS('particles-js',{"particles":{"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.5,"random":false,"anim":{"enable":true,"speed":1,"opacity_min":0.1,"sync":false}},"size":{"value":3,"random":true,"anim":{"enable":false,"size_min":0.1,"sync":false}},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.4,"width":1},"move":{"enable":true,"speed":2,"direction":"none","random":false,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"},"resize":true},"modes":{"grab":{"distance":200,"line_linked":{"opacity":1}},"push":{"particles_nb":4},"repulse":{"distance":200,"duration":0.4}}}});
            
            // Configurar todos los módulos
            setupNavigation();
            setupChat();
            setupConcepts();
            setupPractice();
            setupSettings();
            renderStaticContent();
            applyAccessibilitySettings(); // Aplicar al inicio
            
            // Cargar configuración de idioma y fondo guardada
            const savedLang = localStorage.getItem('appLanguage') || 'es';
            ui.ajustes.lang.value = savedLang;
            updateAllTranslations(savedLang); // Aplicar traducciones al inicio
            const savedBg = localStorage.getItem('menuBackground');
            if(savedBg) applyBackground(savedBg);

            // Mostrar la vista inicial después de que todo esté configurado
            showInitialView();
        }
        init();
    });
</script>
</body>
</html>