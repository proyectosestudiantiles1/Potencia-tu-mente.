<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root{--primary-gradient:linear-gradient(90deg, #1abc9c, #16a085);--primary-color:#16a085;--secondary-color:#2c3e50;--bg-color:#ecf0f1;--card-bg:#ffffff;--text-dark:#34495e;--text-light:#7f8c8d;--shadow:0 10px 30px rgba(0,0,0,0.07);--radius:16px;--online-color:#2ecc71;--offline-color:#bdc3c7;--font-base-size:16px;}
      *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
      body{font-family:'Lato',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;font-size:var(--font-base-size)}
      main{display:none}.page-section{display:none}.page-section.active{display:block;animation:fadeIn 0.5s ease-in-out forwards}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .container{max-width:1200px;margin:0 auto;padding:2rem}.page-header{margin-bottom:2.5rem;text-align:center}
      .page-header h2{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*2.2);color:var(--secondary-color)}.page-header p{font-size:calc(var(--font-base-size)*1.1);color:var(--text-light);max-width:700px;margin:.5rem auto 0}
      .btn{display:inline-block;padding:.8rem 1.8rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .2s ease,box-shadow .3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-base-size)}.btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 20px rgba(22,160,133,.4)}.btn:disabled{background:#bdc3c7;cursor:not-allowed;box-shadow:none;}
      .btn-secondary{background:#95a5a6;box-shadow:0 4px 15px rgba(0,0,0,.1)}.btn-secondary:hover:not(:disabled){background:#7f8c8d}.btn-back{display:block;width:fit-content;margin-top:2.5rem}
      .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);transition: all .3s ease;}.card:hover{transform:translateY(-8px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
      .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dee2e6;background:var(--bg-color);color:var(--text-dark);border-radius:8px;font-size:var(--font-base-size);transition:border-color .2s,box-shadow .2s}
      #view-inicio{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#1c2541}
      .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.menu-card .icon{font-size:3rem;color:var(--primary-color);margin-bottom:1rem}
      /* Nueva Secci칩n Pr치ctica */
      #practice-results{margin-top:2rem;display:grid;grid-template-columns:repeat(auto-fit, minmax(350px, 1fr));gap:1.5rem;}.problem-card{background-color:var(--card-bg);padding:1.5rem;border-radius:var(--radius);box-shadow:var(--shadow)}.solution{margin-top:1rem;padding:1rem;background-color:var(--bg-color);border-radius:8px;border-left:4px solid var(--primary-color);}
      /* Nuevo Overlay de Autenticaci칩n */
      #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000}.auth-card{width:100%;max-width:400px;text-align:center}.auth-toggle{margin-bottom:1.5rem;}.auth-toggle button{background:none;border:none;cursor:pointer;padding:0.5rem 1rem;font-size:1.1rem;color:var(--text-light)}.auth-toggle button.active{font-weight:bold;color:var(--primary-color);border-bottom:2px solid var(--primary-color)}#register-form{display:none;}#auth-feedback{margin-top:1rem;color:red;min-height:1.2em;}.forgot-password{font-size:0.9rem;color:var(--text-light);text-decoration:underline;cursor:pointer;margin-top:1rem;display:inline-block}
      .chat-layout{display:grid;grid-template-columns:320px 1fr;gap:1.5rem;height:75vh;max-height:700px}
    </style>
</head>
<body>
    <section id="view-inicio">
        <div class="inicio-content"><h1>Potencia tu Mente</h1><p>Tu viaje al dominio de las matem치ticas comienza ahora.</p><button id="enter-button" class="btn">Entrar</button></div>
    </section>
    
    <main>
        <div class="container">
            <section id="view-menu" class="page-section card">
                <div class="page-header"><h2>Men칰 Principal</h2></div>
                <div class="menu-grid">
                    <a href="#view-ia" class="menu-card nav-link card"><div class="icon"><i class="fas fa-robot"></i></div><h3>Tutor IA</h3><p>Resuelve cualquier duda.</p></a>
                    <a href="#view-practice" class="menu-card nav-link card"><div class="icon"><i class="fas fa-pencil-ruler"></i></div><h3>Pr치ctica con IA</h3><p>Genera problemas para resolver.</p></a>
                    <a href="#view-consejos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-lightbulb"></i></div><h3>Consejos</h3><p>Descubre nuevas estrategias.</p></a>
                    <a href="#view-chat" class="menu-card nav-link card"><div class="icon"><i class="fas fa-comments"></i></div><h3>Aprendamos Juntos</h3><p>Chatea con amigos.</p></a>
                </div>
                <button class="btn btn-secondary" id="logout-button" style="display:none; margin: 2rem auto 0; background: #e74c3c;">Cerrar Sesi칩n</button>
            </section>
            
            <section id="view-ia" class="page-section">
                <div class="page-header"><h2>Tutor IA</h2><p>Preg칰ntale cualquier concepto, ejercicio o problema matem치tico a la IA.</p></div>
                <div class="card"><div class="input-group"><input id="ia-input" type="text" class="input-field" placeholder="Ej: 쯈u칠 es el Teorema de Pit치goras?" /><button id="ia-button" class="btn">Consultar</button></div><div id="ia-explanation"><p>Aqu칤 aparecer치 la explicaci칩n...</p></div></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>

            <section id="view-practice" class="page-section">
                <div class="page-header"><h2>Pr치ctica con IA</h2><p>Escribe un tema y la IA crear치 problemas para que practiques.</p></div>
                <div class="card"><div class="input-group"><input id="practice-input" type="text" class="input-field" placeholder="Ej: Ecuaciones de primer grado" /><button id="practice-button" class="btn">Generar Problemas</button></div></div>
                <div id="practice-results"><p style="text-align:center; color: var(--text-light);">Aqu칤 aparecer치n los problemas generados...</p></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>

            <section id="view-consejos" class="page-section">
                <div class="page-header"><h2>Consejos de la IA</h2><p>Cada vez que entres, la IA te dar치 nuevos consejos para mejorar.</p></div>
                <div id="consejos-container" class="menu-grid"></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>
            
            <section id="view-chat" class="page-section">
                <div id="auth-overlay">
                    <div class="card auth-card">
                        <div class="auth-toggle"><button id="show-login" class="active">Iniciar Sesi칩n</button><button id="show-register">Crear Cuenta</button></div>
                        <form id="login-form"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="login-username" class="input-field" placeholder="Nombre de usuario" required><input type="password" id="login-password" class="input-field" placeholder="Contrase침a" required></div><button type="submit" class="btn">Entrar</button></form>
                        <form id="register-form"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="register-username" class="input-field" placeholder="Nuevo nombre de usuario" required><input type="password" id="register-password" class="input-field" placeholder="Nueva contrase침a (m칤n. 4 caracteres)" required minlength="4"></div><button type="submit" class="btn">Registrarme</button></form>
                        <p id="auth-feedback"></p>
                        <a class="forgot-password">쯆lvidaste tu contrase침a?</a>
                    </div>
                </div>
                <div class="page-header"><h2>Aprendamos Juntos</h2></div>
                <div class="chat-layout">
                    <aside class="card"><p>Hola, <strong id="your-username" style="color:var(--primary-color)"></strong></p><p style="font-size:0.9em;">Tu c칩digo: <strong id="your-code" title="Clic para copiar" style="cursor:pointer; user-select:all;"></strong></p><h3 style="margin-top:1.5rem;">Amigos</h3><form id="add-friend-form" class="input-group"><input id="friend-code-input" class="input-field" placeholder="C칩digo de amigo..." required><button type="submit" class="btn">+</button></form><div id="friends-list"></div></aside>
                    <div class="card chat-window"><h3 id="chat-header">Selecciona un amigo</h3><div id="chat-messages" style="border:1px solid #ddd; padding:1rem; border-radius:var(--radius); flex-grow:1; overflow-y:auto; margin-bottom:1rem;"></div><form id="chat-form" class="input-group"><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled><button type="submit" class="btn" disabled>Enviar</button></form></div>
                </div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { currentUser: null, friends: [], activeChat: null, messages: {}, onlineFriends: [] };
        const ui = {
            main: document.querySelector('main'),
            inicio: { view: document.getElementById('view-inicio'), button: document.getElementById('enter-button') },
            logoutButton: document.getElementById('logout-button'),
            sections: document.querySelectorAll('.page-section'),
            navLinks: document.querySelectorAll('.nav-link'),
            backButtons: document.querySelectorAll('.btn-back'),
            ia: { input: document.getElementById('ia-input'), button: document.getElementById('ia-button'), explanation: document.getElementById('ia-explanation') },
            practice: { input: document.getElementById('practice-input'), button: document.getElementById('practice-button'), results: document.getElementById('practice-results') },
            consejos: { container: document.getElementById('consejos-container') },
            auth: { overlay: document.getElementById('auth-overlay'), showLogin: document.getElementById('show-login'), showRegister: document.getElementById('show-register'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), feedback: document.getElementById('auth-feedback'), forgotPassword: document.querySelector('.forgot-password') },
            chat: { yourUsername: document.getElementById('your-username'), yourCode: document.getElementById('your-code'), addForm: document.getElementById('add-friend-form'), friendInput: document.getElementById('friend-code-input'), list: document.getElementById('friends-list'), header: document.getElementById('chat-header'), messages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('chat-form').querySelector('button') },
        };
        const socket = io();

        function init() {
            setupNavigation();
            setupIA();
            setupPractice();
            setupAuth();
            setupChat();
            loadState();
        }

        function setupNavigation() {
            ui.inicio.button.addEventListener('click', enterApp);
            ui.navLinks.forEach(link => link.addEventListener('click', handleNav));
            ui.backButtons.forEach(btn => btn.addEventListener('click', () => history.back()));
            window.addEventListener('popstate', () => showView(location.hash.substring(1) || 'view-menu'));
        }
        function enterApp() {
            sessionStorage.setItem('visitedBefore', 'true');
            ui.inicio.view.style.display = 'none';
            ui.main.style.display = 'block';
            history.pushState(null, '', '#view-menu');
            showView('view-menu');
        }
        function handleNav(e) {
            e.preventDefault();
            const viewId = e.currentTarget.getAttribute('href').substring(1);
            if (viewId === 'view-chat' && !state.currentUser) {
                ui.auth.overlay.style.display = 'flex';
                return;
            }
            history.pushState(null, '', `#${viewId}`);
            showView(viewId);
        }
        function showView(viewId) {
            if (sessionStorage.getItem('visitedBefore')) {
                ui.main.style.display = 'block';
                ui.inicio.view.style.display = 'none';
            } else {
                ui.main.style.display = 'none';
                ui.inicio.view.style.display = 'flex';
                return;
            }
            ui.sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(viewId);
            if (activeSection) activeSection.classList.add('active');
            if (viewId === 'view-consejos') generateTips();
        }

        function loadState() {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                ui.logoutButton.style.display = 'block';
                socket.emit('register user', state.currentUser);
            }
            showView(location.hash.substring(1) || 'view-menu');
        }

        function setupAuth() {
            ui.auth.showLogin.addEventListener('click', () => toggleAuthForms(true));
            ui.auth.showRegister.addEventListener('click', () => toggleAuthForms(false));
            ui.auth.loginForm.addEventListener('submit', handleLogin);
            ui.auth.registerForm.addEventListener('submit', handleRegister);
            ui.auth.forgotPassword.addEventListener('click', handleForgotPassword);
            ui.logoutButton.addEventListener('click', handleLogout);
        }
        function toggleAuthForms(showLogin) {
            ui.auth.loginForm.style.display = showLogin ? 'block' : 'none';
            ui.auth.registerForm.style.display = showLogin ? 'none' : 'block';
            ui.auth.showLogin.classList.toggle('active', showLogin);
            ui.auth.showRegister.classList.toggle('active', !showLogin);
            ui.auth.feedback.textContent = '';
        }
        async function handleLogin(e) {
            e.preventDefault();
            const username = ui.auth.loginForm.querySelector('#login-username').value;
            const password = ui.auth.loginForm.querySelector('#login-password').value;
            const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await res.json();
            if (data.success) {
                state.currentUser = data.user;
                sessionStorage.setItem('currentUser', JSON.stringify(data.user));
                ui.auth.overlay.style.display = 'none';
                ui.logoutButton.style.display = 'block';
                socket.emit('register user', state.currentUser);
                history.pushState(null, '', '#view-chat');
                showView('view-chat');
            } else { ui.auth.feedback.textContent = data.message; }
        }
        async function handleRegister(e) {
            e.preventDefault();
            const username = ui.auth.registerForm.querySelector('#register-username').value;
            const password = ui.auth.registerForm.querySelector('#register-password').value;
            const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await res.json();
            if (data.success) {
                alert('춰Cuenta creada! Ahora puedes iniciar sesi칩n.');
                toggleAuthForms(true);
            } else { ui.auth.feedback.textContent = data.message; }
        }
        async function handleForgotPassword() {
            const username = prompt('Ingresa tu nombre de usuario para eliminar tu cuenta y poder registrarte de nuevo.');
            if (!username) return;
            if (confirm(`쮼st치s seguro? Se eliminar치 tu cuenta y tu lista de amigos permanentemente. Esta acci칩n no se puede deshacer.`)) {
                const res = await fetch('/api/delete-account', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username }) });
                const data = await res.json();
                alert(data.message);
                if (data.success && state.currentUser && state.currentUser.username === username) {
                    handleLogout();
                }
            }
        }
        function handleLogout() {
            state.currentUser = null;
            sessionStorage.removeItem('currentUser');
            ui.logoutButton.style.display = 'none';
            history.pushState(null, '', '#view-menu');
            showView('view-menu');
        }

        async function getAIResponse(endpoint, body, method = 'POST') {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (method === 'POST') options.body = JSON.stringify(body);
            const button = body.topic ? (endpoint.includes('problems') ? ui.practice.button : ui.ia.button) : null;
            if(button) button.disabled = true;
            try {
                const res = await fetch(endpoint, options);
                const data = await res.json();
                if (res.ok) return data.explanation || data.problems || data.tips;
                return `<p style="color:red;">${data.error || 'Error de la IA.'}</p>`;
            } catch (error) { return `<p style="color:red;">Error de conexi칩n.</p>`; }
            finally { if(button) button.disabled = false; }
        }
        
        function setupIA() {
            ui.ia.button.addEventListener('click', async () => {
                ui.ia.explanation.innerHTML = `<p>Consultando a la IA...</p>`;
                ui.ia.explanation.innerHTML = await getAIResponse('/api/explain-math', { topic: ui.ia.input.value });
            });
        }
        function setupPractice() {
            ui.practice.button.addEventListener('click', async () => {
                ui.practice.results.innerHTML = `<p>Generando problemas...</p>`;
                const response = await getAIResponse('/api/generate-problems', { topic: ui.practice.input.value });
                ui.practice.results.innerHTML = response;
                ui.practice.results.querySelectorAll('.show-solution-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const solution = btn.previousElementSibling;
                        solution.style.display = solution.style.display === 'none' ? 'block' : 'none';
                        btn.textContent = solution.style.display === 'none' ? 'Ver Respuesta' : 'Ocultar Respuesta';
                    });
                });
            });
        }
        async function generateTips() {
            ui.consejos.container.innerHTML = `<p>Generando consejos frescos...</p>`;
            ui.consejos.container.innerHTML = await getAIResponse('/api/generate-tips', {}, 'GET');
        }

        function setupChat() {
            socket.on('online users update', (users) => { state.onlineFriends = users; renderFriends(); });
            socket.on('private message', handleNewMessage);
            ui.chat.addForm.addEventListener('submit', addFriend);
            ui.chat.list.addEventListener('click', (e) => {
                const friendItem = e.target.closest('[data-code]');
                if (friendItem) setActiveChat(friendItem.dataset.code);
            });
            ui.chat.chatForm.addEventListener('submit', sendChatMessage);
        }
        function addFriend(e) {
            e.preventDefault();
            const code = ui.chat.friendInput.value.trim();
            if (!code || code === state.currentUser.code) return;
            socket.emit('add friend', code, (res) => {
                if (res.success && !state.friends.find(f => f.code === res.friend.code)) {
                    state.friends.push(res.friend);
                    renderFriends();
                } else { alert('C칩digo no v치lido o amigo ya a침adido.'); }
            });
            ui.chat.friendInput.value = '';
        }
        function renderFriends() {
            if (!state.currentUser) return;
            ui.chat.yourUsername.textContent = state.currentUser.username;
            ui.chat.yourCode.textContent = state.currentUser.code;
            ui.chat.list.innerHTML = state.friends.map(f => `<div class="card" data-code="${f.code}" style="cursor:pointer; padding: 0.8rem; margin-bottom: 0.5rem; ${f.code === state.activeChat ? 'background-color:#e0e6e8;' : ''}">${f.username}</div>`).join('');
        }
        function setActiveChat(code) {
            state.activeChat = code;
            ui.chat.header.textContent = `Chateando con ${state.friends.find(f=>f.code===code).username}`;
            ui.chat.chatInput.disabled = false; ui.chat.sendBtn.disabled = false;
            renderFriends(); renderMessages();
        }
        function sendChatMessage(e) {
            e.preventDefault();
            const text = ui.chat.chatInput.value.trim();
            if (!text || !state.activeChat) return;
            const message = { id: Date.now(), text };
            socket.emit('private message', { toCode: state.activeChat, message });
            handleNewMessage({ from: state.currentUser.username, message });
            ui.chat.chatInput.value = '';
        }
        function handleNewMessage({ from, message }) {
            const partnerCode = from === state.currentUser.username ? state.activeChat : state.friends.find(f => f.username === from)?.code;
            if (!partnerCode) return;
            state.messages[partnerCode] = state.messages[partnerCode] || [];
            state.messages[partnerCode].push({ from, ...message });
            if (partnerCode === state.activeChat) renderMessages();
        }
        function renderMessages() {
            ui.chat.messages.innerHTML = (state.messages[state.activeChat] || []).map(({from, text}) => `<div class="message-bubble ${from === state.currentUser.username ? 'sent' : 'received'}">${text}</div>`).join('');
            ui.chat.messages.scrollTop = ui.chat.messages.scrollHeight;
        }

        init();
    });
    </script>
</body>
</html>