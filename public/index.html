<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root{--primary-gradient:linear-gradient(90deg, #1abc9c, #16a085);--primary-color:#16a085;--secondary-color:#2c3e50;--bg-color:#f4f7f9;--card-bg:#ffffff;--text-dark:#34495e;--text-light:#7f8c8d;--shadow:0 8px 30px rgba(0,0,0,0.06);--radius:16px;--online-color:#2ecc71;--offline-color:#bdc3c7;--font-base-size:16px;}
      *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
      body{font-family:'Poppins',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;font-size:var(--font-base-size);-webkit-font-smoothing: antialiased;-moz-osx-font-smoothing: grayscale;}
      main{display:none}.page-section{display:none}.page-section.active{display:block;animation:fadeInUp 0.6s ease-out forwards}
      .container{max-width:1100px;margin:0 auto;padding:2rem}.page-header{margin-bottom:2.5rem;text-align:center}
      .page-header h2{font-family:'Poppins',sans-serif;font-weight:700;font-size:calc(var(--font-base-size)*2.2);color:var(--secondary-color)}.page-header p{font-size:calc(var(--font-base-size)*1.1);color:var(--text-light);max-width:700px;margin:.5rem auto 0; font-family: 'Lato', sans-serif;}
      .btn{display:inline-block;padding:.8rem 2rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition: all 0.3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-base-size)}.btn:hover:not(:disabled){transform:translateY(-4px);box-shadow:0 8px 25px rgba(22,160,133,.4)}.btn:disabled{background:#bdc3c7;cursor:not-allowed;box-shadow:none;}
      .btn-secondary{background:#dbe0e2;color:var(--text-dark);box-shadow:none}.btn-secondary:hover:not(:disabled){background:#c8cfd2; transform: translateY(-2px);}
      .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2.5rem;box-shadow:var(--shadow);transition: all 0.3s ease; border: 1px solid #e9ecef;}
      .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dde2e6;background-color:#f9fafb;color:var(--text-dark);border-radius:10px;font-size:var(--font-base-size);transition:border-color .2s,box-shadow .2s}.input-field:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(22,160,133,.2)}
      
      /* --- ANIMACIONES --- */
      @keyframes fadeInUp {from {opacity:0;transform:translateY(20px)} to {opacity:1;transform:translateY(0)}}
      @keyframes fadeIn {from {opacity:0} to {opacity:1}}

      /* --- PORTADA ANIMADA --- */
      #view-inicio{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#1c2541; overflow: hidden;}
      #particles-js{position:absolute;width:100%;height:100%;z-index:-1;}
      .inicio-content h1, .inicio-content p, .inicio-content .btn { opacity: 0; animation: fadeInUp 0.8s ease-out forwards; }
      .inicio-content h1 { font-size:clamp(3rem, 10vw, 5.5rem); letter-spacing:1px; animation-delay: 0.2s; }
      .inicio-content p { font-size:1.5rem;color:rgba(255,255,255,.8);margin-bottom:2.5rem; animation-delay: 0.4s; font-family: 'Lato', sans-serif;}
      .inicio-content .btn { padding:1rem 3rem;font-size:1.2rem; animation-delay: 0.6s; }
      
      /* --- NUEVO DISE√ëO DE MEN√ö Y TARJETAS --- */
      .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}.menu-card{text-align:center;text-decoration:none;color:var(--text-dark)}.menu-card .icon{font-size:2.5rem;color:var(--primary-color);margin-bottom:1rem; transition: transform 0.3s ease;}.menu-card h3{font-family:'Poppins';font-weight:600;font-size:1.3rem; margin-bottom: 0.5rem;}.menu-card p{font-family: 'Lato', sans-serif; color: var(--text-light);}.menu-card.card:hover{transform:translateY(-10px);box-shadow: 0 12px 40px rgba(0,0,0,0.08);}.menu-card.card:hover .icon{transform: scale(1.1);}

      /* --- NUEVO DISE√ëO PR√ÅCTICA Y CONSEJOS --- */
      #practice-results{margin-top:2rem;display:grid;grid-template-columns:1fr;gap:1.5rem;}.problem-card{background-color:#f9fafb;padding:1.5rem;border-radius:var(--radius); border: 1px solid #e9ecef;}.solution{margin-top:1rem;padding:1rem;background-color:#eaf6f4;border-radius:8px;border-left:4px solid var(--primary-color);}
      #consejos-container .card { text-align: left; }

      /* --- AUTENTICACI√ìN Y CHAT --- */
      #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000; animation: fadeIn 0.3s;}.auth-card{width:100%;max-width:400px;text-align:center}.auth-toggle{margin-bottom:1.5rem;}.auth-toggle button{background:none;border:none;cursor:pointer;padding:0.5rem 1rem;font-size:1.1rem;color:var(--text-light); transition: color 0.2s;}.auth-toggle button.active{font-weight:bold;color:var(--primary-color);border-bottom:2px solid var(--primary-color)}#register-form{display:none;}#auth-feedback{margin-top:1rem;color:red;min-height:1.2em;}.forgot-password{font-size:0.9rem;color:var(--text-light);text-decoration:underline;cursor:pointer;margin-top:1rem;display:inline-block}
      .chat-layout{display:grid;grid-template-columns:300px 1fr;gap:1.5rem;height:75vh;max-height:700px}
    </style>
</head>
<body>
    <section id="view-inicio">
        <div id="particles-js"></div>
        <div class="inicio-content"><h1>Potencia tu Mente</h1><p>Tu viaje al dominio de las matem√°ticas comienza ahora.</p><button id="enter-button" class="btn">Entrar</button></div>
    </section>
    
    <main>
        <div class="container">
            <section id="view-menu" class="page-section card">
                <div class="page-header"><h2>Men√∫ Principal</h2></div>
                <div class="menu-grid">
                    <a href="#view-ia" class="menu-card nav-link card"><div class="icon"><i class="fas fa-robot"></i></div><h3>Tutor IA</h3><p>Resuelve cualquier duda.</p></a>
                    <a href="#view-practice" class="menu-card nav-link card"><div class="icon"><i class="fas fa-pencil-ruler"></i></div><h3>Pr√°ctica con IA</h3><p>Genera problemas para resolver.</p></a>
                    <a href="#view-consejos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-lightbulb"></i></div><h3>Consejos de IA</h3><p>Descubre nuevas estrategias.</p></a>
                    <a href="#view-chat" class="menu-card nav-link card"><div class="icon"><i class="fas fa-comments"></i></div><h3>Aprendamos Juntos</h3><p>Chatea con amigos.</p></a>
                    <a href="#view-quienes-somos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-users"></i></div><h3>Qui√©nes Somos</h3><p>Conoce al equipo.</p></a>
                    <a href="#view-ajustes" class="menu-card nav-link card"><div class="icon"><i class="fas fa-cog"></i></div><h3>Ajustes</h3><p>Personaliza tu experiencia.</p></a>
                </div>
                <button class="btn btn-secondary" id="logout-button" style="display:none; margin: 2rem auto 0; background: #e74c3c; color: white;">Cerrar Sesi√≥n</button>
            </section>
            
            <section id="view-ia" class="page-section">
                <div class="page-header"><h2>Tutor IA</h2><p>Preg√∫ntale cualquier concepto, ejercicio o problema matem√°tico a la IA.</p></div>
                <div class="card"><div class="input-group"><input id="ia-input" type="text" class="input-field" placeholder="Ej: ¬øQu√© es el Teorema de Pit√°goras?" /><button id="ia-button" class="btn">Consultar</button></div><div id="ia-explanation" style="min-height: 200px;"><p style="color: var(--text-light)">Aqu√≠ aparecer√° la explicaci√≥n...</p></div></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>

            <section id="view-practice" class="page-section">
                <div class="page-header"><h2>Pr√°ctica con IA</h2><p>Escribe un tema y la IA crear√° problemas para que practiques.</p></div>
                <div class="card"><div class="input-group"><input id="practice-input" type="text" class="input-field" placeholder="Ej: Ecuaciones de primer grado" /><button id="practice-button" class="btn">Generar Problemas</button></div></div>
                <div id="practice-results"><p style="text-align:center; color: var(--text-light);">Aqu√≠ aparecer√°n los problemas generados...</p></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>

            <section id="view-consejos" class="page-section">
                <div class="page-header"><h2>Consejos de la IA</h2><p>Cada vez que entres, la IA te dar√° nuevos consejos para mejorar.</p></div>
                <div id="consejos-container" class="menu-grid"></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>
            
            <section id="view-chat" class="page-section">
                <div id="auth-overlay">
                    <div class="card auth-card">
                        <div class="auth-toggle"><button id="show-login" class="active">Iniciar Sesi√≥n</button><button id="show-register">Crear Cuenta</button></div>
                        <form id="login-form"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="login-username" class="input-field" placeholder="Nombre de usuario" required><input type="password" id="login-password" class="input-field" placeholder="Contrase√±a" required></div><button type="submit" class="btn">Entrar</button></form>
                        <form id="register-form"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="register-username" class="input-field" placeholder="Nuevo nombre de usuario" required><input type="password" id="register-password" class="input-field" placeholder="Nueva contrase√±a (m√≠n. 4 caracteres)" required minlength="4"></div><button type="submit" class="btn">Registrarme</button></form>
                        <p id="auth-feedback"></p>
                        <a class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
                    </div>
                </div>
                <div class="page-header"><h2>Aprendamos Juntos</h2></div>
                <div class="chat-layout">
                    <aside class="card"><p>Hola, <strong id="your-username" style="color:var(--primary-color)"></strong></p><p style="font-size:0.9em;">Tu c√≥digo: <strong id="your-code" title="Clic para copiar" style="cursor:pointer; user-select:all;"></strong></p><h3 style="margin-top:1.5rem;">Amigos</h3><form id="add-friend-form" class="input-group"><input id="friend-code-input" class="input-field" placeholder="C√≥digo de amigo..." required><button type="submit" class="btn">+</button></form><div id="friends-list"></div></aside>
                    <div class="card chat-window"><h3 id="chat-header">Selecciona un amigo</h3><div id="chat-messages" style="border:1px solid #ddd; padding:1rem; border-radius:var(--radius); flex-grow:1; overflow-y:auto; margin-bottom:1rem;"></div><form id="chat-form" class="input-group"><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled><button type="submit" class="btn" disabled>Enviar</button></form></div>
                </div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>

            <section id="view-quienes-somos" class="page-section">
                <div class="page-header"><h2>Qui√©nes Somos</h2></div>
                <div class="card" id="quienes-somos-container" style="font-family: 'Lato', sans-serif; line-height: 1.8;"></div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>

            <section id="view-ajustes" class="page-section">
                <div class="page-header"><h2>Ajustes</h2></div>
                <div class="card">
                     <!-- Aqu√≠ puedes volver a a√±adir la l√≥gica de ajustes como el cambio de idioma, etc. -->
                     <p>Secci√≥n de ajustes en construcci√≥n.</p>
                </div>
                <button class="btn btn-secondary btn-back">Regresar</button>
            </section>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { currentUser: null, friends: [], activeChat: null, messages: {}, onlineFriends: [] };
        const ui = {
            main: document.querySelector('main'),
            inicio: { view: document.getElementById('view-inicio'), button: document.getElementById('enter-button') },
            logoutButton: document.getElementById('logout-button'),
            sections: document.querySelectorAll('.page-section'),
            navLinks: document.querySelectorAll('.nav-link'),
            backButtons: document.querySelectorAll('.btn-back'),
            ia: { input: document.getElementById('ia-input'), button: document.getElementById('ia-button'), explanation: document.getElementById('ia-explanation') },
            practice: { input: document.getElementById('practice-input'), button: document.getElementById('practice-button'), results: document.getElementById('practice-results') },
            consejos: { container: document.getElementById('consejos-container') },
            auth: { overlay: document.getElementById('auth-overlay'), showLogin: document.getElementById('show-login'), showRegister: document.getElementById('show-register'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), feedback: document.getElementById('auth-feedback'), forgotPassword: document.querySelector('.forgot-password') },
            chat: { yourUsername: document.getElementById('your-username'), yourCode: document.getElementById('your-code'), addForm: document.getElementById('add-friend-form'), friendInput: document.getElementById('friend-code-input'), list: document.getElementById('friends-list'), header: document.getElementById('chat-header'), messages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), sendBtn: document.getElementById('chat-form').querySelector('button') },
            quienes: { container: document.getElementById('quienes-somos-container') }
        };
        const socket = io();
        const quienesSomosText = `<p>Somos un grupo de estudiantes de Educaci√≥n para el Trabajo que hemos creado el proyecto ‚ÄúPotencia tu mente con matem√°ticas‚Äù, una plataforma web dise√±ada para apoyar el aprendizaje de las matem√°ticas de manera sencilla, pr√°ctica e interactiva. Nuestro objetivo es brindar a los estudiantes una herramienta accesible y motivadora que les permita reforzar sus conocimientos y superar las dificultades m√°s comunes en esta √°rea.</p><p>Nos caracterizamos por ser un equipo responsable, creativo y comprometido con la innovaci√≥n educativa. Cada integrante aporta sus ideas, habilidades y talentos, lo que nos permite trabajar de manera colaborativa y complementaria. Nos gu√≠a la convicci√≥n de que la educaci√≥n es la clave para el desarrollo personal y social, y que el uso de la tecnolog√≠a puede convertirse en un aliado poderoso para mejorar los procesos de ense√±anza y aprendizaje.</p><p>A trav√©s de este proyecto, buscamos ofrecer un servicio que no solo ense√±e matem√°ticas, sino que tambi√©n despierte en los estudiantes la confianza y el gusto por aprender. Queremos que ‚ÄúPotencia tu mente con matem√°ticas‚Äù sea un espacio digital donde cada usuario se sienta acompa√±ado en su proceso educativo, encontrando materiales claros, niveles de pr√°ctica graduados y actividades interactivas que hagan del aprendizaje una experiencia din√°mica.</p><p>Creemos firmemente que nuestro esfuerzo contribuir√° al desarrollo acad√©mico de los estudiantes y al fortalecimiento de sus competencias matem√°ticas, demostrando que con constancia, innovaci√≥n y dedicaci√≥n se puede transformar la manera en que aprendemos.</p>`;

        function init() {
            if(document.getElementById('particles-js')) particlesJS('particles-js',{"particles":{"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.5,"random":false},"size":{"value":3,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.4,"width":1},"move":{"enable":true,"speed":6}}});
            setupNavigation();
            setupIA();
            setupPractice();
            setupAuth();
            setupChat();
            ui.quienes.container.innerHTML = quienesSomosText;
            loadState();
        }

        function setupNavigation() {
            ui.inicio.button.addEventListener('click', enterApp);
            ui.navLinks.forEach(link => link.addEventListener('click', handleNav));
            ui.backButtons.forEach(btn => btn.addEventListener('click', () => history.back()));
            window.addEventListener('popstate', () => showView(location.hash.substring(1) || 'view-menu'));
        }
        function enterApp() {
            sessionStorage.setItem('visitedBefore', 'true');
            ui.inicio.view.style.display = 'none';
            ui.main.style.display = 'block';
            history.pushState(null, '', '#view-menu');
            showView('view-menu');
        }
        function handleNav(e) {
            e.preventDefault();
            const viewId = e.currentTarget.getAttribute('href').substring(1);
            if (viewId === 'view-chat' && !state.currentUser) {
                ui.auth.overlay.style.display = 'flex';
                return;
            }
            history.pushState(null, '', `#${viewId}`);
            showView(viewId);
        }
        function showView(viewId) {
            if (sessionStorage.getItem('visitedBefore')) {
                ui.main.style.display = 'block';
                ui.inicio.view.style.display = 'none';
            } else {
                ui.main.style.display = 'none';
                ui.inicio.view.style.display = 'flex';
                return;
            }
            ui.sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(viewId);
            if (activeSection) activeSection.classList.add('active');
            if (viewId === 'view-consejos') generateTips();
        }

        function loadState() {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                ui.logoutButton.style.display = 'block';
                socket.emit('register user', state.currentUser);
            }
            showView(location.hash.substring(1) || 'view-menu');
        }

        function setupAuth() {
            ui.auth.showLogin.addEventListener('click', () => toggleAuthForms(true));
            ui.auth.showRegister.addEventListener('click', () => toggleAuthForms(false));
            ui.auth.loginForm.addEventListener('submit', handleLogin);
            ui.auth.registerForm.addEventListener('submit', handleRegister);
            ui.auth.forgotPassword.addEventListener('click', handleForgotPassword);
            ui.logoutButton.addEventListener('click', handleLogout);
        }
        function toggleAuthForms(showLogin) {
            ui.auth.loginForm.style.display = showLogin ? 'block' : 'none';
            ui.auth.registerForm.style.display = showLogin ? 'none' : 'block';
            ui.auth.showLogin.classList.toggle('active', showLogin);
            ui.auth.showRegister.classList.toggle('active', !showLogin);
            ui.auth.feedback.textContent = '';
        }
        async function handleLogin(e) {
            e.preventDefault();
            const username = ui.auth.loginForm.querySelector('#login-username').value;
            const password = ui.auth.loginForm.querySelector('#login-password').value;
            const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await res.json();
            if (data.success) {
                state.currentUser = data.user;
                sessionStorage.setItem('currentUser', JSON.stringify(data.user));
                ui.auth.overlay.style.display = 'none';
                ui.logoutButton.style.display = 'block';
                socket.emit('register user', state.currentUser);
                history.pushState(null, '', '#view-chat');
                showView('view-chat');
            } else { ui.auth.feedback.textContent = data.message; }
        }
        async function handleRegister(e) {
            e.preventDefault();
            const username = ui.auth.registerForm.querySelector('#register-username').value;
            const password = ui.auth.registerForm.querySelector('#register-password').value;
            const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await res.json();
            if (data.success) {
                alert('¬°Cuenta creada! Ahora puedes iniciar sesi√≥n.');
                toggleAuthForms(true);
            } else { ui.auth.feedback.textContent = data.message; }
        }
        async function handleForgotPassword() {
            const username = prompt('Ingresa tu nombre de usuario para eliminar tu cuenta y poder registrarte de nuevo.');
            if (!username) return;
            if (confirm(`¬øEst√°s seguro? Se eliminar√° tu cuenta y tu lista de amigos permanentemente. Esta acci√≥n no se puede deshacer.`)) {
                const res = await fetch('/api/delete-account', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username }) });
                const data = await res.json();
                alert(data.message);
                if (data.success && state.currentUser && state.currentUser.username === username) {
                    handleLogout();
                }
            }
        }
        function handleLogout() {
            state.currentUser = null;
            sessionStorage.removeItem('currentUser');
            ui.logoutButton.style.display = 'none';
            history.pushState(null, '', '#view-menu');
            showView('view-menu');
        }

        async function getAIResponse(endpoint, body = {}, method = 'POST') {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (method === 'POST') options.body = JSON.stringify(body);
            const button = body.topic ? (endpoint.includes('problems') ? ui.practice.button : ui.ia.button) : null;
            if(button) button.disabled = true;
            try {
                const res = await fetch(endpoint, options);
                const data = await res.json();
                if (res.ok) return data.explanation || data.problems || data.tips;
                return `<p style="color:red;">${data.error || 'Error de la IA.'}</p>`;
            } catch (error) { return `<p style="color:red;">Error de conexi√≥n.</p>`; }
            finally { if(button) button.disabled = false; }
        }
        
        function setupIA() {
            ui.ia.button.addEventListener('click', async () => {
                const topic = ui.ia.input.value;
                if (!topic) return;
                ui.ia.explanation.innerHTML = `<p>Consultando a la IA...</p>`;
                ui.ia.explanation.innerHTML = await getAIResponse('/api/explain-math', { topic });
            });
        }
        function setupPractice() {
            ui.practice.button.addEventListener('click', async () => {
                const topic = ui.practice.input.value;
                if (!topic) return;
                ui.practice.results.innerHTML = `<p style="text-align:center;">Generando problemas sobre ${topic}...</p>`;
                const response = await getAIResponse('/api/generate-problems', { topic });
                ui.practice.results.innerHTML = response;
                ui.practice.results.querySelectorAll('.show-solution-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const solution = btn.previousElementSibling;
                        solution.style.display = solution.style.display === 'none' ? 'block' : 'none';
                        btn.textContent = solution.style.display === 'none' ? 'Ver Respuesta' : 'Ocultar Respuesta';
                    });
                });
            });
        }
        async function generateTips() {
            ui.consejos.container.innerHTML = `<p style="text-align:center;">Generando consejos frescos...</p>`;
            ui.consejos.container.innerHTML = await getAIResponse('/api/generate-tips', {}, 'GET');
        }

        function setupChat() {
            socket.on('online users update', (users) => { state.onlineFriends = users; renderFriends(); });
            socket.on('private message', handleNewMessage);
            ui.chat.addForm.addEventListener('submit', addFriend);
            ui.chat.list.addEventListener('click', (e) => {
                const friendItem = e.target.closest('[data-code]');
                if (friendItem) setActiveChat(friendItem.dataset.code);
            });
            ui.chat.chatForm.addEventListener('submit', sendChatMessage);
        }
        function addFriend(e) {
            e.preventDefault();
            const code = ui.chat.friendInput.value.trim();
            if (!code || code === state.currentUser.code) return;
            socket.emit('add friend', code, (res) => {
                if (res.success && !state.friends.find(f => f.code === res.friend.code)) {
                    state.friends.push(res.friend);
                    renderFriends();
                } else { alert('C√≥digo no v√°lido o amigo ya a√±adido.'); }
            });
            ui.chat.friendInput.value = '';
        }
        function renderFriends() {
            if (!state.currentUser) return;
            ui.chat.yourUsername.textContent = state.currentUser.username;
            ui.chat.yourCode.textContent = state.currentUser.code;
            ui.chat.list.innerHTML = state.friends.map(f => `<div class="card" data-code="${f.code}" style="cursor:pointer; padding: 0.8rem; margin-bottom: 0.5rem; ${f.code === state.activeChat ? 'background-color:#e0e6e8;' : ''}">${f.username}</div>`).join('');
        }
        function setActiveChat(code) {
            state.activeChat = code;
            ui.chat.header.textContent = `Chateando con ${state.friends.find(f=>f.code===code).username}`;
            ui.chat.chatInput.disabled = false; ui.chat.sendBtn.disabled = false;
            renderFriends(); renderMessages();
        }
        function sendChatMessage(e) {
            e.preventDefault();
            const text = ui.chat.chatInput.value.trim();
            if (!text || !state.activeChat) return;
            const message = { id: Date.now(), text };
            socket.emit('private message', { toCode: state.activeChat, message });
            handleNewMessage({ from: state.currentUser.username, message });
            ui.chat.chatInput.value = '';
        }
        function handleNewMessage({ from, message }) {
            const partnerCode = from === state.currentUser.username ? state.activeChat : state.friends.find(f => f.username === from)?.code;
            if (!partnerCode) return;
            state.messages[partnerCode] = state.messages[partnerCode] || [];
            state.messages[partnerCode].push({ from, ...message });
            if (partnerCode === state.activeChat) renderMessages();
        }
        function renderMessages() {
            const chatMessagesDiv = ui.chat.messages;
            chatMessagesDiv.innerHTML = (state.messages[state.activeChat] || []).map(({from, text}) => `<div class="message-bubble ${from === state.currentUser.username ? 'sent' : 'received'}">${text}</div>`).join('');
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        init();
    });
    </script>
</body>
</html>