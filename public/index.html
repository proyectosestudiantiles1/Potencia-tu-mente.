<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="mainTitle">Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      :root{
        --primary-gradient:linear-gradient(90deg, #1abc9c, #16a085);--primary-color:#16a085;--secondary-color:#2c3e50;
        --bg-color:#ecf0f1;--card-bg:#ffffff;--text-dark:#34495e;--text-light:#7f8c8d;
        --shadow:0 10px 30px rgba(0,0,0,0.07);--radius:16px;--online-color:#2ecc71;--offline-color:#bdc3c7;
        --font-base-size:16px;
      }
      body.large-text{--font-base-size:18px;} /* Aumento significativo para accesibilidad */
      body.dark-theme{ /* Tema de alto contraste */
        --primary-gradient:linear-gradient(90deg, #1abc9c, #1dd2af);--primary-color:#1abc9c;--secondary-color:#ecf0f1;
        --bg-color:#2c3e50;--card-bg:#34495e;--text-dark:#ecf0f1;--text-light:#95a5a6;
      }
      *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
      body{font-family:'Lato',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;transition:background-color .3s,color .3s;font-size:var(--font-base-size)}
      
      main{display:none} /* Se controla con JS para evitar FOUC (Flash Of Unstyled Content) */
      .page-section{display:none}.page-section.active{display:block;animation:fadeIn 0.5s ease-in-out forwards}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .container{max-width:1200px;margin:0 auto;padding:2rem}.page-header{margin-bottom:2.5rem;text-align:center}
      .page-header h1{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*2.2);color:var(--secondary-color)}.page-header p{font-size:calc(var(--font-base-size)*1.1);color:var(--text-light);max-width:700px;margin:.5rem auto 0}
      .btn{display:inline-block;padding:.8rem 1.8rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .2s ease,box-shadow .3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-base-size)}.btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(22,160,133,.4)}.btn-secondary{background:#95a5a6;box-shadow:0 4px 15px rgba(0,0,0,.1)}.btn-secondary:hover{background:#7f8c8d}.btn-back{display:block;width:fit-content;margin-top:2.5rem}
      .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);transition:transform .3s,box-shadow .3s, background-color .3s, color .3s}.card:hover{transform:translateY(-8px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
      .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dee2e6;background:var(--bg-color);color:var(--text-dark);border-radius:8px;font-size:var(--font-base-size);transition:border-color .2s,box-shadow .2s}
      .input-field:focus-visible{outline:2px solid var(--primary-color);box-shadow:0 0 0 3px rgba(22,160,133,.2)}
      /* Inicio */#view-inicio{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#1c2541}.inicio-content{animation:fadeIn 2s}.inicio-content h1{font-family:'Poppins',sans-serif;font-size:clamp(3rem, 10vw, 5.5rem);letter-spacing:2px}.inicio-content p{font-size:1.5rem;color:rgba(255,255,255,.8);margin-bottom:2rem}.inicio-content .btn{padding:1rem 3rem;font-size:1.2rem}
      /* Menu */.menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.menu-card{text-align:center;text-decoration:none;color:var(--text-dark);font-size:var(--font-base-size)}.menu-card .icon{font-size:3rem;color:var(--primary-color);margin-bottom:1rem;display:block}.menu-card h3{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.3)}#view-menu{position:relative;overflow:hidden;border-radius:var(--radius);padding:2rem;background-color:var(--bg-color);transition:none}
      #menu-background-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;background-image:linear-gradient(-45deg, #2ecc71, #1abc9c, #3498db, #2c3e50); background-size: 200% 200%; animation:gradientBG 15s ease infinite;}@keyframes gradientBG {0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}}
      /* Conceptos */#concept-detail-container h3{font-size:calc(var(--font-base-size)*1.5);color:var(--primary-color);margin-top:1.5rem}.content-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.5rem}.content-card{cursor:pointer} .content-card h4{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.2)}.content-card p{font-size:var(--font-base-size);}.datalist-suggestions{max-height:150px;overflow-y:auto;border:1px solid #dee2e6;border-top:none;border-radius:0 0 8px 8px;background-color:var(--card-bg);position:absolute;width:100%;z-index:10}.datalist-suggestions option{padding:.5rem 1rem;cursor:pointer}.datalist-suggestions option:hover{background-color:#f1f3f5}
      /* Pr√°ctica */.problem-card{margin-bottom:1.5rem}.problem-card .response-form{margin-top:1rem;display:flex;gap:.5rem}.problem-card .feedback{margin-top:.5rem;padding:.5rem;border-radius:8px;display:none;font-weight:700;font-size:var(--font-base-size)}.problem-card .feedback.correct{background-color:#d4edda;color:#155724}.problem-card .feedback.incorrect{background-color:#f8d7da;color:#721c24}
      /* Chat */.chat-layout{display:grid;grid-template-columns:320px 1fr;gap:1.5rem;height:75vh;max-height:700px}#friends-list{overflow-y:auto;flex-grow:1}
      .friend-item{padding:.8rem 1rem;border-radius:8px;cursor:pointer;margin-bottom:.5rem;display:flex;align-items:center;gap:.75rem;font-weight:500;transition:background-color .2s;font-size:var(--font-base-size)}.friend-item:hover,.friend-item.active{background-color:#e0e6e8}
      .friend-status{width:10px;height:10px;border-radius:50%;background-color:var(--offline-color);transition:background-color .3s}.friend-status.online{background-color:var(--online-color)}.friend-delete{background:none;border:none;color:var(--text-light);cursor:pointer;opacity:0;transition:opacity .2s;margin-left:auto;font-size:calc(var(--font-base-size)*1.2)}.friend-item:hover .friend-delete{opacity:1}
      .chat-window{display:flex;flex-direction:column}.chat-messages{flex-grow:1;border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;overflow-y:auto;margin-bottom:1rem;background:var(--bg-color)}.message-bubble{position:relative;max-width:80%;width:fit-content;padding:.7rem 1.2rem;border-radius:20px;margin-bottom:.75rem;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;font-size:var(--font-base-size)}
      .message-bubble.sent{background:var(--primary-gradient);color:white;margin-left:auto;border-bottom-right-radius:5px}.message-bubble.received{background-color:#e9ecef;color:var(--text-dark);margin-right:auto;border-bottom-left-radius:5px}.message-delete{position:absolute;top:50%;transform:translateY(-50%);right:-25px;background:none;border:none;color:var(--text-light);cursor:pointer;opacity:0;transition:opacity .2s;font-size:var(--font-base-size)}.message-bubble.sent:hover .message-delete{opacity:1}
      /* Username Overlay */#username-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}
      /* Ajustes */.settings-container h3{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.3);color:var(--secondary-color)}.toggle-switch{display:flex;align-items:center;justify-content:space-between;width:100%;margin-top:.5rem}.toggle-switch p{font-size:var(--font-base-size);margin:0}.toggle-switch input{opacity:0;width:0;height:0}
      .slider{position:relative;cursor:pointer;width:50px;height:26px;background-color:#ccc;border-radius:26px;transition:.4s}.slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background-color:white;border-radius:50%;transition:.4s}input:checked+.slider{background-color:var(--primary-color)}input:checked+.slider:before{transform:translateX(24px)}
      /* Accesibilidad */ .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}:focus-visible{outline:3px solid var(--primary-color) !important; outline-offset: 2px;}
    </style>
</head>
<body>
    <section id="view-inicio"><h1 class="sr-only" data-lang-key="mainTitle">Potencia tu Mente - Pantalla de Bienvenida</h1><div id="particles-js" aria-hidden="true"></div><div class="inicio-content" role="dialog" aria-labelledby="welcome-title"><h2 id="welcome-title" data-lang-key="mainTitle">Potencia tu Mente</h2><p data-lang-key="welcomeSlogan">Tu viaje al dominio de las matem√°ticas comienza ahora.</p><a href="#view-menu" class="btn nav-link" role="button" aria-label="Entrar al men√∫ principal" data-lang-key="enterButton">Entrar</a></div></section>
    
    <main><header class="sr-only"><h1>Contenido Principal de Potencia tu Mente</h1></header><div class="container">
        <section id="view-menu" class="page-section card" role="region" aria-labelledby="menu-title"><div class="page-header"><h2 id="menu-title" data-lang-key="menuTitle">Men√∫ Principal</h2></div><div class="menu-grid"><a href="#view-conceptos" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-book-open"></i></div><h3 data-lang-key="conceptsTitle">Conceptos</h3><p data-lang-key="conceptsMenuDesc">Explora todos los temas.</p></a><a href="#view-practica" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-brain"></i></div><h3 data-lang-key="practiceTitle">Pr√°ctica</h3><p data-lang-key="practiceMenuDesc">Ejercicios aleatorios.</p></a><a href="#view-consejos" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-lightbulb"></i></div><h3 data-lang-key="tipsTitle">Consejos</h3><p data-lang-key="tipsMenuDesc">Mejora tus habilidades.</p></a><a href="#view-chat" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-comments"></i></div><h3 data-lang-key="chatTitle">Aprendamos Juntos</h3><p data-lang-key="chatMenuDesc">Resuelve dudas con amigos.</p></a><a href="#view-quienes-somos" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-users"></i></div><h3 data-lang-key="whoTitle">Qui√©nes Somos</h3><p data-lang-key="whoMenuDesc">Conoce al equipo.</p></a><a href="#view-ajustes" class="menu-card nav-link card" role="link"><div class="icon" aria-hidden="true"><i class="fas fa-cog"></i></div><h3 data-lang-key="settingsTitle">Ajustes</h3><p data-lang-key="settingsMenuDesc">Personaliza tu experiencia.</p></a></div></section>
        
        <section id="view-conceptos" class="page-section" role="region" aria-labelledby="conceptos-title"><div class="page-header"><h2 id="conceptos-title" data-lang-key="conceptsTitle">Conceptos Matem√°ticos</h2><p data-lang-key="conceptsPageDesc">Encuentra el tema que necesitas.</p></div><div class="filter-bar" role="search"><label for="concept-search" class="sr-only" data-lang-key="searchConceptLabel">Buscar tema</label><input type="search" id="concept-search" class="input-field" placeholder="Buscar tema..." list="concept-suggestions" aria-autocomplete="list" aria-controls="concept-suggestions" aria-label="Introduce el nombre de un concepto para buscar"></div><datalist id="concept-suggestions"></datalist><div id="concepts-grid" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-concepto-detalle" class="page-section" role="region" aria-labelledby="concepto-detalle-title"><div id="concept-detail-container" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-practica" class="page-section" role="region" aria-labelledby="practica-title"><div class="page-header"><h2 id="practica-title" data-lang-key="practiceTitle">Centro de Pr√°ctica</h2><p id="practice-header" data-lang-key="practicePageDesc">Genera ejercicios y situaciones problem√°ticas.</p></div><div class="filter-bar" role="search"><label for="practice-search" class="sr-only" data-lang-key="searchPracticeLabel">Buscar tema de pr√°ctica</label><input type="search" id="practice-search" class="input-field" placeholder="Buscar tema de pr√°ctica..." list="practice-suggestions" aria-autocomplete="list" aria-controls="practice-suggestions" aria-label="Introduce el nombre de un concepto para practicar"></div><datalist id="practice-suggestions"></datalist><div id="practice-grid" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-consejos" class="page-section" role="region" aria-labelledby="consejos-title"><div class="page-header"><h2 id="consejos-title" data-lang-key="tipsTitle">Consejos para Estudiantes</h2><p data-lang-key="tipsPageDesc">Estrategias para potenciar tu aprendizaje.</p></div><div id="consejos-container" class="content-grid" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-chat" class="page-section" role="region" aria-labelledby="chat-title"><div id="username-overlay" role="dialog" aria-modal="true" aria-labelledby="username-form-title"><div class="card" style="width:100%;max-width:400px;text-align:center;"><h3 id="username-form-title" data-lang-key="chatOverlayTitle">Crea tu Perfil de Estudiante</h3><p style="margin-bottom:1rem;" data-lang-key="chatOverlayDesc">Elige un nombre para mostrar. Se te asignar√° un c√≥digo √∫nico para agregar amigos.</p><form id="username-form" class="input-group"><label for="username-input" class="sr-only" data-lang-key="usernameLabel">Nombre de usuario</label><input type="text" id="username-input" class="input-field" placeholder="TuUsuario123" required minlength="3" aria-describedby="username-info"><span id="username-info" class="sr-only">El nombre de usuario debe tener al menos 3 caracteres.</span><button type="submit" class="btn" data-lang-key="saveAndEnterBtn">Guardar y Entrar</button></form></div></div><div class="page-header"><h2 id="chat-title" data-lang-key="chatTitle">Aprendamos Juntos</h2></div><div class="chat-layout"><aside class="card"><p data-lang-key="helloText">Hola, <strong id="your-username" style="color:var(--primary-color);"></strong></p><p style="font-size: 0.9em; color: var(--text-light); margin-top: -5px;" data-lang-key="yourCodeIsText">Tu c√≥digo de amigo es: <strong id="your-code" title="Clic para copiar" style="cursor: pointer; user-select: all;" aria-label="Tu c√≥digo de amigo, haz clic para copiar"></strong></p><h3 style="margin-top:1.5rem;font-family:'Poppins';" data-lang-key="friendsTitle">Amigos</h3><p style="font-size:0.9em;color:var(--text-light);margin-bottom:1rem;" data-lang-key="friendsDesc">A√±ade amigos usando su c√≥digo √∫nico.</p><form id="add-friend-form" class="input-group"><label for="friend-code-input" class="sr-only" data-lang-key="friendCodeLabel">C√≥digo del amigo</label><input id="friend-code-input" class="input-field" placeholder="C√≥digo del amigo..." required aria-label="Introduce el c√≥digo de amigo"><button type="submit" class="btn" aria-label="A√±adir amigo" data-lang-key="addFriendBtn">+</button></form><div id="friends-list" aria-live="polite"></div></aside><div class="card chat-window" role="log" aria-labelledby="chat-header-title"><h3 id="chat-header" style="font-family:'Poppins';" data-lang-key="selectFriendText">Selecciona un amigo</h3><div class="chat-messages" id="chat-messages" aria-live="polite"></div><form id="chat-form" class="input-group"><label for="chat-input" class="sr-only" data-lang-key="writeMessageLabel">Escribe un mensaje</label><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled aria-label="Escribe tu mensaje aqu√≠"><button type="submit" class="btn" disabled aria-label="Enviar mensaje" data-lang-key="sendButton">Enviar</button></form></div></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-quienes-somos" class="page-section" role="region" aria-labelledby="quienes-somos-title"><div class="page-header"><h2 id="quienes-somos-title" data-lang-key="whoTitle">¬øQui√©nes somos?</h2></div><div class="card" id="quienes-somos-container" style="line-height:1.8;color:var(--text-light);" aria-live="polite"></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
        
        <section id="view-ajustes" class="page-section" role="region" aria-labelledby="ajustes-title"><div class="page-header"><h2 id="ajustes-title" data-lang-key="settingsTitle">Ajustes</h2></div><div class="card"><div class="settings-container" style="display:flex;flex-direction:column;gap:2.5rem;"><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="languageSettingsTitle">Idioma de la Interfaz</h3><select id="language-selector" class="input-field" aria-label="Selector de idioma"><option value="es" data-lang-key="langES">Espa√±ol</option><option value="en" data-lang-key="langEN">English</option><option value="zh" data-lang-key="langZH">‰∏≠Êñá (Chino)</option><option value="de" data-lang-key="langDE">Deutsch (Alem√°n)</option><option value="fr" data-lang-key="langFR">Fran√ßais (Franc√©s)</option><option value="pt">Portugu√™s (Brasil)</option></select></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="accessibilitySettingsTitle">Accesibilidad</h3><div class="toggle-switch"><p data-lang-key="largeTextToggle">Texto m√°s grande</p><label for="font-size-toggle" class="switch" aria-label="Activar texto m√°s grande"><input type="checkbox" id="font-size-toggle" role="switch" aria-checked="false"><span class="slider"></span></label></div><div class="toggle-switch" style="margin-top: 1rem;"><p data-lang-key="contrastToggle">Modo de Alto Contraste</p><label for="contrast-toggle" class="switch" aria-label="Activar modo de alto contraste"><input type="checkbox" id="contrast-toggle" role="switch" aria-checked="false"><span class="slider"></span></label></div></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);" data-lang-key="menuBackgroundSettingsTitle">Fondo del Men√∫</h3><p data-lang-key="uploadBackgroundDesc">Sube una imagen o video local para usar de fondo.</p><input type="file" id="background-upload" accept="image/*,video/*" class="input-field" aria-label="Subir archivo para fondo de men√∫"></div><div><p data-lang-key="pasteUrlBackgroundDesc">O pega un enlace URL.</p><form id="background-url-form" class="input-group"><label for="background-url-input" class="sr-only">URL para fondo de men√∫</label><input type="url" id="background-url-input" class="input-field" placeholder="https://ejemplo.com/imagen.jpg" aria-label="Introduce la URL del fondo del men√∫"><button type="submit" class="btn" data-lang-key="applyButton">Aplicar</button></form></div><div><button id="background-reset" class="btn btn-secondary" aria-label="Quitar fondo personalizado" data-lang-key="resetBackgroundButton">Quitar fondo</button></div></div></div><button class="btn btn-secondary btn-back" aria-label="Regresar a la p√°gina anterior" data-lang-key="backButton">Regresar</button></section>
    </div></main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATABASE & CONTENT ---
        const mathData = {
            Algebra: { 
                nameKey: "algebraName", 
                topicKey: "math", 
                descriptionKey: "algebraDesc", 
                howToKey: "algebraHowTo", 
                typesKey: "algebraTypes", 
                errorsKey: "algebraErrors",
                image: "https://images.unsplash.com/photo-1635070049444-96429a3928a3?w=300&h=150&fit=crop&q=80"
            },
            Geometria: { 
                nameKey: "geometriaName", 
                topicKey: "math", 
                descriptionKey: "geometriaDesc", 
                howToKey: "geometriaHowTo", 
                typesKey: "geometriaTypes", 
                errorsKey: "geometriaErrors",
                image: "https://images.unsplash.com/photo-1558285547-483586a146b9?w=300&h=150&fit=crop&q=80"
            },
            Trigonometria: { 
                nameKey: "trigonometriaName", 
                topicKey: "math", 
                descriptionKey: "trigonometriaDesc", 
                howToKey: "trigonometriaHowTo", 
                typesKey: "trigonometriaTypes", 
                errorsKey: "trigonometriaErrors",
                image: "https://images.unsplash.com/photo-1509228627-129334a62174?w=300&h=150&fit=crop&q=80"
            },
            Funciones: { 
                nameKey: "funcionesName", 
                topicKey: "math", 
                descriptionKey: "funcionesDesc", 
                howToKey: "funcionesHowTo", 
                typesKey: "funcionesTypes", 
                errorsKey: "funcionesErrors",
                image: "https://images.unsplash.com/photo-1579705745811-a32bef7a25a3?w=300&h=150&fit=crop&q=80"
            },
            EstadisticaYProbabilidad: { 
                nameKey: "estadisticaName", 
                topicKey: "math", 
                descriptionKey: "estadisticaDesc", 
                howToKey: "estadisticaHowTo", 
                typesKey: "estadisticaTypes", 
                errorsKey: "estadisticaErrors",
                image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=300&h=150&fit=crop&q=80"
            },
            Calculo: { 
                nameKey: "calculoName", 
                topicKey: "math", 
                descriptionKey: "calculoDesc", 
                howToKey: "calculoHowTo", 
                typesKey: "calculoTypes", 
                errorsKey: "calculoErrors",
                image: "https://plus.unsplash.com/premium_photo-1677553953531-41e2472d8293?w=300&h=150&fit=crop&q=80"
            },
            OperacionesConEnteros: {
                nameKey: "operacionesConEnterosName", topicKey: "math", 
                descriptionKey: "operacionesConEnterosDesc", howToKey: "operacionesConEnterosHowTo", 
                typesKey: "operacionesConEnterosTypes", errorsKey: "operacionesConEnterosErrors",
                image: "https://images.unsplash.com/photo-1596707211993-8472f534148e?w=300&h=150&fit=crop&q=80"
            },
            FraccionesYDecimales: {
                nameKey: "fraccionesYDecimalesName", topicKey: "math",
                descriptionKey: "fraccionesYDecimalesDesc", howToKey: "fraccionesYDecimalesHowTo",
                typesKey: "fraccionesYDecimalesTypes", errorsKey: "fraccionesYDecimalesErrors",
                image: "https://images.unsplash.com/photo-1593560704563-f176a2eb61db?w=300&h=150&fit=crop&q=80"
            },
            EcuacionesCuadraticas: {
                nameKey: "ecuacionesCuadraticasName", topicKey: "math",
                descriptionKey: "ecuacionesCuadraticasDesc", howToKey: "ecuacionesCuadraticasHowTo",
                typesKey: "ecuacionesCuadraticasTypes", errorsKey: "ecuacionesCuadraticasErrors",
                image: "https://images.unsplash.com/photo-1629181197356-943df3132770?w=300&h=150&fit=crop&q=80"
            },
            Matrices: {
                nameKey: "matricesName", topicKey: "math",
                descriptionKey: "matricesDesc", howToKey: "matricesHowTo",
                typesKey: "matricesTypes", errorsKey: "matricesErrors",
                image: "https://images.unsplash.com/photo-1616432422582-824f2b115649?w=300&h=150&fit=crop&q=80"
            }
        };

        const consejosData=[{icon:"fa-brain",titleKey:"tip1Title",textKey:"tip1Text"},{icon:"fa-pencil-alt",titleKey:"tip2Title",textKey:"tip2Text"},{icon:"fa-check-circle",titleKey:"tip3Title",textKey:"tip3Text"},{icon:"fa-chalkboard-teacher",titleKey:"tip4Title",textKey:"tip4Text"},{icon:"fa-lightbulb",titleKey:"tip5Title",textKey:"tip5Text"},{icon:"fa-book",titleKey:"tip6Title",textKey:"tip6Text"},{icon:"fa-users",titleKey:"tip7Title",textKey:"tip7Text"},{icon:"fa-clock",titleKey:"tip8Title",textKey:"tip8Text"},{icon:"fa-question",titleKey:"tip9Title",textKey:"tip9Text"},{icon:"fa-chart-line",titleKey:"tip10Title",textKey:"tip10Text"},{icon:"fa-dumbbell",titleKey:"tip11Title",textKey:"tip11Text"},{icon:"fa-bed",titleKey:"tip12Title",textKey:"tip12Text"}];
        const quienesSomosText=`<p data-lang-key="quienesSomosText1">Somos un grupo de estudiantes de Educaci√≥n para el Trabajo que hemos creado el proyecto ‚ÄúPotencia tu mente con matem√°ticas‚Äù, una plataforma web dise√±ada para apoyar el aprendizaje de las matem√°ticas de manera sencilla, pr√°ctica e interactiva. Nuestro objetivo es brindar a los estudiantes una herramienta accesible y motivadora que les permita reforzar sus conocimientos y superar las dificultades m√°s comunes en esta √°rea.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText2">Nos caracterizamos por ser un equipo responsable, creativo y comprometido con la innovaci√≥n educativa. Cada integrante aporta sus ideas, habilidades y talentos, lo que nos permite trabajar de manera colaborativa y complementaria. Nos gu√≠a la convicci√≥n de que la educaci√≥n es la clave para el desarrollo personal y social, y que el uso de la tecnolog√≠a puede convertirse en un aliado poderoso para mejorar los procesos de ense√±anza y aprendizaje.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText3">A trav√©s de este proyecto, buscamos ofrecer un servicio que no solo ense√±e matem√°ticas, sino que tambi√©n despierte en los estudiantes la confianza y el gusto por aprender. Queremos que ‚ÄúPotencia tu mente con matem√°ticas‚Äù sea un espacio digital donde cada usuario se sienta acompa√±ado en su proceso educativo, encontrando materiales claros, niveles de pr√°ctica graduados y actividades interactivas que hagan del aprendizaje una experiencia din√°mica.</p><p style="margin-top:1rem;" data-lang-key="quienesSomosText4">Creemos firmemente que nuestro esfuerzo contribuir√° al desarrollo acad√©mico de los estudiantes y al fortalecimiento de sus competencias matem√°ticas, demostrando que con constancia, innovaci√≥n y dedicaci√≥n se puede transformar la manera en que aprendemos.</p>`;
        const translations={
            es:{
                mainTitle:"Potencia tu Mente",welcomeSlogan:"Tu viaje al dominio de las matem√°ticas comienza ahora.",enterButton:"Entrar",
                menuTitle:"Men√∫ Principal",conceptsTitle:"Conceptos",conceptsMenuDesc:"Explora todos los temas.",practiceTitle:"Pr√°ctica",practiceMenuDesc:"Ejercicios aleatorios.",tipsTitle:"Consejos",tipsMenuDesc:"Mejora tus habilidades.",chatTitle:"Aprendamos Juntos",chatMenuDesc:"Resuelve dudas con amigos.",whoTitle:"Qui√©nes Somos",whoMenuDesc:"Conoce al equipo.",settingsTitle:"Ajustes",settingsMenuDesc:"Personaliza tu experiencia.",
                conceptsPageDesc:"Encuentra el tema que necesitas.",practicePageDesc:"Genera ejercicios y situaciones problem√°ticas.",tipsPageDesc:"Estrategias para potenciar tu aprendizaje.",
                backButton:"Regresar",usernameLabel:"Nombre de usuario", chatOverlayTitle:"Crea tu Perfil de Estudiante",chatOverlayDesc:"Elige un nombre para mostrar. Se te asignar√° un c√≥digo √∫nico para agregar amigos.",
                saveAndEnterBtn:"Guardar y Entrar", helloText:"Hola",yourCodeIsText:"Tu c√≥digo de amigo es:",friendsTitle:"Amigos",friendsDesc:"A√±ade amigos usando su c√≥digo √∫nico.",friendCodeLabel:"C√≥digo del amigo",addFriendBtn:"+",
                selectFriendText:"Selecciona un amigo",writeMessageLabel:"Escribe un mensaje",sendButton:"Enviar",copyCodeAlert:"¬°C√≥digo de amigo copiado!",
                languageSettingsTitle:"Idioma de la Interfaz", accessibilitySettingsTitle:"Accesibilidad", largeTextToggle:"Texto m√°s grande", contrastToggle:"Modo de Alto Contraste",
                menuBackgroundSettingsTitle:"Fondo del Men√∫", uploadBackgroundDesc:"Sube una imagen o video local para usar de fondo.",pasteUrlBackgroundDesc:"O pega un enlace URL.",applyButton:"Aplicar",resetBackgroundButton:"Quitar fondo",
                noConceptsFoundText:"No se encontraron temas.",noPracticeFoundText:"No hay ejercicios para este tema.",conceptNotFoundText:"Concepto no encontrado.",noPracticeForTopicText:"No se pudo generar un problema √∫nico para este tema.",
                exerciseText:"Ejercicio",problemText:"Situaci√≥n Problem√°tica",yourAnswerText:"Tu respuesta",typeYourAnswerPlaceholder:"Escribe tu respuesta...",checkAnswerButton:"Comprobar",
                correctAnswerText:"¬°Correcto!",incorrectAnswerText:"Incorrecto. La respuesta era",solveTogetherButton:"Resolvamoslo Juntos",selectFriendShareProblemAlert:"Selecciona un amigo para compartirle el problema.",
                deleteFriendAriaLabel:"Eliminar amigo",confirmDeleteFriendText:"¬øSeguro que quieres eliminar a este amigo?",confirmDeleteMessageText:"¬øSeguro que quieres eliminar este mensaje?",
                youText: "T√∫", statusOnline: "Conectado", statusOffline: "Desconectado",
                descriptionTitle:"Descripci√≥n", howToTitle:"¬øC√≥mo se resuelve?", typesTitle:"Tipos Comunes", errorsTitle:"Errores Frecuentes", practiceButton:"Practiquemos", startButton:"Comenzar",
                // Concept specific
                algebraName:"√Ålgebra",math:"Matem√°ticas",algebraDesc:"El √°lgebra estudia estructuras y reglas usando s√≠mbolos para representar valores desconocidos. Es la ciencia de las ecuaciones y expresiones.",algebraHowTo:"Se busca despejar la inc√≥gnita (como 'x'). Los t√©rminos se mueven entre los lados de una igualdad invirtiendo su operaci√≥n (suma a resta, multiplicaci√≥n a divisi√≥n) para aislar la variable.",algebraTypes:"Elemental (ecuaciones lineales), Lineal (vectores, matrices), Abstracta (grupos, anillos).",algebraErrors:"Distribuir mal un signo negativo, no respetar la jerarqu√≠a de operaciones, fallos en leyes de exponentes (ej. (a+b)¬≤ ‚â† a¬≤+b¬≤).",
                geometriaName:"Geometr√≠a",geometriaDesc:"Es la rama que estudia las propiedades del espacio, como puntos, l√≠neas, figuras y s√≥lidos.",geometriaHowTo:"Se aplica mediante el uso de teoremas y f√≥rmulas para calcular propiedades como √°rea, per√≠metro, volumen y √°ngulos. La visualizaci√≥n es clave.",geometriaTypes:"Plana (2D), del Espacio (3D), Anal√≠tica (con coordenadas).",geometriaErrors:"Confundir la f√≥rmula del per√≠metro con la del √°rea, errores de unidades (cm vs m), olvidar pasos (como el ¬Ω en el √°rea del tri√°ngulo).",
                trigonometriaName:"Trigonometr√≠a",trigonometriaDesc:"Estudia las relaciones entre los √°ngulos y los lados de los tri√°ngulos, bas√°ndose en las razones trigonom√©tricas (seno, coseno, tangente).",trigonometriaHowTo:"Se identifican los catetos (opuesto, adyacente) y la hipotenusa en un tri√°ngulo rect√°ngulo para aplicar las razones y resolver por √°ngulos o lados desconocidos.",trigonometriaTypes:"Plana, Esf√©rica, funciones inversas (arcoseno).",trigonometriaErrors:"Identificar incorrectamente el cateto opuesto y adyacente, confundir grados con radianes.",
                funcionesName:"Funciones",funcionesDesc:"Una funci√≥n es una regla que asocia a cada valor de entrada (x) un √∫nico valor de salida (y). Se escribe como y = f(x).",funcionesHowTo:"Se eval√∫a la funci√≥n sustituyendo la variable 'x' por un n√∫mero para encontrar 'y'. Se analizan su dominio y rango.",funcionesTypes:"Lineales, cuadr√°ticas, exponenciales, logar√≠tmicas.",funcionesErrors:"Confundir dominio y rango, no pasar la 'prueba de la l√≠nea vertical'.",
                estadisticaName:"Estad√≠stica y Probabilidad",estadisticaDesc:"La estad√≠stica recolecta, analiza e interpreta datos. La probabilidad mide la certeza de que ocurra un evento.",estadisticaHowTo:"La estad√≠stica usa medidas como media, mediana y moda. La probabilidad se calcula como (casos favorables) / (casos totales).",estadisticaTypes:"Descriptiva, Inferencial. Probabilidad Cl√°sica, Frecuencial.",estadisticaErrors:"Confundir correlaci√≥n con causalidad, confundir media con mediana.",
                calculoName:"C√°lculo",calculoDesc:"Rama que estudia el cambio continuo. La derivada mide la tasa de cambio instant√°nea y la integral calcula acumulados.",calculoHowTo:"Se aplican reglas de derivaci√≥n e integraci√≥n para encontrar la pendiente de una curva o el √°rea bajo ella.",calculoTypes:"Diferencial (derivadas) e Integral (integrales).",calculoErrors:"Dificultad con el concepto de l√≠mite, confundir las reglas de derivaci√≥n, olvidar la constante de integraci√≥n.",
                operacionesConEnterosName: "Operaciones con Enteros", operacionesConEnterosDesc: "Aprende a sumar, restar, multiplicar y dividir n√∫meros positivos y negativos, un pilar fundamental de la matem√°tica.", operacionesConEnterosHowTo: "Se utiliza la regla de los signos. Para sumas y restas, signos iguales se suman y mantienen el signo; signos diferentes se restan y se usa el signo del mayor. Para multiplicaci√≥n y divisi√≥n, signos iguales dan positivo (+), signos diferentes dan negativo (-).", operacionesConEnterosTypes: "Suma, resta, multiplicaci√≥n, divisi√≥n y potencias.", operacionesConEnterosErrors: "Olvidar la regla de los signos, especialmente al restar un n√∫mero negativo (ej. 5 - (-3) = 8).",
                fraccionesYDecimalesName: "Fracciones y Decimales", fraccionesYDecimalesDesc: "Representan partes de un todo. Es clave para entender proporciones y porcentajes.", fraccionesYDecimalesHowTo: "Para sumar o restar fracciones, deben tener un denominador com√∫n. La multiplicaci√≥n es directa (numerador por numerador). Para dividir, se multiplica en cruz.", fraccionesYDecimalesTypes: "Propias, impropias, mixtas. Decimales exactos y peri√≥dicos.", fraccionesYDecimalesErrors: "Sumar o restar sin encontrar el denominador com√∫n. Confundir la multiplicaci√≥n con la suma.",
                ecuacionesCuadraticasName: "Ecuaciones Cuadr√°ticas", ecuacionesCuadraticasDesc: "Ecuaciones donde la inc√≥gnita est√° elevada al cuadrado. Pueden tener hasta dos soluciones.", ecuacionesCuadraticasHowTo: "Se resuelven usando la f√≥rmula general (la resolvente) o factorizando la expresi√≥n.", ecuacionesCuadraticasTypes:"Completas (ax¬≤ + bx + c = 0) e incompletas.", ecuacionesCuadraticasErrors:"Calcular mal el discriminante (b¬≤ - 4ac) en la f√≥rmula general.",
                matricesName: "Matrices", matricesDesc: "Las matrices son arreglos rectangulares de n√∫meros. Se usan para representar sistemas de ecuaciones lineales y transformaciones geom√©tricas.", matricesHowTo: "Se operan con sumas, restas, multiplicaci√≥n por escalar y multiplicaci√≥n entre matrices, siguiendo reglas espec√≠ficas de dimensiones.", matricesTypes: "Fila, columna, nula, cuadrada, identidad, transpuesta.", matricesErrors: "Intentar sumar/restar matrices de diferente dimensi√≥n; multiplicar matrices con dimensiones incompatibles.",
                // Environmental phrases
                waterConsumptionProblem: "Una comunidad consume [CONSUMO]L de agua/d√≠a. Si reducen el consumo en [REDUCCION]% por [DIAS] d√≠as, ¬øcu√°ntos litros ahorran?",
                plasticWasteProblem: "[FAMILIAS] familias producen [PLASTICO] kg de pl√°stico/semana. Si el [RECICLA]% es reciclado, ¬øcu√°nto pl√°stico se recicla en [SEMANAS] semanas?",
                deforestationProblem: "[ARBOLES] √°rboles por deforestaci√≥n en [HECTAREAS] hect√°reas. ¬øCu√°ntos √°rboles hay por hect√°rea? (redondea a 2 decimales)",
                // Accessibility specific
                searchConceptPlaceholder: "Buscar tema...", searchPracticePlaceholder: "Buscar tema de pr√°ctica...", usernamePlaceholder: "TuUsuario123", friendCodePlaceholder: "C√≥digo del amigo...", typeYourAnswerPlaceholder: "Escribe tu respuesta...",
                searchConceptLabel: "Introduce el nombre de un tema para buscar", searchPracticeLabel: "Introduce el nombre de un tema para practicar",
            },
            en:{mainTitle:"Power Up Your Mind",menuTitle:"Main Menu",conceptsTitle:"Concepts",practiceTitle:"Practice",tipsTitle:"Tips",chatTitle:"Let's Learn Together",whoTitle:"Who We Are",settingsTitle:"Settings",welcomeSlogan:"Your journey to math mastery starts now.",enterButton:"Enter",backButton:"Back",conceptsPageDesc:"Find the topic you need.",practicePageDesc:"Generate random exercises and problems.",tipsPageDesc:"Strategies to boost your learning.",usernameLabel:"Username",chatOverlayTitle:"Create Your Student Profile",chatOverlayDesc:"Choose a display name. You will be assigned a unique code to add friends.",saveAndEnterBtn:"Save & Enter",helloText:"Hello",yourCodeIsText:"Your friend code is:",friendsTitle:"Friends",friendsDesc:"Add friends using their unique code.",friendCodeLabel:"Friend code",addFriendBtn:"+",selectFriendText:"Select a friend",writeMessageLabel:"Write a message",sendButton:"Send",copyCodeAlert:"Friend code copied!",languageSettingsTitle:"Interface Language",accessibilitySettingsTitle:"Accessibility",largeTextToggle:"Larger Text",contrastToggle:"High Contrast Mode",menuBackgroundSettingsTitle:"Menu Background",uploadBackgroundDesc:"Upload a local image or video to use as background.",pasteUrlBackgroundDesc:"Or paste a URL link.",applyButton:"Apply",resetBackgroundButton:"Remove background",noConceptsFoundText:"No concepts found.",noPracticeFoundText:"No exercises found for this topic.",conceptNotFoundText:"Concept not found.",noPracticeForTopicText:"Could not generate a unique problem for this topic.",exerciseText:"Exercise",problemText:"Problem Situation",yourAnswerText:"Your answer",typeYourAnswerPlaceholder:"Type your answer...",checkAnswerButton:"Check",correctAnswerText:"Correct!",incorrectAnswerText:"Incorrect. The answer was",solveTogetherButton:"Let's Solve Together",selectFriendShareProblemAlert:"Select a friend to share the problem with.",deleteFriendAriaLabel:"Delete friend",confirmDeleteFriendText:"Are you sure you want to delete this friend?",confirmDeleteMessageText:"Are you sure you want to delete this message?",youText: "You", statusOnline: "Online", statusOffline: "Offline",
                algebraName:"Algebra",math:"Mathematics",algebraDesc:"Algebra studies structures and rules using symbols to represent unknown values.",algebraHowTo:"The goal is to isolate the unknown (like 'x') by moving terms across an equality, inverting operations (addition to subtraction, multiplication to division).",algebraTypes:"Elementary (linear equations), Linear (vectors), Abstract (groups).",algebraErrors:"Incorrectly distributing a negative sign, not respecting the order of operations, exponent law mistakes (e.g. (a+b)¬≤ ‚â† a¬≤+b¬≤).",
                geometriaName:"Geometry",geometriaDesc:"Branch that studies the properties of space, like points, lines, and figures.",geometriaHowTo:"It is applied through the use of theorems and formulas to calculate properties like area, perimeter, volume, and angles. Visualization is key.",geometriaTypes:"Plane (2D), Space (3D), Analytical (with coordinates).",geometriaErrors:"Confusing the perimeter formula with the area formula, unit errors (cm vs m), forgetting steps (like ¬Ω in the area of a triangle).",
                trigonometriaName:"Trigonometry",trigonometriaDesc:"Studies the relationships between angles and sides of triangles, based on trigonometric ratios (sine, cosine, tangent).",trigonometriaHowTo:"Identify the opposite and adjacent legs and the hypotenuse in a right triangle to apply the ratios and solve for unknown angles or sides.",trigonometriaTypes:"Plane, Spherical, inverse functions (arcsin).",trigonometriaErrors:"Incorrectly identifying the opposite and adjacent legs, confusing degrees with radians.",
                funcionesName:"Functions",funcionesDesc:"A function is a rule that associates each input (x) with a single output (y). It is written as y = f(x).",funcionesHowTo:"The function is evaluated by substituting the variable 'x' with a given number to find 'y'. Its domain and range are also analyzed.",funcionesTypes:"Linear, quadratic, exponential, logarithmic.",funcionesErrors:"Confusing domain and range, failing the 'vertical line test'.",
                estadisticaName:"Statistics & Probability",estadisticaDesc:"Statistics collects, analyzes, and interprets data. Probability measures the certainty of an event occurring.",estadisticaHowTo:"Statistics uses measures like mean, median, and mode. Probability is calculated as (favorable cases) / (total cases).",estadisticaTypes:"Descriptive, Inferential. Classical, Frequential, Conditional Probability.",estadisticaErrors:"Confusing correlation with causation, confusing mean with median.",
                calculoName:"Calculus",calculoDesc:"Branch that studies continuous change. The derivative measures the instantaneous rate of change and the integral calculates accumulated values.",calculoHowTo:"Apply differentiation and integration rules to find the slope of a curve or the area under it.",calculoTypes:"Differential (derivates) and Integral (integrals).",calculoErrors:"Difficulty with the concept of limit, confusing differentiation rules, forgetting the constant of integration.",
                operacionesConEnterosName:"Operations with Integers",operacionesConEnterosDesc:"Learn to add, subtract, multiply, and divide positive and negative numbers, a fundamental pillar of mathematics.",operacionesConEnterosHowTo:"Use the rule of signs: same signs yield positive (+), different signs yield negative (-). For sums, same signs are added, different signs are subtracted with the sign of the larger number. For multiplication and division, same signs yield positive (+), different signs yield negative (-).",operacionesConEnterosTypes:"Addition, subtraction, multiplication, division, and powers.",operacionesConEnterosErrors:"Forgetting the rule of signs, especially when subtracting a negative number (e.g. 5 - (-3) = 8).",
                fraccionesYDecimalesName:"Fractions and Decimals",fraccionesYDecimalesDesc:"Represent parts of a whole. Key to understanding proportions and percentages.",fraccionesYDecimalesHowTo:"To add or subtract fractions, find a common denominator. Multiplication is direct (numerator by numerator). For division, cross-multiply.",fraccionesYDecimalesTypes:"Proper, improper, mixed. Exact and periodic decimals.",fraccionesYDecimalesErrors:"Adding or subtracting without finding the common denominator. Confusing multiplication with addition.",
                ecuacionesCuadraticasName:"Quadratic Equations",ecuacionesCuadraticasDesc:"Equations where the unknown is squared. They can have up to two solutions.",ecuacionesCuadraticasHowTo:"They are solved using the general formula (quadratic formula) or by factoring the expression.",ecuacionesCuadraticasTypes:"Complete (ax¬≤ + bx + c = 0) and incomplete.",ecuacionesCuadraticasErrors:"Incorrectly calculating the discriminant (b¬≤ - 4ac) in the general formula.",
                matricesName:"Matrices",matricesDesc:"Matrices are rectangular arrays of numbers. They are used to represent systems of linear equations and geometric transformations.",matricesHowTo:"They are operated with additions, subtractions, scalar multiplication, and matrix multiplication, following specific dimension rules.",matricesTypes:"Row, column, null, square, identity, transpose.",matricesErrors:"Attempting to add/subtract matrices of different dimensions; multiplying matrices with incompatible dimensions."
            },
            zh: { /* Simplified Chinese translations */ }, de: { /* Simplified German translations */ }, fr: { /* Simplified French translations */ }, pt: { /* Simplified Portuguese translations */ }
        };

        const state={myUsername:localStorage.getItem('myUsername'),myCode:localStorage.getItem('myCode'),friends:JSON.parse(localStorage.getItem('myFriends'))||[],activeChat:null,messages:JSON.parse(localStorage.getItem('myMessages'))||{},onlineFriends:[]};
        const ui={main:document.querySelector('main'),inicio:document.getElementById('view-inicio'),sections:document.querySelectorAll('.page-section'),navLinks:document.querySelectorAll('.nav-link'),backButtons:document.querySelectorAll('.btn-back'),chat:{overlay:document.getElementById('username-overlay'),form:document.getElementById('username-form'),input:document.getElementById('username-input'),yourUsername:document.getElementById('your-username'),yourCode:document.getElementById('your-code'),addForm:document.getElementById('add-friend-form'),friendInput:document.getElementById('friend-code-input'),list:document.getElementById('friends-list'),header:document.getElementById('chat-header'),messages:document.getElementById('chat-messages'),chatForm:document.getElementById('chat-form'),chatInput:document.getElementById('chat-input'),sendBtn:document.getElementById('chat-form').querySelector('button')},concepts:{grid:document.getElementById('concepts-grid'),search:document.getElementById('concept-search'),suggestions:document.getElementById('concept-suggestions'),detail:document.getElementById('concept-detail-container')},practice:{header:document.getElementById('practice-header'),grid:document.getElementById('practice-grid'),search:document.getElementById('practice-search'),suggestions:document.getElementById('practice-suggestions')},consejos:{container:document.getElementById('consejos-container')},quienes:{container:document.getElementById('quienes-somos-container')},ajustes:{lang:document.getElementById('language-selector'),bgUpload:document.getElementById('background-upload'),bgUrlForm:document.getElementById('background-url-form'),bgUrlInput:document.getElementById('background-url-input'),bgReset:document.getElementById('background-reset'),fontSizeToggle:document.getElementById('font-size-toggle'),contrastToggle:document.getElementById('contrast-toggle'),fontSizeIndicator:document.getElementById('font-size-indicator')}};
        const socket=io();
        
        function setupApp() {
            setupNavigation();
            setupChat();
            setupConcepts();
            setupPractice();
            setupConsejos();
            setupSettings();
            renderStaticContent();
        }
        
        // --- NAVIGATION ---
        function setupNavigation(){
            ui.navLinks.forEach(link=>link.addEventListener('click',handleNav));
            ui.backButtons.forEach(btn=>btn.addEventListener('click',()=>history.back()));
            window.addEventListener('popstate',()=>showView(location.hash,history.state));
        }
        function handleNav(e){e.preventDefault();const href=e.currentTarget.getAttribute('href');history.pushState({},'',href);sessionStorage.setItem('visitedBefore','true');showView(href);}
        
        function showView(hash,data){
            let viewId = hash ? hash.substring(1) : (sessionStorage.getItem('visitedBefore') ? 'view-menu' : 'view-inicio');
            
            // Critical fix: Ensure document.body is visible before manipulating other elements.
            document.body.style.display = 'block'; // Ensure body is visible to prevent blank page at any cost

            // Determine actual view based on logic
            if (viewId === '') viewId = 'view-menu'; // Default to menu if hash is empty

            // Adjust main visibility early, for splash screen
            if (viewId === 'view-inicio') {
                ui.main.style.display = 'none';
                ui.inicio.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Hide scroll for splash
            } else {
                ui.main.style.display = 'block';
                ui.inicio.style.display = 'none';
                document.body.style.overflow = 'auto'; // Enable scroll for content
            }
            
            ui.sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(viewId);
            if (activeSection) { activeSection.classList.add('active'); } else { document.getElementById('view-menu').classList.add('active'); viewId='view-menu'; } // Fallback to menu if invalid hash
            
            // Re-apply translations for new content or changed view
            applyTranslations(localStorage.getItem('appLanguage') || 'es');

            // View-specific initialization/rendering
            if (viewId === 'view-conceptos') renderConcepts();
            if (viewId === 'view-practica') {
                if (data?.topicId) { // Direct practice for a specific topic
                    ui.practice.search.value = getTranslatedText(mathConcepts[data.topicId]?.nameKey || "");
                    // This will implicitly call generatePracticeContent as renderPracticeSearch re-renders content
                } else {
                    ui.practice.search.value = ""; // Clear search if not coming from a specific topic
                }
                renderPracticeSearch(data?.topicId); // Always render practice search / content
            }
            if (viewId === 'view-concepto-detalle' && data?.topicId) renderConceptDetail(data.topicId);
            if (viewId === 'view-chat') handleChatEntry(data);
            if (viewId === 'view-ajustes') initSettingsDisplay();
            
            // Hide keyboard on mobile after navigation
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }
        }

        function showInitialView(){
            // Determine initial view (splash screen vs menu)
            const initialHash = location.hash;
            if (!sessionStorage.getItem('visitedBefore') && initialHash !== '#view-menu') {
                showView('#view-inicio');
            } else {
                showView(initialHash || '#view-menu');
            }
        }

        // --- CHAT LOGIC ---
        function setupChat(){
            initUser();
            ui.chat.form.addEventListener('submit',handleUsernameRegister);
            ui.chat.yourCode.addEventListener('click',copyUserCode);
            ui.chat.addForm.addEventListener('submit',addFriend);
            ui.chat.list.addEventListener('click',handleFriendListClick);
            ui.chat.chatForm.addEventListener('submit',sendChatMessage);
            ui.chat.messages.addEventListener('click',handleMessageDelete);
            
            // Socket listeners
            socket.on('private message',handleNewMessage);
            socket.on('online users update',updateOnlineFriends);
            socket.on('system message',displaySystemMessage);

            // Re-render friends on initial connect in case state was already populated from localStorage
            socket.on('connect', () => { 
                if (state.myUsername) { // If user is already stored locally, try to re-register
                    socket.emit('register user', state.myUsername, res => {
                        if (res.success) { 
                            ui.chat.yourUsername.textContent = state.myUsername; 
                            ui.chat.yourCode.textContent = state.myCode; 
                            renderFriends(); // Re-render friends list with latest online status
                        }
                    });
                }
            });
        }

        function initUser(){
            if(state.myUsername&&state.myCode){
                ui.chat.overlay.style.display='none';
                socket.emit('register user',state.myUsername,res=>{
                    if(res.success){
                        ui.chat.yourUsername.textContent=state.myUsername;
                        ui.chat.yourCode.textContent=state.myCode;
                        renderFriends();
                    } else {
                        alert(getTranslatedText('usernameTakenAlert', res.message)); // Use server message if specific
                        localStorage.clear(); // Clear local data on registration failure to force re-prompt
                        state.myUsername = null;
                        state.myCode = null;
                        initUser(); // Re-prompt user
                    }
                });
            }else{ui.chat.overlay.style.display='flex';}
        }
        function handleUsernameRegister(e){e.preventDefault();const name=ui.chat.input.value.trim();if(name.length<3)return alert(getTranslatedText('usernameMinLengthAlert'));socket.emit('register user',name,res=>{if(res.success){state.myUsername=res.username;state.myCode=res.userCode;localStorage.setItem('myUsername',state.myUsername);localStorage.setItem('myCode',state.myCode);initUser();}else{alert(getTranslatedText('usernameTakenAlert', res.message));}});}
        function copyUserCode(){navigator.clipboard.writeText(state.myCode).then(()=>alert(getTranslatedText('copyCodeAlert'))); }
        function addFriend(e){e.preventDefault();const code=ui.chat.friendInput.value.trim();if(code&&code!==state.myCode&&!state.friends.find(f=>f.code===code)){socket.emit('add friend',code,res=>{if(res.success){state.friends.push(res);localStorage.setItem('myFriends',JSON.stringify(state.friends));renderFriends();}else{alert(getTranslatedText('friendNotFoundAlert', res.message));}});}
        ui.chat.friendInput.value='';}
        function renderFriends(){
            ui.chat.list.innerHTML='';
            state.friends.forEach(f=>{
                const el=document.createElement('div');
                el.className='friend-item';
                el.dataset.code=f.code;
                el.dataset.username=f.username; // Added for convenience
                const isOnline=state.onlineFriends.includes(f.username);
                el.innerHTML=`
                    <div class="friend-info" style="display:flex;align-items:center;gap:0.75rem;">
                        <span class="friend-status ${isOnline?'online':''}" aria-label="${isOnline ? getTranslatedText('statusOnline') : getTranslatedText('statusOffline')}"></span>
                        <span class="sr-only">${isOnline ? getTranslatedText('statusOnline') : getTranslatedText('statusOffline')}</span>
                        <span>${f.username}</span>
                    </div>
                    <button class="friend-delete" title="${getTranslatedText('deleteFriendAriaLabel')}" aria-label="${getTranslatedText('deleteFriendAriaLabel')} ${f.username}">&times;</button>
                `;
                if(f.code===state.activeChat)el.classList.add('active');
                ui.chat.list.appendChild(el);
            });
        }
        function setActiveChat(code){const friend=state.friends.find(f=>f.code===code);if(friend){state.activeChat=code;ui.chat.header.textContent=`${getTranslatedText('chatWithText')} ${friend.username}`;ui.chat.chatInput.disabled=false;ui.chat.sendBtn.disabled=false;renderFriends();renderMessages();ui.chat.chatInput.focus();}}
        function handleFriendListClick(e){const friendItem=e.target.closest('.friend-item');if(e.target.matches('.friend-delete')){const code=friendItem.dataset.code;const friendName=friendItem.dataset.username;if(confirm(`${getTranslatedText('confirmDeleteFriendText')} ${friendName}?`)){deleteFriend(code);}}else if(friendItem){setActiveChat(friendItem.dataset.code);}}
        function deleteFriend(codeToDelete) { // Centralized delete friend logic
            state.friends = state.friends.filter(f => f.code !== codeToDelete);
            localStorage.setItem('myFriends', JSON.stringify(state.friends));
            if (state.activeChat === codeToDelete) {
                state.activeChat = null;
                ui.chat.header.textContent = getTranslatedText('selectFriendText');
                ui.chat.chatInput.disabled = true;
                ui.chat.sendBtn.disabled = true;
            }
            renderFriends();
            renderMessages();
        }
        function sendChatMessage(e){e.preventDefault();const msgText = ui.chat.chatInput.value.trim();if(msgText&&state.activeChat){const message={id:Date.now(),text:msgText};socket.emit('private message',{toCode:state.activeChat,message});handleNewMessage(state.myUsername,message,true);}
        ui.chat.chatInput.value='';}
        function handleNewMessage(from,message,self=false){const friend=state.friends.find(f=>f.username===from);const partnerCode=self?state.activeChat:(friend?friend.code:null);if(partnerCode){if(!state.messages[partnerCode])state.messages[partnerCode]=[];state.messages[partnerCode].push({from:from,id:message.id,text:message.text});localStorage.setItem('myMessages',JSON.stringify(state.messages));if(partnerCode===state.activeChat)renderMessages();}}
        function updateOnlineFriends(users){state.onlineFriends=users;renderFriends();}
        function displaySystemMessage({recipient,text}){if(state.activeChat===recipient){const el=document.createElement('p');el.style.textAlign='center';el.style.color='var(--text-light)';el.textContent=text;ui.chat.messages.appendChild(el);}}
        function renderMessages(){ui.chat.messages.innerHTML='';if(state.activeChat&&state.messages[state.activeChat]){state.messages[state.activeChat].forEach(({from,id,text})=>{const bubble=document.createElement('div');bubble.className=`message-bubble ${from===state.myUsername?'sent':'received'}`;bubble.innerHTML=`<span class="sr-only">${from === state.myUsername ? getTranslatedText('youText') : from}: </span><span>${text.replace(/\n/g,'<br>')}</span>`;if(from===state.myUsername){const delBtn=document.createElement('button');delBtn.className='message-delete';delBtn.innerHTML='&times;';delBtn.dataset.id=id;delBtn.setAttribute('aria-label', getTranslatedText('deleteMessageAriaLabel'));bubble.appendChild(delBtn);}
                ui.chat.messages.appendChild(bubble);});ui.chat.messages.scrollTop=ui.chat.messages.scrollHeight;}}
        function handleMessageDelete(e){if(e.target.matches('.message-delete')){const messageId=Number(e.target.dataset.id);if(confirm(getTranslatedText('confirmDeleteMessageText'))){state.messages[state.activeChat]=state.messages[state.activeChat].filter(msg=>msg.id!==messageId);localStorage.setItem('myMessages',JSON.stringify(state.messages));renderMessages();}}}
        function handleChatEntry(data){initUser();if(data?.problem){setTimeout(()=>{alert(getTranslatedText('selectFriendShareProblemAlert'));ui.chat.chatInput.value=data.problem;history.replaceState({},'',location.pathname+location.hash);},500);}}
        
        // --- CONCEPTS LOGIC ---
        function setupConcepts(){
            ui.concepts.search.addEventListener('input',renderConcepts);
            // Fill datalist suggestions
            Object.keys(mathData).forEach(key => {
                const option = document.createElement('option');
                option.value = getTranslatedText(mathData[key].nameKey);
                ui.concepts.suggestions.appendChild(option);
            });
            renderConcepts(); // Initial render
        }
        
        function renderConcepts(){
            const term = ui.concepts.search.value.toLowerCase();
            ui.concepts.grid.innerHTML='';
            let conceptsToRender = Object.keys(mathData);

            // Filter based on search term
            const filteredKeys = conceptsToRender.filter(key => 
                getTranslatedText(mathData[key].nameKey).toLowerCase().includes(term) ||
                getTranslatedText(mathData[key].topicKey).toLowerCase().includes(term)
            );
            
            if(filteredKeys.length===0){ui.concepts.grid.innerHTML=`<p class="card" data-lang-key="noConceptsFoundText"></p>`;applyTranslations(); return;}

            // Render cards
            filteredKeys.forEach(key => {
                const item=mathData[key];
                const card=document.createElement('div'); card.className='content-card card';
                card.setAttribute('role', 'article'); 
                card.setAttribute('tabindex', '0'); 
                card.setAttribute('aria-labelledby', `concept-name-${key}`);
                card.innerHTML=`<h4 id="concept-name-${key}" data-lang-key="${item.nameKey}"></h4><p data-lang-key="${item.topicKey}"></p>`;
                card.addEventListener('click',()=>{history.pushState({topicId:key},'','#view-concepto-detalle');showView('#view-concepto-detalle',{topicId:key});});
                ui.concepts.grid.appendChild(card);
            });
            applyTranslations(); // Translate newly rendered content
        }
        
        function renderConceptDetail(topicId){
            const item=mathData[topicId];
            if(!item){ui.concepts.detail.innerHTML=`<p class="card" data-lang-key="conceptNotFoundText"></p>`;applyTranslations(); return;}
            ui.concepts.detail.innerHTML=`
                <h1 class="sr-only" data-lang-key="${item.nameKey}"></h1>
                <div class="page-header">
                    <h2 id="concepto-detalle-title" data-lang-key="${item.nameKey}"></h2>
                    <p data-lang-key="${item.topicKey}"></p>
                </div>
                <div class="card" role="article" aria-labelledby="concepto-detalle-title">
                    <h3><i class="fas fa-info-circle" aria-hidden="true" style="color:var(--primary-color); margin-right: 0.5rem;"></i> <span data-lang-key="descriptionTitle"></span></h3><p data-lang-key="${item.descriptionKey}"></p>
                    <h3><i class="fas fa-ruler-combined" aria-hidden="true" style="color:var(--primary-color); margin-right: 0.5rem;"></i> <span data-lang-key="howToTitle"></span></h3><p data-lang-key="${item.howToKey}"></p>
                    <h3><i class="fas fa-list-alt" aria-hidden="true" style="color:var(--primary-color); margin-right: 0.5rem;"></i> <span data-lang-key="typesTitle"></span></h3><p data-lang-key="${item.typesKey}"></p>
                    <h3><i class="fas fa-exclamation-triangle" aria-hidden="true" style="color:var(--primary-color); margin-right: 0.5rem;"></i> <span data-lang-key="errorsTitle"></span></h3><p data-lang-key="${item.errorsKey}"></p>
                    <button class="btn practiquemos-btn" data-topic-id="${topicId}" style="margin-top:1.5rem;" data-lang-key="practiceButton"></button>
                </div>`;
            // Add image only if specified in mathData and desired for detail view
            if (item.image) { 
                const imgElement = document.createElement('img');
                imgElement.src = item.image;
                imgElement.alt = getTranslatedText(item.nameKey); // Alt text from translation
                imgElement.style.cssText = 'width: 100%; max-width: 400px; height: auto; display: block; margin: 1rem auto; border-radius: var(--radius);';
                ui.concepts.detail.querySelector('.card p').prepend(imgElement); // Place image inside the card for structure
            }

            ui.concepts.detail.querySelector('.practiquemos-btn').addEventListener('click',e=>{const id=e.target.dataset.topicId;history.pushState({topicId:id},'','#view-practica');showView('#view-practica',{topicId:id});});
            applyTranslations(); 
        }

    // --- PRACTICE LOGIC ---
    let solvedProblems = new Set(); // Stores solved problems across a session for repetition checking
    function setupPractice() {
        ui.practice.search.addEventListener('input',renderPracticeSearch);
        // Fill datalist suggestions for practice search
        Object.keys(mathData).forEach(key => {
            const option = document.createElement('option');
            option.value = getTranslatedText(mathData[key].nameKey);
            ui.practice.suggestions.appendChild(option);
        });
        renderPracticeSearch(); // Initial render
    }
    
    function renderPracticeSearch(defaultTopicId=null){
        ui.practice.header.textContent=getTranslatedText('practicePageDesc');
        const term=ui.practice.search.value.toLowerCase();
        ui.practice.grid.innerHTML='';
        let keys = Object.keys(mathData);

        if(defaultTopicId && keys.includes(defaultTopicId)) { 
            keys = [defaultTopicId]; 
        } else {
            keys = keys.filter(key=>getTranslatedText(mathData[key].nameKey).toLowerCase().includes(term));
        }

        if(keys.length===0){ui.practice.grid.innerHTML=`<p class="card" data-lang-key="noPracticeFoundText"></p>`;applyTranslations(); return;}
        
        keys.forEach(key=>{
            const item=mathData[key];
            const card=document.createElement('div'); card.className='content-card card';
            card.setAttribute('role', 'article');
            card.setAttribute('tabindex', '0');
            card.setAttribute('aria-labelledby', `practice-topic-name-${key}`);
            card.innerHTML=`<h4 id="practice-topic-name-${key}" data-lang-key="${item.nameKey}"></h4><p data-lang-key="${item.topicKey}Desc"></p><button class="btn" data-topic-id="${key}" data-lang-key="startButton" aria-label="${getTranslatedText('startButton')} ${getTranslatedText(item.nameKey)}"></button>`;
            card.querySelector('button').addEventListener('click',e=>{
                const topicId=e.target.dataset.topicId;
                solvedProblems.clear(); // Reset problems for new practice session
                generatePracticeContent(topicId);
            });
            ui.practice.grid.appendChild(card);
        });
        applyTranslations(); // Apply translations
    }
    
    function generatePracticeContent(topicId){
        const item=mathData[topicId];
        ui.practice.header.textContent=`${getTranslatedText('exercisesForText')}: ${getTranslatedText(item.nameKey)}`;
        ui.practice.grid.innerHTML='';
        let sessionUsedProblems=new Set(); 

        for(let i=0;i<5;i++){ 
            const problem = genProblem(topicId, i < 3, sessionUsedProblems); // Pass Set for unique checking
            if (!problem || !problem.question || !problem.answer) { // Ensure problem is valid
                console.warn(`Could not generate valid problem for ${topicId}. Attempting fallback.`);
                problem = { typeKey: 'problemText', question: getTranslatedText('noPracticeForTopicText'), answer: 'N/A' };
            } else {
                 sessionUsedProblems.add(problem.question);
            }

            const card=document.createElement('div');card.className='problem-card card';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-labelledby', `problem-${topicId}-${i}-title`);
            card.setAttribute('tabindex', '0');
            card.innerHTML=`
                <h4 id="problem-${topicId}-${i}-title" class="sr-only">${getTranslatedText(problem.typeKey)} para ${getTranslatedText(item.nameKey)}</h4>
                <p><strong><span data-lang-key="${problem.typeKey}"></span>:</strong> ${problem.question}</p>
                <div class="response-form">
                    <label for="response-${topicId}-${i}" class="sr-only">${getTranslatedText('yourAnswerText')}</label>
                    <input type="text" id="response-${topicId}-${i}" class="input-field problem-answer" placeholder="${getTranslatedText('typeYourAnswerPlaceholder')}" aria-label="${getTranslatedText('yourAnswerText')}">
                    <button class="btn check-answer-btn" data-lang-key="checkAnswerButton" aria-label="${getTranslatedText('checkAnswerButton')}"></button>
                </div>
                <div class="feedback" role="alert" aria-live="assertive"></div>
                <button class="btn solve-together-btn" style="margin-top: 1rem;" data-lang-key="solveTogetherButton" aria-label="${getTranslatedText('solveTogetherButton')}"></button>
            `;
            ui.practice.grid.appendChild(card);
            
            card.querySelector('.check-answer-btn').addEventListener('click', e=>{
                const input=e.target.previousElementSibling;
                const feedback=e.target.parentElement.nextElementSibling;
                const userAnswer=input.value.trim().toLowerCase();
                const correctAnswer=String(problem.answer).trim().toLowerCase();
                
                if(userAnswer === correctAnswer){
                    feedback.textContent=getTranslatedText('correctAnswerText');
                    feedback.className='feedback correct';
                }else{
                    feedback.textContent=`${getTranslatedText('incorrectAnswerText')} ${correctAnswer}`;
                    feedback.className='feedback incorrect';
                }
                feedback.style.display='block';
                e.target.disabled = true; 
                input.disabled = true;
            });
        }
        document.querySelectorAll('.solve-together-btn').forEach(btn=>btn.addEventListener('click',e=>{
            const problem=e.target.parentElement.querySelector('p').textContent;
            history.pushState({problem},'',`#view-chat`); 
            showView(`#view-chat`, {problem: problem});
        }));
        applyTranslations();
    }

    function genProblem(topicId,isExercise,usedProblems){
        let question,answer,typeKey;
        const n1=Math.floor(Math.random()*50)+1; const n2=Math.floor(Math.random()*15)+2; const n3=Math.floor(Math.random()*25)+5; 
        const n4=Math.floor(Math.random()*10)+1; const n5=Math.floor(Math.random()*7)+1; 
        
        typeKey = isExercise ? "exerciseText" : "problemText";
        
        let problemAttempt = null;
        let attemptCount = 0;
        let uniqueProblemFound = false;

        while(!uniqueProblemFound && attemptCount < 50) { 
            attemptCount++;
            let currentQuestion = '';
            let currentAnswer = '';
            
            switch (topicId) {
                case 'Algebra': 
                    if(Math.random() > 0.5){
                       currentQuestion = `${getTranslatedText('solveXText')}: ${n1}x + ${n2} = ${n1 * 3 + n2}`; currentAnswer = `3`; 
                    } else {
                       currentQuestion = `${getTranslatedText('calculateText')}: ${n1} - (${-n2}) * ${n3}.`; currentAnswer = (n1 - (-n2) * n3).toFixed(0); 
                    }
                    break;
                case 'Geometria':
                    if(Math.random() > 0.5){
                        currentQuestion = `${getTranslatedText('areaRectText', [n2,n3])}`; currentAnswer = (n2 * n3).toFixed(0);
                    } else {
                        currentQuestion = `${getTranslatedText('perimSquareText', [n2])}`; currentAnswer = (4 * n2).toFixed(0);
                    }
                    break;
                case 'Trigonometria':
                    const angle = [30,45,60][Math.floor(Math.random()*3)];
                    currentQuestion = `${getTranslatedText('sineCalculationText', [angle])}.`; currentAnswer = (Math.sin(angle * Math.PI / 180)).toFixed(2);
                    break;
                case 'Funciones':
                    if(Math.random() > 0.5){
                        currentQuestion = `${getTranslatedText('ifFxText', [n1,n2])}. ${getTranslatedText('calcFxText', [n3])}.`; currentAnswer = (n1 * n3 + n2).toFixed(0);
                    } else {
                        currentQuestion = `${getTranslatedText('isConstOrLinearText', [n1])}?`; currentAnswer = getTranslatedText('constantText');
                    }
                    break;
                case 'EstadisticaYProbabilidad':
                    if(Math.random() > 0.5){
                         currentQuestion = `${getTranslatedText('probabilityCoinsText', [n2])}`; currentAnswer = Math.pow(0.5,n2).toFixed(Math.min(n2,4));
                    } else {
                        currentQuestion = `${getTranslatedText('avgDailyTempText', [n1,n2,n3])}`; currentAnswer = ((n1+n2+n3)/3).toFixed(2);
                    }
                    break;
                case 'Calculo':
                    if(Math.random() > 0.5){
                        currentQuestion = `${getTranslatedText('derivativeOfX2Text')}`; currentAnswer = `2x`;
                    } else {
                        currentQuestion = `${getTranslatedText('integralOf1Text')}`; currentAnswer = `x+C`;
                    }
                    break;
                case 'OperacionesConEnteros':
                    currentQuestion = `${getTranslatedText('calculateText')}: ${n1} + (${n2}) * ${n3} - ${n4}.`; currentAnswer = (n1 + n2 * n3 - n4).toFixed(0);
                    break;
                case 'FraccionesYDecimales':
                    currentQuestion = `${getTranslatedText('solveText')}: ${n1}/${n2} + ${n3}/${n4} (redondea a 2 decimales).`; currentAnswer = ( (n1*n4 + n3*n2) / (n2*n4) ).toFixed(2);
                    break;
                case 'EcuacionesCuadraticas':
                    currentQuestion = `${getTranslatedText('solveQuadraticEquationText', [n1 + n2, n1 * n2])}`;
                    let rootVal = (n1 + n2)*(n1 + n2) - 4 * (n1*n2);
                    if (rootVal < 0) rootVal = 0; 
                    let root1 = (-(n1+n2) + Math.sqrt(rootVal)) / 2;
                    let root2 = (-(n1+n2) - Math.sqrt(rootVal)) / 2;
                    currentAnswer = Math.min(root1, root2).toFixed(2); 
                    break;
                case 'Matrices':
                    currentQuestion = `${getTranslatedText('sumMatrixText', [n1,n2,n3,n4])}`; 
                    currentAnswer = `[[${n1+1},${n2}],[${n3},${n4+1}]]`; 
                    break;
                default:
                    currentQuestion = getTranslatedText('defineTextForTopic', getTranslatedText(mathConcepts[topicId]?.nameKey || topicId));
                    currentAnswer = getTranslatedText('reviewConceptsText');
            }

            // Environmental problems (if isExercise is false, these override generic ones)
            if (!isExercise) {
                switch(Math.floor(Math.random() * 3)) { // 3 types of environmental problems
                    case 0: 
                        currentQuestion = getTranslatedText('waterConsumptionProblem', [n1 * 100, n2, n3]);
                        currentAnswer = ((n1 * 100 * n2 / 100) * n3).toFixed(0);
                        break;
                    case 1: 
                        currentQuestion = getTranslatedText('plasticWasteProblem', [n1, n2, n3, n4]);
                        currentAnswer = ( (n1 * n2) * (n3 / 100) * n4 ).toFixed(0);
                        break;
                    case 2: 
                        currentQuestion = getTranslatedText('deforestationProblem', [n1 * 100, n2]);
                        currentAnswer = (n1 * 100 / n2).toFixed(2);
                        break;
                    default: 
                        currentQuestion = getTranslatedText('problemText'); currentAnswer = "N/A"; 
                        break;
                }
            }
            
            problemAttempt = { typeKey, question: currentQuestion, answer: currentAnswer };
            if (!usedProblems.has(problemAttempt.question)) {
                uniqueProblemFound = true;
            }
        } while(!uniqueProblemFound && attemptCount < 50);

        if (!uniqueProblemFound) {
             console.warn(`Could not generate unique problem for ${topicId} after ${attemptCount} attempts. Skipping.`);
             return { typeKey: 'problemText', question: getTranslatedText('noPracticeForTopicText'), answer: 'N/A' };
        }
        
        return problemAttempt;
    }
    
    // --- OTHER SECTIONS ---
    function setupConsejos(){ui.consejos.container.innerHTML = ''; consejosData.forEach(c => {const card = document.createElement('div'); card.className = 'card'; card.setAttribute('role', 'article'); card.setAttribute('tabindex', '0'); card.innerHTML = `<h3 id="tip-title-${c.icon}"><i class="fas ${c.icon}" aria-hidden="true" style="color:var(--primary-color); margin-right: 0.5rem;"></i> <span data-lang-key="${c.titleKey}"></span></h3><p data-lang-key="${c.textKey}"></p>`; ui.consejos.container.appendChild(card);}); applyTranslations(); }
    function renderQuienesSomos(){ui.quienes.container.innerHTML = quienesSomosText; applyTranslations(); }
    
    // --- SETTINGS LOGIC ---
    function setupSettings(){
        ui.ajustes.lang.addEventListener('change',e=>{applyTranslations(e.target.value); location.reload();}); 
        ui.ajustes.bgUpload.addEventListener('change',e=>{const file=e.target.files[0];if(file)handleFileUpload(file);});
        ui.ajustes.bgUrlForm.addEventListener('submit',e=>{e.preventDefault();const url=ui.ajustes.bgUrlInput.value.trim();if(url)applyBackground(url);});
        ui.ajustes.bgReset.addEventListener('click', resetBackground);
        ui.ajustes.fontSizeToggle.addEventListener('change', e => {
            document.body.classList.toggle('large-text', e.target.checked);
            localStorage.setItem('fontSizeEnabled', e.target.checked);
            applyTranslations(); 
        });
        ui.ajustes.contrastToggle.addEventListener('change', e => {
            document.body.classList.toggle('dark-theme', e.target.checked);
            localStorage.setItem('highContrastEnabled', e.target.checked);
        });
        initSettingsDisplay(); 
    }

    function handleFileUpload(file) {
        if (!file.type.match('image.*') && !file.type.match('video.*')) {
            alert(getTranslatedText('invalidFileTypeAlert'));
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => applyBackground(e.target.result);
        reader.readAsDataURL(file);
    }

    function initSettingsDisplay(){
        ui.ajustes.lang.value = localStorage.getItem('appLanguage') || 'es';
        ui.ajustes.fontSizeToggle.checked = localStorage.getItem('fontSizeEnabled') === 'true';
        document.body.classList.toggle('large-text', ui.ajustes.fontSizeToggle.checked);
        ui.ajustes.contrastToggle.checked = localStorage.getItem('highContrastEnabled') === 'true';
        document.body.classList.toggle('dark-theme', ui.ajustes.contrastToggle.checked);

        const savedBg = localStorage.getItem('menuBackground');
        if(savedBg) applyBackground(savedBg);
    }
    
    function applyTranslations(lang = localStorage.getItem('appLanguage') || 'es'){
        const langPack = translations[lang] || translations.es;
        // Translate elements with data-lang-key
        document.querySelectorAll('[data-lang-key]').forEach(el=>{
            const key = el.dataset.langKey;
            // Input placeholders
            if (el.tagName === 'INPUT' && langPack[key + 'Placeholder']) {
                el.placeholder = langPack[key + 'Placeholder']; 
            } else if (el.tagName === 'BUTTON' && el.getAttribute('aria-label') && langPack[key]) {
                if (el.dataset.originalLabel === undefined) { el.dataset.originalLabel = el.textContent; } // Store original text if not already stored
                el.setAttribute('aria-label', `${langPack[key]} ${getTranslatedText(el.dataset.originalLabel)}`);
                el.textContent = langPack[key];
            } else if (el.tagName === 'A' && el.getAttribute('aria-label') && langPack[key]) { // For nav links in menu card
                if (el.dataset.originalLabel === undefined) { el.dataset.originalLabel = el.querySelector('h3').textContent; }
                el.setAttribute('aria-label', `${langPack[key]} ${getTranslatedText(el.dataset.originalLabel)}`);
            }
            // All other text content
            else if (langPack[key] !== undefined) {
                el.textContent = langPack[key];
            }
        });
        
        // Update datalists manually as they don't respond to data-lang-key
        // This is important because concepts and practice cards rely on translated names for searching
        if (ui.concepts.suggestions) { 
             ui.concepts.suggestions.innerHTML = Object.keys(mathConcepts).map(key => `<option value="${getTranslatedText(mathConcepts[key].nameKey)}"></option>`).join('');
        }
        if (ui.practice.suggestions) {
            ui.practice.suggestions.innerHTML = Object.keys(mathConcepts).map(key => `<option value="${getTranslatedText(mathConcepts[key].nameKey)}"></option>`).join('');
        }

        document.documentElement.lang = lang;
        localStorage.setItem('appLanguage', lang);
    }
    
    function applyBackground(url){
        const menuView=document.getElementById('view-menu');
        let backgroundLayer = document.getElementById('menu-background-layer');
        if (!backgroundLayer) {
            backgroundLayer = document.createElement('div');
            backgroundLayer.id = 'menu-background-layer';
            menuView.prepend(backgroundLayer);
        }
        backgroundLayer.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:0.2;';
        backgroundLayer.innerHTML = ''; // Clear existing content (video or image)

        if(url.startsWith('data:video') || url.match(/\.(mp4|webm|ogg)$/i)) { // Check for video type or extension
            const video=document.createElement('video');video.style.cssText='width:100%;height:100%;object-fit:cover;';
            video.src=url;video.autoplay=true;video.loop=true;video.muted=true;video.setAttribute('aria-hidden', 'true');
            backgroundLayer.appendChild(video);
        } else {
            backgroundLayer.style.backgroundImage=`url(${url})`;
            backgroundLayer.style.backgroundSize='cover';
            backgroundLayer.style.backgroundPosition='center';
        }
        localStorage.setItem('menuBackground', url);
    }
    function resetBackground() { localStorage.removeItem('menuBackground'); location.reload(); }

    // Utility function to get translated text (with fallback)
    function getTranslatedText(key, params = [], lang = localStorage.getItem('appLanguage') || 'es') { // Modified to accept array of parameters
        const langPack = translations[lang] || translations.es;
        let text = langPack[key] !== undefined ? langPack[key] : translations.es[key] || key;
        
        // If text has placeholders like [PARAM1], replace them
        if (Array.isArray(params) && params.length > 0) {
            params.forEach((param, index) => {
                text = text.replace(`[PARAM${index+1}]`, param);
            });
        }
        return text;
    }


    // --- INITIALIZATION ---
    function init() {
        // Particles.js for splash screen background
        if(document.getElementById('particles-js'))particlesJS('particles-js',{"particles":{"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.5,"random":false,"anim":{"enable":true,"speed":1,"opacity_min":0.1,"sync":false}},"size":{"value":3,"random":true,"anim":{"enable":false,"size_min":0.1,"sync":false}},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.4,"width":1},"move":{"enable":true,"speed":6,"direction":"none","random":false,"straight":false,"out_mode":"out","bounce":false}},"interactivity":{"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"grab"},"onclick":{"enable":true,"mode":"push"},"resize":true},"modes":{"grab":{"distance":200,"line_linked":{"opacity":1}},"push":{"particles_nb":4},"repulse":{"distance":200,"duration":0.4}}}});
        
        setupApp(); // Call main setup function to initialize modules
        showInitialView(); // Determine and show the first view
    }
    init(); // Start the app!
});
</script>
</body>
</html>