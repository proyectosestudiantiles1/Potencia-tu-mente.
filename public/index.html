<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
      :root{--primary-gradient:linear-gradient(90deg, #1abc9c, #16a085);--primary-color:#16a085;--secondary-color:#2c3e50;--bg-color:#f4f7f9;--card-bg:#ffffff;--text-dark:#34495e;--text-light:#7f8c8d;--shadow:0 8px 30px rgba(0,0,0,0.06);--radius:16px;--font-base-size:16px;}
      body.large-text{--font-base-size:18px;}
      body.dark-theme{--primary-gradient:linear-gradient(90deg, #1abc9c, #1dd2af);--primary-color:#1abc9c;--secondary-color:#ecf0f1;--bg-color:#2c3e50;--card-bg:#34495e;--text-dark:#ecf0f1;--text-light:#95a5a6;}
      *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
      body{font-family:'Poppins',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;font-size:var(--font-base-size);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:background-color 0.3s,color 0.3s;}
      main{display:none}.page-section{display:none}.page-section.active{display:block;animation:fadeInUp 0.6s ease-out forwards}
      .container{max-width:1100px;margin:0 auto;padding:2rem}.page-header{margin-bottom:2.5rem;text-align:center}
      .page-header h2{font-family:'Poppins',sans-serif;font-weight:700;font-size:calc(var(--font-base-size)*2.2);color:var(--secondary-color)}.page-header p{font-size:calc(var(--font-base-size)*1.1);color:var(--text-light);max-width:700px;margin:.5rem auto 0;font-family:'Lato',sans-serif;}
      .btn{display:inline-block;padding:.8rem 2rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-base-size)}.btn:hover:not(:disabled){transform:translateY(-4px);box-shadow:0 8px 25px rgba(22,160,133,.4)}.btn:disabled{background:#bdc3c7;cursor:not-allowed;box-shadow:none;}
      .btn-secondary{background:#dbe0e2;color:var(--text-dark);box-shadow:none}.btn-secondary:hover:not(:disabled){background:#c8cfd2;transform:translateY(-2px);}
      .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2.5rem;box-shadow:var(--shadow);transition:all 0.3s ease;border:1px solid #e9ecef;}
      .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dde2e6;background-color:#f9fafb;color:var(--text-dark);border-radius:10px;font-size:var(--font-base-size);transition:border-color .2s,box-shadow .2s}.input-field:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(22,160,133,.2)}
      @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
      #view-inicio{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#1c2541;overflow:hidden;}
      #particles-js{position:absolute;width:100%;height:100%;z-index:-1;}
      .inicio-content h1,.inicio-content p,.inicio-content .btn{opacity:0;animation:fadeInUp 0.8s ease-out forwards;}
      .inicio-content h1{font-size:clamp(3rem,10vw,5.5rem);letter-spacing:1px;animation-delay:0.2s;}
      .inicio-content p{font-size:1.5rem;color:rgba(255,255,255,.8);margin-bottom:2.5rem;animation-delay:0.4s;font-family:'Lato',sans-serif;}
      .inicio-content .btn{padding:1rem 3rem;font-size:1.2rem;animation-delay:0.6s;}
      .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}.menu-card{text-align:center;text-decoration:none;color:var(--text-dark)}.menu-card .icon{font-size:2.5rem;color:var(--primary-color);margin-bottom:1rem;transition:transform 0.3s ease;}.menu-card h3{font-family:'Poppins';font-weight:600;font-size:1.3rem;margin-bottom:0.5rem;}.menu-card p{font-family:'Lato',sans-serif;color:var(--text-light);}.menu-card.card:hover{transform:translateY(-10px);box-shadow:0 12px 40px rgba(0,0,0,0.08);}.menu-card.card:hover .icon{transform:scale(1.1);}
      #practice-results{margin-top:2rem;display:grid;grid-template-columns:1fr;gap:1.5rem;}.problem-card{background-color:var(--bg-color);padding:1.5rem;border-radius:var(--radius);border:1px solid #e9ecef;}.solution{margin-top:1rem;padding:1rem;background-color:#eaf6f4;border-radius:8px;border-left:4px solid var(--primary-color);}
      
      /* [SOLUCIÓN] - CSS corregido para centrar el overlay de autenticación */
      #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);z-index:1000;animation:fadeIn .3s;display:none;align-items:center;justify-content:center;}.auth-card{width:100%;max-width:400px;text-align:center}.auth-toggle button{background:none;border:none;cursor:pointer;padding:.5rem 1rem;font-size:1.1rem;color:var(--text-light);transition:color .2s}.auth-toggle button.active{font-weight:bold;color:var(--primary-color);border-bottom:2px solid var(--primary-color)}#register-form{display:none}#auth-feedback{margin-top:1rem;color:red;min-height:1.2em}#login-form,#register-form{margin-top:1.5rem}
      
      .chat-container{display:flex;gap:1.5rem;height:75vh;max-height:700px}.friends-panel{width:300px;flex-shrink:0;display:flex;flex-direction:column}#friends-list{flex-grow:1;overflow-y:auto;margin-top:1rem}.chat-window{flex-grow:1;display:flex;flex-direction:column}#chat-messages{border:1px solid #dde2e6;padding:1rem;border-radius:var(--radius);flex-grow:1;overflow-y:auto;margin-bottom:1rem;background-color:var(--bg-color)}.message-bubble{padding:.6rem 1rem;border-radius:20px;margin-bottom:.5rem;max-width:80%;word-wrap:break-word}.message-bubble.sent{background:var(--primary-gradient);color:#fff;margin-left:auto;border-bottom-right-radius:5px}.message-bubble.received{background:var(--card-bg);color:var(--text-dark);margin-right:auto;border-bottom-left-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.05)}#add-friend-form button{padding:0;min-width:46px;max-width:46px;height:46px;flex-shrink:0;line-height:1;font-size:1.5rem}.btn-back{display:block;margin:1.5rem auto 0;width:fit-content}
      .settings-container h3{font-family:'Poppins',sans-serif}.toggle-switch{display:flex;align-items:center;justify-content:space-between;margin-top:.5rem}.slider{position:relative;cursor:pointer;width:50px;height:26px;background-color:#ccc;border-radius:26px;transition:.4s}.slider:before{position:absolute;content:"";height:18px;width:18px;left:4px;bottom:4px;background-color:#fff;border-radius:50%;transition:.4s}input:checked+.slider{background-color:var(--primary-color)}input:checked+.slider:before{transform:translateX(24px)}
    </style>
</head>
<body>
    <section id="view-inicio">
        <div id="particles-js"></div>
        <div class="inicio-content"><h1>Potencia tu Mente</h1><p>Tu viaje al dominio de las matemáticas comienza ahora.</p><button id="enter-button" class="btn">Entrar</button></div>
    </section>
    
    <main>
        <div class="container">
            <section id="view-menu" class="page-section">
                <div class="card">
                    <div class="page-header"><h2 data-lang-key="menuTitle">Menú Principal</h2></div>
                    <div class="menu-grid">
                        <a href="#view-ia" class="menu-card nav-link card"><div class="icon"><i class="fas fa-robot"></i></div><h3 data-lang-key="iaTitle">Tutor IA</h3><p data-lang-key="iaMenuDesc">Resuelve cualquier duda.</p></a>
                        <a href="#view-practice" class="menu-card nav-link card"><div class="icon"><i class="fas fa-pencil-ruler"></i></div><h3 data-lang-key="practiceTitle">Práctica con IA</h3><p data-lang-key="practiceMenuDesc">Genera problemas para resolver.</p></a>
                        <a href="#view-consejos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-lightbulb"></i></div><h3 data-lang-key="tipsTitle">Consejos de IA</h3><p data-lang-key="tipsMenuDesc">Descubre nuevas estrategias.</p></a>
                        <a href="#view-chat" class="menu-card nav-link card"><div class="icon"><i class="fas fa-comments"></i></div><h3 data-lang-key="chatTitle">Aprendamos Juntos</h3><p data-lang-key="chatMenuDesc">Chatea con amigos.</p></a>
                        <a href="#view-quienes-somos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-users"></i></div><h3 data-lang-key="whoTitle">Quiénes Somos</h3><p data-lang-key="whoMenuDesc">Conoce al equipo.</p></a>
                        <a href="#view-ajustes" class="menu-card nav-link card"><div class="icon"><i class="fas fa-cog"></i></div><h3 data-lang-key="settingsTitle">Ajustes</h3><p data-lang-key="settingsMenuDesc">Personaliza tu experiencia.</p></a>
                    </div>
                    <button class="btn btn-secondary" id="logout-button" style="display:none; margin: 2rem auto 0; background: #e74c3c; color: white;" data-lang-key="logoutButton">Cerrar Sesión</button>
                </div>
            </section>
            
            <section id="view-ia" class="page-section"><div class="page-header"><h2 data-lang-key="iaTitle">Tutor IA</h2><p>Pregúntale cualquier concepto matemático a la IA.</p></div><div class="card"><div class="input-group"><input id="ia-input" type="text" class="input-field" placeholder="Ej: ¿Qué es el Teorema de Pitágoras?" /><button id="ia-button" class="btn">Consultar</button></div><div id="ia-explanation" style="min-height: 200px;"><p style="color: var(--text-light)">Aquí aparecerá la explicación...</p></div></div><button class="btn btn-secondary btn-back">Regresar</button></section>
            <section id="view-practice" class="page-section"><div class="page-header"><h2>Práctica con IA</h2><p>Escribe un tema y la IA creará problemas para que practiques.</p></div><div class="card"><div class="input-group"><input id="practice-input" type="text" class="input-field" placeholder="Ej: Ecuaciones de primer grado" /><button id="practice-button" class="btn">Generar Problemas</button></div></div><div id="practice-results"><p style="text-align:center; color: var(--text-light);">Aquí aparecerán los problemas generados...</p></div><button class="btn btn-secondary btn-back">Regresar</button></section>
            <section id="view-consejos" class="page-section"><div class="page-header"><h2>Consejos de la IA</h2><p>Cada vez que entres, la IA te dará nuevos consejos.</p></div><div id="consejos-container" class="menu-grid"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
            <section id="view-quienes-somos" class="page-section"><div class="page-header"><h2>Quiénes Somos</h2></div><div class="card" id="quienes-somos-container" style="font-family:'Lato', sans-serif; line-height:1.8;"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
            <section id="view-ajustes" class="page-section"><div class="page-header"><h2>Ajustes</h2></div><div class="card" style="max-width:600px; margin:auto;"><div class="settings-container" style="display:flex; flex-direction:column; gap:2.5rem;"><div><h3>Accesibilidad</h3><div class="toggle-switch"><p>Texto más grande</p><label><input type="checkbox" id="font-size-toggle" style="opacity:0; width:0; height:0;"><span class="slider"></span></label></div><div class="toggle-switch" style="margin-top:1rem;"><p>Modo de Alto Contraste</p><label><input type="checkbox" id="contrast-toggle" style="opacity:0; width:0; height:0;"><span class="slider"></span></label></div></div></div></div><button class="btn btn-secondary btn-back">Regresar</button></section>

            <section id="view-chat" class="page-section">
                <div id="auth-overlay">
                    <div class="card auth-card">
                        <div class="auth-toggle"><button id="show-login" class="active">Iniciar Sesión</button><button id="show-register">Crear Cuenta</button></div>
                        <form id="login-form"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="login-username" class="input-field" placeholder="Nombre de usuario" required autocomplete="username"><input type="password" id="login-password" class="input-field" placeholder="Contraseña" required autocomplete="current-password"></div><button type="submit" class="btn">Entrar</button></form>
                        <form id="register-form" style="display:none;"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="register-username" class="input-field" placeholder="Nuevo usuario" required autocomplete="username"><input type="password" id="register-password" class="input-field" placeholder="Nueva contraseña (mín. 4)" required minlength="4" autocomplete="new-password"></div><button type="submit" class="btn">Registrarme</button></form>
                        <p id="auth-feedback"></p>
                    </div>
                </div>
                <div class="chat-view" style="display: none;">
                    <div class="page-header"><h2>Aprendamos Juntos</h2></div>
                    <div class="chat-container">
                        <aside class="card friends-panel">
                            <p>Hola, <strong id="your-username" style="color:var(--primary-color)"></strong></p>
                            <p style="font-size:0.9em;">Tu código: <strong id="your-code" title="Clic para copiar" style="cursor:pointer; user-select:all;"></strong></p>
                            <h3 style="margin-top:1.5rem;">Amigos</h3>
                            <form id="add-friend-form" class="input-group"><input id="friend-code-input" class="input-field" placeholder="Código de amigo..." required><button type="submit" class="btn">+</button></form>
                            <div id="friends-list"></div>
                        </aside>
                        <div class="card chat-window">
                            <h3 id="chat-header">Selecciona un amigo</h3>
                            <div id="chat-messages"></div>
                            <form id="chat-form" class="input-group"><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled><button type="submit" class="btn" disabled>Enviar</button></form>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-back">Regresar</button>
                </div>
            </section>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { currentUser: null, friends: [], activeChat: null, messages: {}, onlineFriends: [] };
        const ui = {
            main: document.querySelector('main'),
            inicio: { view: document.getElementById('view-inicio'), button: document.getElementById('enter-button') },
            logoutButton: document.getElementById('logout-button'),
            sections: document.querySelectorAll('.page-section'),
            navLinks: document.querySelectorAll('.nav-link'),
            backButtons: document.querySelectorAll('.btn-back'),
            ia: { input: document.getElementById('ia-input'), button: document.getElementById('ia-button'), explanation: document.getElementById('ia-explanation') },
            practice: { input: document.getElementById('practice-input'), button: document.getElementById('practice-button'), results: document.getElementById('practice-results') },
            consejos: { container: document.getElementById('consejos-container') },
            auth: { overlay: document.getElementById('auth-overlay'), showLogin: document.getElementById('show-login'), showRegister: document.getElementById('show-register'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), feedback: document.getElementById('auth-feedback')},
            chat: { view: document.querySelector('.chat-view'), yourUsername: document.getElementById('your-username'), yourCode: document.getElementById('your-code'), addForm: document.getElementById('add-friend-form'), friendInput: document.getElementById('friend-code-input'), list: document.getElementById('friends-list'), header: document.getElementById('chat-header'), messages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), sendButton: document.querySelector('#chat-form button') },
            quienes: { container: document.getElementById('quienes-somos-container') },
            ajustes: { fontSizeToggle: document.getElementById('font-size-toggle'), contrastToggle: document.getElementById('contrast-toggle') }
        };

        const socket = io({ autoConnect: false });
        
        // [SOLUCIÓN 3] - Texto completo para "Quiénes Somos"
        const quienesSomosText = `<p>Somos un grupo de estudiantes de Educación para el Trabajo que hemos creado el proyecto “Potencia tu mente con matemáticas”, una plataforma web diseñada para apoyar el aprendizaje de las matemáticas de manera sencilla, práctica e interactiva. Nuestro objetivo es brindar a los estudiantes una herramienta accesible y motivadora que les permita reforzar sus conocimientos y superar las dificultades más comunes en esta área.</p><p style="margin-top:1rem;">Creemos firmemente que nuestro esfuerzo contribuirá al desarrollo académico de los estudiantes y al fortalecimiento de sus competencias matemáticas, demostrando que con constancia, innovación y dedicación se puede transformar la manera en que aprendemos.</p>`;

        function init() {
            if (document.getElementById('particles-js')) particlesJS('particles-js',{"particles":{"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"move":{"enable":true,"speed":6}}});
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                loadFriends();
                connectUser();
            }
            showView(location.hash.substring(1));
            setupNavigationListeners();
            setupIAListeners();
            setupPracticeListeners();
            setupAuthListeners();
            setupChatListeners();
            ui.quienes.container.innerHTML = quienesSomosText;
        }

        function showView(viewId) {
            const currentViewId = viewId || 'view-menu';
            if (!sessionStorage.getItem('visitedBefore')) {
                ui.main.style.display = 'none';
                ui.inicio.view.style.display = 'flex';
                return;
            }
            ui.main.style.display = 'block';
            ui.inicio.view.style.display = 'none';
            ui.sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(currentViewId);
            if(activeSection) activeSection.classList.add('active');
            if (currentViewId === 'view-chat') renderChatView();
            if (currentViewId === 'view-consejos') generateTips();
            ui.logoutButton.style.display = state.currentUser ? 'block' : 'none';
        }
        
        function renderChatView() {
            if (state.currentUser) {
                ui.auth.overlay.style.display = 'none';
                ui.chat.view.style.display = 'block';
                ui.chat.yourUsername.textContent = state.currentUser.username;
                ui.chat.yourCode.textContent = state.currentUser.code;
                renderFriends();
            } else {
                ui.auth.overlay.style.display = 'flex';
                ui.chat.view.style.display = 'none';
            }
        }
        
        function navigateTo(viewId) { history.pushState({viewId}, '', `#${viewId}`); showView(viewId); }
        function setupNavigationListeners() {
            ui.inicio.button.addEventListener('click', () => { sessionStorage.setItem('visitedBefore', 'true'); navigateTo('view-menu'); });
            ui.navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); navigateTo(e.currentTarget.getAttribute('href').substring(1)); }));
            ui.backButtons.forEach(btn => btn.addEventListener('click', () => window.history.back()));
            window.addEventListener('popstate', () => showView(location.hash.substring(1)));
        }

        function setupAuthListeners() {
            ui.auth.showLogin.addEventListener('click', () => toggleAuthForms(true));
            ui.auth.showRegister.addEventListener('click', () => toggleAuthForms(false));
            ui.auth.loginForm.addEventListener('submit', handleLogin);
            ui.auth.registerForm.addEventListener('submit', handleRegister);
            ui.logoutButton.addEventListener('click', handleLogout);
        }
        async function handleLogin(e) { e.preventDefault(); const username = ui.auth.loginForm.querySelector('#login-username').value; const password = ui.auth.loginForm.querySelector('#login-password').value; const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json(); if (data.success) { state.currentUser = data.user; sessionStorage.setItem('currentUser', JSON.stringify(data.user)); loadFriends(); connectUser(); renderChatView(); } else { ui.auth.feedback.textContent = data.message; } }
        async function handleRegister(e) { e.preventDefault(); const username = ui.auth.registerForm.querySelector('#register-username').value; const password = ui.auth.registerForm.querySelector('#register-password').value; const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json(); if (data.success) { alert('¡Cuenta creada!'); toggleAuthForms(true); } else { ui.auth.feedback.textContent = data.message; } }
        function handleLogout() { sessionStorage.removeItem('currentUser'); if(state.currentUser) localStorage.removeItem(`friends_${state.currentUser.username}`); state.currentUser = null; socket.disconnect(); navigateTo('view-menu'); }
        function toggleAuthForms(showLogin) { ui.auth.loginForm.style.display = showLogin ? 'block' : 'none'; ui.auth.registerForm.style.display = showLogin ? 'none' : 'block'; ui.auth.showLogin.classList.toggle('active', showLogin); ui.auth.showRegister.classList.toggle('active', !showLogin); }

        function setupChatListeners() {
            ui.chat.addForm.addEventListener('submit', addFriend);
            ui.chat.list.addEventListener('click', (e) => { const item = e.target.closest('[data-code]'); if (item) setActiveChat(item.dataset.code); });
            ui.chat.chatForm.addEventListener('submit', sendChatMessage);
            socket.on('online users update', (users) => { state.onlineFriends = users; renderFriends(); });
            socket.on('private message', handleNewMessage);
        }
        function connectUser() { if (!socket.connected) { socket.connect(); } socket.emit('register user', state.currentUser); }
        function loadFriends() { if (state.currentUser) state.friends = JSON.parse(localStorage.getItem(`friends_${state.currentUser.username}`)) || []; }
        function saveFriends() { if (state.currentUser) localStorage.setItem(`friends_${state.currentUser.username}`, JSON.stringify(state.friends)); }
        function renderFriends() { if (!state.currentUser) return; ui.chat.list.innerHTML = state.friends.map(f => `<div class="card" data-code="${f.code}" style="cursor:pointer;padding:.8rem;margin-bottom:.5rem;${f.code===state.activeChat?'background-color:#eaf6f4':''}">${f.username}</div>`).join(''); }
        function addFriend(e) { e.preventDefault(); const code = ui.chat.friendInput.value.trim().toUpperCase(); if (!code) return; socket.emit('add friend', code, (res) => { if (res.success && !state.friends.find(f => f.code === res.friend.code)) { state.friends.push(res.friend); saveFriends(); renderFriends(); } else { alert('Código no válido.'); } }); ui.chat.friendInput.value = ''; }
        function setActiveChat(code) { state.activeChat = code; renderFriends(); const friend = state.friends.find(f=>f.code===code); ui.chat.header.textContent = `Chateando con ${friend.username}`; ui.chat.chatInput.disabled = false; ui.chat.sendButton.disabled = false; }
        function sendChatMessage(e) { e.preventDefault(); const text = ui.chat.chatInput.value.trim(); if (!text) return; const message = { text }; socket.emit('private message', { toCode: state.activeChat, message }); ui.chat.chatInput.value = ''; handleNewMessage({from: state.currentUser.username, message}); }
        function handleNewMessage({from, message}) { const code = from === state.currentUser.username ? state.activeChat : state.friends.find(f=>f.username===from)?.code; if(!code) return; state.messages[code] = state.messages[code] || []; state.messages[code].push({from, text: message.text}); renderMessages(code); }
        function renderMessages(code) { if (code !== state.activeChat) return; ui.chat.messages.innerHTML = (state.messages[code] || []).map(m => `<div class="message-bubble ${m.from === state.currentUser.username ? 'sent':'received'}">${m.text}</div>`).join(''); ui.chat.messages.scrollTop = ui.chat.messages.scrollHeight; }

        function setupIAListeners() { ui.ia.button.addEventListener('click', async () => { const topic = ui.ia.input.value; if (!topic) return; ui.ia.explanation.innerHTML = `<p>Consultando...</p>`; const res = await fetch('/api/explain-math', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ topic }) }); const data = await res.json(); ui.ia.explanation.innerHTML = data.explanation; }); }
        
        // [SOLUCIÓN 1] - Función para "Práctica con IA"
        function setupPracticeListeners() {
            ui.practice.button.addEventListener('click', async () => {
                const topic = ui.practice.input.value.trim();
                if (!topic) return;
                ui.practice.results.innerHTML = `<p>Generando problemas sobre ${topic}...</p>`;
                const res = await fetch('/api/generate-problems', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ topic }) });
                const data = await res.json();
                ui.practice.results.innerHTML = data.problems || `<p style="color:red">${data.error}</p>`;
                ui.practice.results.querySelectorAll('.show-solution-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const solution = btn.previousElementSibling;
                        solution.style.display = solution.style.display === 'none' ? 'block' : 'none';
                    });
                });
            });
        }
        
        async function generateTips() {
            ui.consejos.container.innerHTML = `<p style="grid-column:1/-1;text-align:center;">Generando consejos...</p>`;
            try {
                const res = await fetch('/api/generate-tips');
                const data = await res.json();
                // [SOLUCIÓN 4] - Limpiamos la respuesta de la IA
                let tipsHtml = data.tips || '<p>No se pudieron cargar los consejos.</p>';
                tipsHtml = tipsHtml.replace(/```html\n?/g, '').replace(/```/g, '');
                ui.consejos.container.innerHTML = tipsHtml;
            } catch (e) {
                ui.consejos.container.innerHTML = '<p style="color:red;">Error al cargar consejos.</p>';
            }
        }
        
        init();
    });
    </script>
</body>
</html>