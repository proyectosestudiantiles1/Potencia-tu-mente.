<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="mainTitle">Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      :root{--primary-gradient:linear-gradient(90deg, #1abc9c, #16a085);--primary-color:#16a085;--secondary-color:#2c3e50;--bg-color:#ecf0f1;--card-bg:#ffffff;--text-dark:#34495e;--text-light:#7f8c8d;--shadow:0 10px 30px rgba(0,0,0,0.07);--radius:16px;--online-color:#2ecc71;--offline-color:#bdc3c7;--font-base-size:16px;}
      body.large-text{--font-base-size:18px;}
      body.dark-theme{--primary-gradient:linear-gradient(90deg, #1abc9c, #1dd2af);--primary-color:#1abc9c;--secondary-color:#ecf0f1;--bg-color:#2c3e50;--card-bg:#34495e;--text-dark:#ecf0f1;--text-light:#95a5a6;}
      *{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
      body{font-family:'Lato',sans-serif;background-color:var(--bg-color);color:var(--text-dark);line-height:1.7;transition:background-color .3s,color .3s;font-size:var(--font-base-size)}
      main{display:none}.page-section{display:none}.page-section.active{display:block;animation:fadeIn 0.5s ease-in-out forwards}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .container{max-width:1200px;margin:0 auto;padding:2rem}.page-header{margin-bottom:2.5rem;text-align:center}
      .page-header h2{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*2.2);color:var(--secondary-color)}.page-header p{font-size:calc(var(--font-base-size)*1.1);color:var(--text-light);max-width:700px;margin:.5rem auto 0}
      .btn{display:inline-block;padding:.8rem 1.8rem;background:var(--primary-gradient);color:white;border:none;border-radius:50px;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .2s ease,box-shadow .3s ease;box-shadow:0 4px 15px rgba(22,160,133,.3);font-size:var(--font-base-size)}.btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 20px rgba(22,160,133,.4)}.btn:disabled{background:#bdc3c7;cursor:not-allowed;box-shadow:none;}
      .btn-secondary{background:#95a5a6;box-shadow:0 4px 15px rgba(0,0,0,.1)}.btn-secondary:hover:not(:disabled){background:#7f8c8d}.btn-back{display:block;width:fit-content;margin:2.5rem auto 0}
      .card{background-color:var(--card-bg);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);transition: all .3s ease;}.card:hover{transform:translateY(-8px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
      .input-group{display:flex;gap:.5rem;margin-bottom:1rem}.input-field{width:100%;padding:.8rem 1rem;border:1px solid #dee2e6;background:var(--bg-color);color:var(--text-dark);border-radius:8px;font-size:var(--font-base-size);transition:border-color .2s,box-shadow .2s}
      .input-field:focus{outline:2px solid var(--primary-color);box-shadow:0 0 0 3px rgba(22,160,133,.2)}
      #view-inicio{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;z-index:1000;color:white;padding:1rem;background-color:#1c2541}.inicio-content{animation:fadeIn 2s}.inicio-content h1{font-family:'Poppins',sans-serif;font-size:clamp(3rem, 10vw, 5.5rem);letter-spacing:2px}.inicio-content p{font-size:1.5rem;color:rgba(255,255,255,.8);margin-bottom:2rem}.inicio-content .btn{padding:1rem 3rem;font-size:1.2rem}
      .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.menu-card{text-align:center;text-decoration:none;color:var(--text-dark);font-size:var(--font-base-size)}.menu-card .icon{font-size:3rem;color:var(--primary-color);margin-bottom:1rem;display:block}.menu-card h3{font-family:'Poppins',sans-serif;font-size:calc(var(--font-base-size)*1.3)}
      .container-ai { display: flex; gap: 20px; flex-wrap: wrap; }.ai-main-panel { flex-grow: 1; min-width: 300px; }.history-section {width: 100%; max-width: 320px; min-width: 280px; flex-shrink:0; height: 450px; display: flex; flex-direction: column;}.history-section h3 {font-family: 'Poppins', sans-serif; margin-top: 0; margin-bottom: 1rem;}.history-container { flex-grow: 1; overflow-y: auto; }.explanation {margin-top: 1rem; border: 1px solid #dee2e6; padding: 1rem; height: 350px; overflow-y: auto; background-color: var(--bg-color); border-radius: var(--radius); line-height: 1.8;}
      @media (max-width: 768px) {.container-ai { flex-direction: column; } .history-section { max-width: 100%; border-left: none; padding-left: 0; margin-top: 2rem; border-top: 1px solid #dee2e6; padding-top: 1rem; height: 300px; }}
      .chat-layout{display:grid;grid-template-columns:320px 1fr;gap:1.5rem;height:75vh;max-height:700px}.friends-panel{display:flex; flex-direction:column;}.friend-item{display:flex;align-items:center;gap:.75rem;cursor:pointer;padding:.5rem;border-radius:8px;transition: background-color .2s;}.friend-item:hover{background-color: var(--bg-color)}.friend-item.active{background-color:var(--primary-color); color:white;}.friend-status{width:10px;height:10px;border-radius:50%}.friend-status.online{background-color:var(--online-color)}.friend-status.offline{background-color:var(--offline-color)}.chat-window{display:flex;flex-direction:column}.chat-messages{flex-grow:1;overflow-y:auto;padding-right: 10px; margin-bottom:1rem}.message-bubble{max-width:80%;width:fit-content;padding:.7rem 1.2rem;border-radius:20px;margin-bottom:.75rem}.message-bubble.sent{background:var(--primary-gradient);color:white;margin-left:auto;border-bottom-right-radius:5px}.message-bubble.received{background-color:#e9ecef;color:var(--text-dark);margin-right:auto;border-bottom-left-radius:5px}
      #auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}.auth-card{width:100%;max-width:400px;text-align:center}.auth-toggle button{background:none;border:none;cursor:pointer;padding:.5rem 1rem;font-size:1.1rem;color:var(--text-light);transition:color .2s;border-bottom:2px solid transparent}.auth-toggle button.active{font-weight:bold;color:var(--primary-color);border-bottom:2px solid var(--primary-color)}#register-form{display:none}#auth-feedback{margin-top:1rem;color:red;min-height:1.2em}
      .settings-container h3{font-family:'Poppins',sans-serif}
    </style>
</head>
<body>
    <section id="view-inicio">
        <div id="particles-js" aria-hidden="true"></div>
        <div class="inicio-content">
            <h1 data-lang-key="mainTitle">Potencia tu Mente</h1>
            <p data-lang-key="welcomeSlogan">Tu viaje al dominio de las matem치ticas comienza ahora.</p>
            <button id="enter-button" class="btn" data-lang-key="enterButton">Entrar</button>
        </div>
    </section>
    
    <main>
        <div class="container">
            <section id="view-menu" class="page-section card">
                <div class="page-header"><h2 data-lang-key="menuTitle">Men칰 Principal</h2><button id="logout-button" class="btn btn-secondary" style="display:none; margin-top:1rem;">Cerrar Sesi칩n</button></div>
                <div class="menu-grid">
                    <a href="#view-ia" class="menu-card nav-link card"><div class="icon"><i class="fas fa-robot"></i></div><h3 data-lang-key="iaTitle">Tutor IA</h3><p data-lang-key="iaMenuDesc">Resuelve cualquier duda.</p></a>
                    <a href="#view-consejos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-lightbulb"></i></div><h3 data-lang-key="tipsTitle">Consejos</h3><p data-lang-key="tipsMenuDesc">Mejora tus habilidades.</p></a>
                    <a href="#view-chat" class="menu-card nav-link card"><div class="icon"><i class="fas fa-comments"></i></div><h3 data-lang-key="chatTitle">Aprendamos Juntos</h3><p data-lang-key="chatMenuDesc">Chatea con amigos.</p></a>
                    <a href="#view-quienes-somos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-users"></i></div><h3 data-lang-key="whoTitle">Qui칠nes Somos</h3><p data-lang-key="whoMenuDesc">Conoce al equipo.</p></a>
                    <a href="#view-ajustes" class="menu-card nav-link card"><div class="icon"><i class="fas fa-cog"></i></div><h3 data-lang-key="settingsTitle">Ajustes</h3><p data-lang-key="settingsMenuDesc">Personaliza tu experiencia.</p></a>
                </div>
            </section>
            
            <section id="view-ia" class="page-section">
                <div class="page-header"><h2 data-lang-key="iaTitle">Tutor IA</h2><p data-lang-key="iaPageDesc">Preg칰ntale cualquier concepto a la IA.</p></div>
                <div class="container-ai card">
                    <div class="ai-main-panel">
                        <div class="input-group" style="margin-bottom: 0;"><input id="concept-input" type="text" class="input-field" placeholder="Ej: Teorema de Pit치goras"><button id="btn-consultar" class="btn" data-lang-key="consultAIButton">Consultar</button></div>
                        <div class="explanation" id="explanation"><p data-lang-key="explanationPlaceholder">Aqu칤 aparecer치 la explicaci칩n...</p></div>
                    </div>
                    <div class="history-section" id="history-section">
                        <h3 data-lang-key="historyTitle">Historial de Consultas</h3>
                        <div class="history-container" id="history-container"><p>Cargando...</p></div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-back" data-lang-key="backButton">Regresar</button>
            </section>
            
            <section id="view-consejos" class="page-section">
                <div class="page-header"><h2 data-lang-key="tipsTitle">Consejos para Estudiantes</h2></div>
                <div id="consejos-container" class="menu-grid"></div>
                <button class="btn btn-secondary btn-back" data-lang-key="backButton">Regresar</button>
            </section>
            
            <section id="view-chat" class="page-section">
                <div id="auth-overlay">
                    <div class="card auth-card">
                        <div class="auth-toggle"><button id="show-login" class="active">Iniciar Sesi칩n</button><button id="show-register">Crear Cuenta</button></div>
                        <form id="login-form"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="login-username" class="input-field" placeholder="Nombre de usuario" required autocomplete="username"><input type="password" id="login-password" class="input-field" placeholder="Contrase침a" required autocomplete="current-password"></div><button type="submit" class="btn">Entrar</button></form>
                        <form id="register-form" style="display:none;"><div class="input-group" style="flex-direction:column; gap: 0.5rem;"><input type="text" id="register-username" class="input-field" placeholder="Nuevo nombre de usuario" required autocomplete="username"><input type="password" id="register-password" class="input-field" placeholder="Nueva contrase침a (m칤n. 4 caracteres)" required minlength="4" autocomplete="new-password"></div><button type="submit" class="btn">Registrarme</button></form>
                        <p id="auth-feedback"></p>
                    </div>
                </div>

                <div class="chat-view" style="display: none;">
                    <div class="page-header"><h2 data-lang-key="chatTitle">Aprendamos Juntos</h2></div>
                    <div class="chat-layout">
                        <aside class="card friends-panel">
                            <p>Hola, <strong id="your-username" style="color:var(--primary-color);"></strong></p>
                            <p style="font-size:0.9em;color:var(--text-light);margin-top:-5px;">Tu c칩digo: <strong id="your-code" title="Clic para copiar" style="cursor:pointer;user-select:all;"></strong></p>
                            <h3 style="margin-top:1.5rem;" data-lang-key="friendsTitle">Amigos</h3>
                            <form id="add-friend-form" class="input-group"><input id="friend-code-input" class="input-field" placeholder="C칩digo de amigo..." required><button type="submit" class="btn">+</button></form>
                            <div id="friends-list" style="flex-grow:1;overflow-y:auto;"></div>
                        </aside>
                        <div class="card chat-window">
                            <h3 id="chat-header">Selecciona un amigo</h3>
                            <div class="chat-messages" id="chat-messages"></div>
                            <form id="chat-form" class="input-group"><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled><button type="submit" class="btn" disabled>Enviar</button></form>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-back" data-lang-key="backButton">Regresar</button>
                </div>
            </section>
            
            <section id="view-quienes-somos" class="page-section">
                <div class="page-header"><h2 data-lang-key="whoTitle">쯈ui칠nes Somos?</h2></div>
                <div class="card" id="quienes-somos-container" style="line-height:1.8;"></div>
                <button class="btn btn-secondary btn-back" data-lang-key="backButton">Regresar</button>
            </section>

            <section id="view-ajustes" class="page-section">
                <div class="page-header"><h2 data-lang-key="settingsTitle">Ajustes</h2></div>
                <div class="card" style="max-width: 600px; margin: auto;">
                    <div class="settings-container" style="display:flex;flex-direction:column;gap:2.5rem;">
                        <div><h3>Idioma</h3><select id="language-selector" class="input-field"><option value="es">Espa침ol</option><option value="en">English</option></select></div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-back" data-lang-key="backButton">Regresar</button>
            </section>
        </div>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = { currentUser: null, friends: [], activeChat: null, messages: {}, onlineFriends: [] };
        const ui = {
            main: document.querySelector('main'),
            inicio: { view: document.getElementById('view-inicio'), button: document.getElementById('enter-button') },
            logoutButton: document.getElementById('logout-button'),
            sections: document.querySelectorAll('.page-section'),
            navLinks: document.querySelectorAll('.nav-link'),
            backButtons: document.querySelectorAll('.btn-back'),
            ia: { input: document.getElementById('concept-input'), button: document.getElementById('btn-consultar'), explanation: document.getElementById('explanation'), historyContainer: document.getElementById('history-container') },
            consejos: { container: document.getElementById('consejos-container') },
            auth: { overlay: document.getElementById('auth-overlay'), showLogin: document.getElementById('show-login'), showRegister: document.getElementById('show-register'), loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), feedback: document.getElementById('auth-feedback') },
            chat: { view: document.querySelector('.chat-view'), yourUsername: document.getElementById('your-username'), yourCode: document.getElementById('your-code'), addForm: document.getElementById('add-friend-form'), friendInput: document.getElementById('friend-code-input'), list: document.getElementById('friends-list'), header: document.getElementById('chat-header'), messages: document.getElementById('chat-messages'), chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'), sendBtn: document.querySelector('#chat-form button')},
            quienes: { container: document.getElementById('quienes-somos-container') },
            ajustes: { lang: document.getElementById('language-selector') }
        };
        const socket = io();
        const quienesSomosText = "<p>Somos un grupo de estudiantes de Educaci칩n para el Trabajo que hemos creado este proyecto para apoyar el aprendizaje de las matem치ticas de manera sencilla, pr치ctica e interactiva...</p>";

        function init() {
            if(document.getElementById('particles-js')) particlesJS('particles-js',{"particles":{"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"move":{"enable":true,"speed":6}}});
            setupNavigation();
            setupAuthentication();
            setupIA();
            setupChat();
            setupConsejos();
            ui.quienes.container.innerHTML = quienesSomosText;
            
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                connectUser();
            }
            showInitialView();
        }

        function setupNavigation() {
            ui.inicio.button.addEventListener('click', enterApp);
            ui.navLinks.forEach(link => link.addEventListener('click', handleNav));
            ui.backButtons.forEach(btn => btn.addEventListener('click', () => history.back()));
            window.addEventListener('popstate', () => showView(location.hash.substring(1) || 'view-menu'));
        }
        function enterApp() {
            sessionStorage.setItem('visitedBefore', 'true');
            ui.inicio.view.style.display = 'none';
            ui.main.style.display = 'block';
            history.pushState({ viewId: 'view-menu' }, '', '#view-menu');
            showView('view-menu');
        }
        function handleNav(e) {
            e.preventDefault();
            const viewId = e.currentTarget.getAttribute('href').substring(1);
            history.pushState({ viewId }, '', `#${viewId}`);
            showView(viewId);
        }
        function showInitialView() {
            if (sessionStorage.getItem('visitedBefore')) {
                enterApp();
                showView(location.hash.substring(1) || 'view-menu');
            }
        }
        function showView(viewId) {
            const currentView = document.getElementById(viewId) || document.getElementById('view-menu');
            ui.sections.forEach(s => s.classList.remove('active'));
            currentView.classList.add('active');

            if (viewId === 'view-chat') renderChatView();
            if (viewId === 'view-ia') loadHistory();
            ui.logoutButton.style.display = state.currentUser ? 'inline-block' : 'none';
        }

        function setupAuthentication() {
            ui.auth.showLogin.addEventListener('click', () => toggleAuthForms(true));
            ui.auth.showRegister.addEventListener('click', () => toggleAuthForms(false));
            ui.auth.loginForm.addEventListener('submit', handleLogin);
            ui.auth.registerForm.addEventListener('submit', handleRegister);
            ui.logoutButton.addEventListener('click', handleLogout);
        }
        async function handleLogin(e) { e.preventDefault(); const username = ui.auth.loginForm.querySelector('#login-username').value; const password = ui.auth.loginForm.querySelector('#login-password').value; const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json(); if (data.success) { state.currentUser = data.user; sessionStorage.setItem('currentUser', JSON.stringify(data.user)); loadFriends(); connectUser(); renderChatView(); } else { ui.auth.feedback.textContent = data.message; } }
        async function handleRegister(e) { e.preventDefault(); const username = ui.auth.registerForm.querySelector('#register-username').value; const password = ui.auth.registerForm.querySelector('#register-password').value; const res = await fetch('/api/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) }); const data = await res.json(); if (data.success) { alert('춰Cuenta creada! Ahora puedes iniciar sesi칩n.'); toggleAuthForms(true); } else { ui.auth.feedback.textContent = data.message; } }
        function handleLogout() {
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem(`friends_${state.currentUser.username}`);
            state.currentUser = null;
            state.friends = [];
            socket.disconnect(); // Desconectar del chat
            location.hash = '#view-menu';
            showView('view-menu');
        }
        function toggleAuthForms(showLogin) { ui.auth.loginForm.style.display = showLogin ? 'block' : 'none'; ui.auth.registerForm.style.display = showLogin ? 'none' : 'block'; ui.auth.showLogin.classList.toggle('active', showLogin); ui.auth.showRegister.classList.toggle('active', !showLogin); ui.auth.feedback.textContent = ''; }

        function setupIA() {
            ui.ia.button.addEventListener('click', handleAIConsultation);
            ui.ia.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAIConsultation(); });
        }
        async function handleAIConsultation() {
            const topic = ui.ia.input.value.trim();
            if (!topic) return;
            ui.ia.button.disabled = true;
            ui.ia.explanation.innerHTML = `<p>Consultando a la IA sobre "${topic}"...</p>`;
            try {
                const res = await fetch('/api/explain-math', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, userCode: state.currentUser?.code }),
                });
                const data = await res.json();
                ui.ia.explanation.innerHTML = data.error ? `<p style="color: red;">${data.error}</p>` : data.explanation;
                if (!data.error) { ui.ia.input.value = ''; if (state.currentUser) loadHistory(); }
            } catch (error) {
                ui.ia.explanation.innerHTML = `<p style="color: red;">Error de conexi칩n.</p>`;
            } finally {
                ui.ia.button.disabled = false;
            }
        }
        async function loadHistory() {
            if (!state.currentUser) {
                ui.ia.historyContainer.innerHTML = `<p style="color:var(--text-light);text-align:center;">Inicia sesi칩n para ver tu historial.</p>`;
                return;
            }
            try {
                const res = await fetch(`/api/concept-history?userCode=${state.currentUser.code}`);
                const { history } = await res.json();
                ui.ia.historyContainer.innerHTML = '';
                if (!history || history.length === 0) {
                    ui.ia.historyContainer.innerHTML = `<p style="color:var(--text-light);text-align:center;">No hay consultas.</p>`;
                    return;
                }
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 8px 5px; border-bottom: 1px solid #eee; gap: 10px;';
                    const topicSpan = document.createElement('span');
                    topicSpan.textContent = item.topic;
                    topicSpan.title = 'Clic para consultar de nuevo';
                    topicSpan.style.cssText = 'cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;';
                    topicSpan.onclick = () => { ui.ia.input.value = item.topic; handleAIConsultation(); };
                    const btnDelete = document.createElement('button');
                    btnDelete.innerHTML = '&times;';
                    btnDelete.style.cssText = 'background:none; border:none; color:red; cursor:pointer; font-size: 1.4rem;';
                    btnDelete.onclick = async () => {
                        await fetch(`/api/concept-history/${item._id}`, { method: 'DELETE' });
                        loadHistory();
                    };
                    div.appendChild(topicSpan); div.appendChild(btnDelete); ui.ia.historyContainer.appendChild(div);
                });
            } catch (error) {
                ui.ia.historyContainer.innerHTML = `<p style="color: red;">Error al cargar historial.</p>`;
            }
        }
        
        function setupChat() {
            ui.chat.addForm.addEventListener('submit', addFriend);
            ui.chat.list.addEventListener('click', (e) => {
                const friendItem = e.target.closest('[data-code]');
                if(friendItem) setActiveChat(friendItem.dataset.code);
            });
            ui.chat.chatForm.addEventListener('submit', sendChatMessage);
            ui.chat.yourCode.addEventListener('click', () => navigator.clipboard.writeText(state.currentUser.code));
            socket.on('online users update', (users) => { state.onlineFriends = users; renderFriends(); });
            socket.on('private message', handleNewMessage);
        }
        function renderChatView() {
            if (state.currentUser) {
                ui.auth.overlay.style.display = 'none';
                ui.chat.view.style.display = 'block';
                renderFriends();
            } else {
                ui.auth.overlay.style.display = 'flex';
                ui.chat.view.style.display = 'none';
            }
        }
        function connectUser() {
            if (!socket.connected) {
                socket.connect();
            }
            socket.emit('register user', state.currentUser);
        }
        function loadFriends() { state.friends = JSON.parse(localStorage.getItem(`friends_${state.currentUser.username}`)) || []; }
        function saveFriends() { localStorage.setItem(`friends_${state.currentUser.username}`, JSON.stringify(state.friends)); }
        function addFriend(e) { e.preventDefault(); const code = ui.chat.friendInput.value.trim().toUpperCase(); if (!code || code === state.currentUser.code) return; socket.emit('add friend', code, (res) => { if (res.success && !state.friends.find(f => f.code === res.friend.code)) { state.friends.push(res.friend); saveFriends(); renderFriends(); } else { alert('C칩digo no v치lido o amigo ya a침adido.'); } }); ui.chat.friendInput.value = ''; }
        function renderFriends() { if (!state.currentUser) return; ui.chat.yourUsername.textContent = state.currentUser.username; ui.chat.yourCode.textContent = state.currentUser.code; ui.chat.list.innerHTML = state.friends.map(f => `<div class="friend-item ${f.code === state.activeChat ? 'active' : ''}" data-code="${f.code}"><span class="friend-status ${state.onlineFriends.includes(f.username)?'online':'offline'}"></span><span>${f.username}</span></div>`).join(''); }
        function setActiveChat(code) { state.activeChat = code; ui.chat.header.textContent = `Chateando con ${state.friends.find(f=>f.code===code).username}`; ui.chat.chatInput.disabled = false; ui.chat.sendBtn.disabled = false; renderFriends(); renderMessages(); }
        function sendChatMessage(e) { e.preventDefault(); const text = ui.chat.chatInput.value.trim(); if (!text || !state.activeChat) return; const message = {id:Date.now(), text}; socket.emit('private message', { toCode: state.activeChat, message }); handleNewMessage({from:state.currentUser.username, message}); ui.chat.chatInput.value = ''; }
        function handleNewMessage({from, message}) { const chatPartnerCode = from === state.currentUser.username ? state.activeChat : state.friends.find(f => f.username === from)?.code; if (!chatPartnerCode) return; state.messages[chatPartnerCode] = state.messages[chatPartnerCode] || []; state.messages[chatPartnerCode].push({ from, ...message }); if (chatPartnerCode === state.activeChat) renderMessages(); }
        function renderMessages() { const chatMessagesDiv = ui.chat.messages; chatMessagesDiv.innerHTML = (state.messages[state.activeChat] || []).map(({from, text}) => `<div class="message-bubble ${from === state.currentUser.username ? 'sent' : 'received'}">${text}</div>`).join(''); chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; }

        async function setupConsejos(){ 
            const response = await fetch('/api/generate-tips');
            const data = await response.json();
            ui.consejos.container.innerHTML = data.tips || '<p>No se pudieron cargar los consejos.</p>';
        }

        init();
    });
    </script>
</body>
</html>