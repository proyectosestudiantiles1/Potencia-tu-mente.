<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potencia Tu Mente</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧠</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
      :root {
        --primary-gradient: linear-gradient(90deg, #6e8efb, #a777e3); --primary-color: #6e8efb;
        --secondary-color: #3f4c6b; --bg-color: #f8f9fa; --card-bg: #FFFFFF; --text-dark: #212529;
        --text-light: #6c757d; --shadow: 0 10px 30px rgba(0, 0, 0, 0.07); --radius: 16px;
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html { scroll-behavior: smooth; }
      body { font-family: 'Lato', sans-serif; background-color: var(--bg-color); color: var(--text-dark); line-height: 1.6;}
      
      main { display: none; }
      .page-section { display: none; }
      .page-section.active { display: block; animation: fadeIn 0.6s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      
      .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
      .page-header { margin-bottom: 2.5rem; text-align: center; }
      .page-header h1 { font-family: 'Poppins', sans-serif; font-size: 3rem; color: var(--secondary-color); }
      .page-header p { font-size: 1.2rem; color: var(--text-light); max-width: 700px; margin: 0.5rem auto 0; }
      
      .btn { display: inline-block; padding: 0.8rem 1.8rem; background: var(--primary-gradient); color: white; border: none; border-radius: 50px; font-weight: 700; text-decoration: none; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 4px 15px rgba(110, 142, 251, 0.4); }
      .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(110, 142, 251, 0.6); }
      .btn-secondary { background: #6c757d; box-shadow: 0 4px 15px rgba(0,0,0,0.2); } .btn-secondary:hover { background: #5a6268; }
      .btn-back { display: block; width: fit-content; margin-top: 2.5rem; }
      .card { background-color: var(--card-bg); border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow); transition: transform 0.3s, box-shadow 0.3s; }
      .card:hover { transform: translateY(-8px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1); }
      .input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
      .input-field { width: 100%; padding: 0.8rem 1rem; border: 1px solid #dee2e6; border-radius: 8px; font-size: 1rem; }
      .input-field:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(110, 142, 251, 0.2); }
      
      #view-inicio { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; text-align: center; z-index: 1000; color: white; padding: 1rem; background: #141E30; }
      #particles-js { position: absolute; width: 100%; height: 100%; z-index: -1; }
      .inicio-content { animation: fadeIn 2s; }
      .inicio-content h1 { font-family: 'Poppins', sans-serif; font-size: clamp(3rem, 10vw, 5.5rem); letter-spacing: 2px; }
      .inicio-content p { font-size: 1.5rem; color: rgba(255,255,255,0.8); margin-bottom: 2rem; }
      .inicio-content .btn { padding: 1rem 3rem; font-size: 1.2rem; }
      
      .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
      .menu-card { text-align: center; text-decoration: none; color: var(--text-dark); }
      .menu-card .icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; display: block; }
      .menu-card h3 { font-family: 'Poppins', sans-serif; }
      #view-menu { position: relative; overflow: hidden; }

      #concept-detail-container img { width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius); margin-bottom: 1.5rem; }
      .content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
      .content-card h4 { font-family: 'Poppins', sans-serif; }
      
      .problem-card { margin-bottom: 1.5rem; }
      .problem-card .solution { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #dee2e6; color: var(--primary-color); font-weight: bold; }
      
      .chat-layout { display: grid; grid-template-columns: 320px 1fr; gap: 1.5rem; height: 75vh; max-height: 700px; }
      #friends-list { overflow-y: auto; flex-grow: 1; }
      .friend-item { padding: 0.8rem 1rem; border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between; font-weight: 500;}
      .friend-item:hover, .friend-item.active { background-color: #e9ecef; }
      .chat-window { display: flex; flex-direction: column; }
      .chat-messages { flex-grow: 1; border: 1px solid #dee2e6; border-radius: var(--radius); padding: 1rem; overflow-y: auto; margin-bottom: 1rem; background: var(--bg-color); }
      .message-bubble { max-width: 80%; width: fit-content; padding: 0.7rem 1.2rem; border-radius: 20px; margin-bottom: 0.75rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
      .message-bubble.sent { background: var(--primary-gradient); color: white; margin-left: auto; border-bottom-right-radius: 5px; }
      .message-bubble.received { background-color: #e9ecef; color: var(--text-dark); margin-right: auto; border-bottom-left-radius: 5px; }
      #username-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.5s;}
    </style>
</head>
<body>
    <section id="view-inicio"><div id="particles-js"></div><div class="inicio-content"><h1>Potencia tu Mente</h1><p>Tu viaje al dominio de las matemáticas comienza ahora.</p><a href="#view-menu" class="btn nav-link">Entrar</a></div></section>
    
    <main><div class="container">
        <section id="view-menu" class="page-section"><div class="page-header"><h1 data-lang-key="menuTitle">Menú Principal</h1></div><div class="menu-grid"><a href="#view-conceptos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-book-open"></i></div><h3 data-lang-key="conceptsTitle">Conceptos</h3><p>Explora todos los temas.</p></a><a href="#view-practica" class="menu-card nav-link card"><div class="icon"><i class="fas fa-brain"></i></div><h3 data-lang-key="practiceTitle">Práctica</h3><p>Ejercicios aleatorios.</p></a><a href="#view-consejos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-lightbulb"></i></div><h3 data-lang-key="tipsTitle">Consejos</h3><p>Mejora tus habilidades.</p></a><a href="#view-chat" class="menu-card nav-link card"><div class="icon"><i class="fas fa-comments"></i></div><h3 data-lang-key="chatTitle">Aprendamos Juntos</h3><p>Resuelve dudas con amigos.</p></a><a href="#view-quienes-somos" class="menu-card nav-link card"><div class="icon"><i class="fas fa-users"></i></div><h3 data-lang-key="whoTitle">Quiénes Somos</h3><p>Conoce al equipo.</p></a><a href="#view-ajustes" class="menu-card nav-link card"><div class="icon"><i class="fas fa-cog"></i></div><h3 data-lang-key="settingsTitle">Ajustes</h3><p>Personaliza tu experiencia.</p></a></div></section>
        <section id="view-conceptos" class="page-section"><div class="page-header"><h1 data-lang-key="conceptsTitle">Conceptos Matemáticos</h1><p>Encuentra el tema que necesitas.</p></div><div class="filter-bar"><input type="search" id="concept-search" class="input-field" placeholder="Buscar tema..."></div><div id="concepts-grid" class="content-grid"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
        <section id="view-concepto-detalle" class="page-section"><div id="concept-detail-container"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
        <section id="view-practica" class="page-section"><div class="page-header"><h1 data-lang-key="practiceTitle">Centro de Práctica</h1><p id="practice-header">Genera ejercicios y situaciones problemáticas.</p></div><div class="filter-bar"><input type="search" id="practice-search" class="input-field" placeholder="Buscar tema de práctica..."></div><div id="practice-grid"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
        <section id="view-consejos" class="page-section"><div class="page-header"><h1 data-lang-key="tipsTitle">Consejos para Estudiantes</h1><p>Estrategias para potenciar tu aprendizaje.</p></div><div id="consejos-container" class="content-grid"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
        <section id="view-chat" class="page-section"><div id="username-overlay"><div class="card" style="width:100%;max-width:400px;text-align:center;"><h3>Crea tu Perfil de Estudiante</h3><p style="margin-bottom:1rem;">Elige un nombre para mostrar. Se te asignará un código único para agregar amigos.</p><form id="username-form" class="input-group"><input type="text" id="username-input" class="input-field" placeholder="TuUsuario123" required minlength="3"><button type="submit" class="btn">Guardar y Entrar</button></form></div></div><div class="page-header"><h1>Aprendamos Juntos</h1></div><div class="chat-layout"><div class="card"><p>Hola, <strong id="your-username" style="color:var(--primary-color);"></strong></p><p style="font-size: 0.9em; color: var(--text-light); margin-top: -5px;">Tu código de amigo es: <strong id="your-code" title="Clic para copiar" style="cursor: pointer; user-select: all;"></strong></p><h3 style="margin-top:1.5rem;font-family:'Poppins';">Amigos</h3><p style="font-size:0.9em;color:var(--text-light);margin-bottom:1rem;">Añade amigos usando su código único.</p><form id="add-friend-form" class="input-group"><input id="friend-code-input" class="input-field" placeholder="Código del amigo..." required><button type="submit" class="btn">+</button></form><div id="friends-list"></div></div><div class="card chat-window"><h3 id="chat-header" style="font-family:'Poppins';">Selecciona un amigo</h3><div class="chat-messages" id="chat-messages"></div><form id="chat-form" class="input-group"><input id="chat-input" class="input-field" placeholder="Escribe un mensaje..." autocomplete="off" required disabled><button type="submit" class="btn" disabled>Enviar</button></form></div></div><button class="btn btn-secondary btn-back">Regresar</button></section>
        <section id="view-quienes-somos" class="page-section"><div class="page-header"><h1>¿Quiénes somos?</h1></div><div class="card" id="quienes-somos-container" style="line-height:1.8;color:var(--text-light);"></div><button class="btn btn-secondary btn-back">Regresar</button></section>
        <section id="view-ajustes" class="page-section"><div class="page-header"><h1>Ajustes</h1></div><div class="card"><div class="settings-container" style="display:flex;flex-direction:column;gap:2rem;"><div><h3 style="font-family: Poppins; color: var(--secondary-color);">Idioma de la Interfaz</h3><select id="language-selector" class="input-field"><option value="es">Español</option><option value="en">English</option><option value="zh">中文 (Chino)</option><option value="de">Deutsch (Alemán)</option><option value="fr">Français (Francés)</option><option value="pt">Português (Brasil)</option></select></div><div><h3 style="font-family: Poppins; color: var(--secondary-color);">Fondo del Menú</h3><p>Sube una imagen o video local para usar de fondo en el menú principal.</p><input type="file" id="background-upload" accept="image/*,video/*" class="input-field"></div><div><p>O pega un enlace URL de una imagen o video.</p><form id="background-url-form" class="input-group"><input type="url" id="background-url-input" class="input-field" placeholder="https://ejemplo.com/imagen.jpg"><button type="submit" class="btn">Aplicar</button></form></div></div></div><button class="btn btn-secondary btn-back">Regresar</button></section>
    </div></main>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        // --- SCRIPT FINAL, CORREGIDO Y FUNCIONAL ---
        document.addEventListener('DOMContentLoaded', () => {
            const mathConcepts={OperacionesConEnteros:{topic:'Aritmética',name:'Operaciones con Enteros',img:'https://images.unsplash.com/photo-1634932223838-895914c6e64c?w=300&h=150&fit=crop&q=80',description:"Aprende a sumar, restar, multiplicar y dividir números positivos y negativos, un pilar fundamental de la matemática.",howTo:"Se utiliza la regla de los signos. Para sumas y restas, signos iguales se suman y mantienen el signo; signos diferentes se restan y se usa el signo del mayor. Para multiplicación y división, signos iguales dan positivo (+), signos diferentes dan negativo (-).",types:"Suma, resta, multiplicación, división y potencias.",errors:"Olvidar la regla de los signos, especialmente al restar un número negativo (ej. 5 - (-3) = 8)."},FraccionesYDecimales:{topic:'Aritmética',name:'Fracciones y Decimales',img:'https://images.unsplash.com/photo-1593560704563-f176a2eb61db?w=300&h=150&fit=crop&q=80',description:"Representan partes de un todo. Es clave para entender proporciones y porcentajes.",howTo:"Para sumar o restar fracciones, deben tener un denominador común. La multiplicación es directa (numerador por numerador). Para dividir, se multiplica en cruz.",types:"Propias, impropias, mixtas. Decimales exactos y periódicos.",errors:"Sumar o restar sin encontrar el denominador común. Confundir la multiplicación con la suma."},EcuacionesDePrimerGrado:{topic:'Álgebra',name:'Ecuaciones de Primer Grado',img:'https://images.unsplash.com/photo-1634893275033-28b3439d53c3?w=300&h=150&fit=crop&q=80',description:"Son igualdades con una incógnita (variable) que se debe despejar para encontrar su valor.",howTo:"El objetivo es aislar la variable 'x'. Lo que está sumando pasa al otro lado restando, y lo que está multiplicando pasa dividiendo, y viceversa.",types:"Simples (ax + b = c), con paréntesis, con denominadores.",errors:"Equivocarse al pasar un término de un lado a otro (no cambiar el signo)."},EcuacionesCuadraticas:{topic:'Álgebra',name:'Ecuaciones Cuadráticas',img:"https://images.unsplash.com/photo-1629181197356-943df3132770?w=300&h=150&fit=crop&q=80",description:"Ecuaciones donde la incógnita está elevada al cuadrado. Pueden tener hasta dos soluciones.",howTo:"Se resuelven usando la fórmula general (la resolvente) o factorizando la expresión.",types:"Completas (ax² + bx + c = 0) e incompletas.",errors:"Calcular mal el discriminante (b² - 4ac) en la fórmula general."}};
            const consejosData=[{icon:"fa-brain",titleKey:"tip1Title",textKey:"tip1Text"},{icon:"fa-pencil-alt",titleKey:"tip2Title",textKey:"tip2Text"}, {icon:"fa-check-circle",titleKey:"tip3Title",textKey:"tip3Text"}, {icon:"fa-chalkboard-teacher",titleKey:"tip4Title",textKey:"tip4Text"}];
            const quienesSomosText=`<p>Somos un grupo de estudiantes de Educación para el Trabajo que hemos creado el proyecto “Potencia tu mente con matemáticas”, una plataforma web diseñada para apoyar el aprendizaje de las matemáticas de manera sencilla, práctica e interactiva. Nuestro objetivo es brindar a los estudiantes una herramienta accesible y motivadora que les permita reforzar sus conocimientos y superar las dificultades más comunes en esta área.</p><p style="margin-top:1rem;">Nos caracterizamos por ser un equipo responsable, creativo y comprometido con la innovación educativa. Cada integrante aporta sus ideas, habilidades y talentos, lo que nos permite trabajar de manera colaborativa y complementaria. Nos guía la convicción de que la educación es la clave para el desarrollo personal y social, y que el uso de la tecnología puede convertirse en un aliado poderoso para mejorar los procesos de enseñanza y aprendizaje.</p><p style="margin-top:1rem;">A través de este proyecto, buscamos ofrecer un servicio que no solo enseñe matemáticas, sino que también despierte en los estudiantes la confianza y el gusto por aprender. Queremos que “Potencia tu mente con matemáticas” sea un espacio digital donde cada usuario se sienta acompañado en su proceso educativo, encontrando materiales claros, niveles de práctica graduados y actividades interactivas que hagan del aprendizaje una experiencia dinámica.</p><p style="margin-top:1rem;">Creemos firmemente que nuestro esfuerzo contribuirá al desarrollo académico de los estudiantes y al fortalecimiento de sus competencias matemáticas, demostrando que con constancia, innovación y dedicación se puede transformar la manera en que aprendemos.</p>`;
            const translations={es:{menuTitle:"Menú Principal",conceptsTitle:"Conceptos",practiceTitle:"Práctica",tipsTitle:"Consejos",chatTitle:"Aprendamos Juntos",whoTitle:"Quiénes Somos",settingsTitle:"Ajustes",tip1Title:"Entiende, no memorices",tip1Text:"Las fórmulas son importantes, pero entender por qué funcionan te permitirá resolver cualquier tipo de problema.",tip2Title:"Practica todos los días",tip2Text:"La consistencia es clave. Dedica al menos 20-30 minutos diarios a resolver ejercicios.",tip3Title:"Analiza tus errores",tip3Text:"Equivocarse es una oportunidad para aprender. Cuando falles, entiende el proceso y dónde te equivocaste.",tip4Title:"Intenta enseñar el concepto",tip4Text:"Si puedes explicar un tema a un amigo de forma sencilla, significa que realmente lo has dominado."},en:{menuTitle:"Main Menu",conceptsTitle:"Concepts",practiceTitle:"Practice",tipsTitle:"Tips",chatTitle:"Let's Learn Together",whoTitle:"Who We Are",settingsTitle:"Settings",tip1Title:"Understand, don't memorize",tip1Text:"Formulas are important, but understanding why they work will allow you to solve any type of problem.",tip2Title:"Practice every day",tip2Text:"Consistency is key. Spend at least 20-30 minutes daily solving exercises.",tip3Title:"Analyze your mistakes",tip3Text:"Making mistakes is a learning opportunity. When you fail, understand the process and where you went wrong.",tip4Title:"Try to teach the concept",tip4Text:"If you can explain a topic to a friend simply, it means you have truly mastered it."},zh:{},de:{},fr:{},pt:{}};
            
            const state={myUsername:localStorage.getItem('myUsername'),myCode:localStorage.getItem('myCode'),friends:JSON.parse(localStorage.getItem('myFriends'))||[],activeChat:null,messages:{}};
            const ui={main:document.querySelector('main'),inicio:document.getElementById('view-inicio'),sections:document.querySelectorAll('.page-section'),navLinks:document.querySelectorAll('.nav-link'),backButtons:document.querySelectorAll('.btn-back'),chat:{overlay:document.getElementById('username-overlay'),form:document.getElementById('username-form'),input:document.getElementById('username-input'),yourUsername:document.getElementById('your-username'),yourCode:document.getElementById('your-code'),addForm:document.getElementById('add-friend-form'),friendInput:document.getElementById('friend-code-input'),list:document.getElementById('friends-list'),header:document.getElementById('chat-header'),messages:document.getElementById('chat-messages'),chatForm:document.getElementById('chat-form'),chatInput:document.getElementById('chat-input'),sendBtn:document.getElementById('chat-form').querySelector('button')},concepts:{grid:document.getElementById('concepts-grid'),search:document.getElementById('concept-search'),detail:document.getElementById('concept-detail-container')},practice:{header:document.getElementById('practice-header'),grid:document.getElementById('practice-grid'),search:document.getElementById('practice-search')},consejos:{container:document.getElementById('consejos-container')},quienes:{container:document.getElementById('quienes-somos-container')},ajustes:{lang:document.getElementById('language-selector'),bgUpload:document.getElementById('background-upload'),bgUrlForm:document.getElementById('background-url-form'),bgUrlInput:document.getElementById('background-url-input')}};
            const socket=io();

            function showView(hash,data){let viewId=hash?hash.substring(1):(sessionStorage.getItem('visitedBefore')?'view-menu':'view-inicio');if(viewId==='view-inicio'&&sessionStorage.getItem('visitedBefore')){viewId='view-menu';}
            document.body.style.overflow=viewId==='view-inicio'?'hidden':'auto';
            ui.main.style.display=viewId==='view-inicio'?'none':'block';
            ui.inicio.style.display=viewId==='view-inicio'?'flex':'none';
            ui.sections.forEach(s=>s.classList.remove('active'));
            const activeSection=document.getElementById(viewId);
            if(activeSection)activeSection.classList.add('active');else document.getElementById('view-menu').classList.add('active');
            if(viewId==='view-practica')renderPracticeSearch(data?.topicId);
            if(viewId==='view-concepto-detalle'&&data?.topicId)renderConceptDetail(data.topicId);
            if(viewId==='view-chat')handleChatEntry(data);}
            
            ui.navLinks.forEach(link=>link.addEventListener('click',e=>{e.preventDefault();history.pushState({},'',link.getAttribute('href'));sessionStorage.setItem('visitedBefore','true');showView(link.getAttribute('href'));}));
            ui.backButtons.forEach(btn=>btn.addEventListener('click',()=>history.back()));
            window.addEventListener('popstate',()=>showView(location.hash,history.state));

            function initUser(){if(state.myUsername&&state.myCode){ui.chat.overlay.style.display='none';socket.emit('register user',state.myUsername,()=>{});ui.chat.yourUsername.textContent=state.myUsername;ui.chat.yourCode.textContent=state.myCode;renderFriends();}else{ui.chat.overlay.style.display='flex';}}
            ui.chat.form.addEventListener('submit',e=>{e.preventDefault();const name=ui.chat.input.value.trim();if(name.length<3)return alert('El nombre de usuario debe tener al menos 3 caracteres.');socket.emit('register user',name,res=>{if(res.success){state.myUsername=res.username;state.myCode=res.userCode;localStorage.setItem('myUsername',state.myUsername);localStorage.setItem('myCode',state.myCode);initUser();}else{alert(res.message);}});});
            ui.chat.yourCode.addEventListener('click',()=>navigator.clipboard.writeText(state.myCode).then(()=>alert('¡Código de amigo copiado!')));
            ui.chat.addForm.addEventListener('submit',e=>{e.preventDefault();const code=ui.chat.friendInput.value.trim();if(code&&code!==state.myCode&&!state.friends.find(f=>f.code===code)){socket.emit('add friend',code,res=>{if(res.success){state.friends.push(res);localStorage.setItem('myFriends',JSON.stringify(state.friends));renderFriends();}else{alert(res.message);}});} ui.chat.friendInput.value='';});
            function renderFriends(){ui.chat.list.innerHTML='';state.friends.forEach(f=>{const el=document.createElement('div');el.className='friend-item';el.textContent=f.username;el.dataset.code=f.code;if(f.code===state.activeChat)el.classList.add('active');ui.chat.list.appendChild(el);});}
            function setActiveChat(code){const friend=state.friends.find(f=>f.code===code);if(friend){state.activeChat=code;ui.chat.header.textContent=`Chat con ${friend.username}`;ui.chat.chatInput.disabled=false;ui.chat.sendBtn.disabled=false;renderFriends();renderMessages();ui.chat.chatInput.focus();}}
            ui.chat.list.addEventListener('click',e=>{const target=e.target.closest('.friend-item');if(target)setActiveChat(target.dataset.code);});
            ui.chat.chatForm.addEventListener('submit',e=>{e.preventDefault();const msg=ui.chat.chatInput.value.trim();if(msg&&state.activeChat){socket.emit('private message',{toCode:state.activeChat,message:msg});ui.chat.chatInput.value='';}});
            socket.on('private message',({from,message,self})=>{const friend=state.friends.find(f=>f.username===from);const partnerCode=self?state.activeChat:(friend?friend.code:null);if(partnerCode){if(!state.messages[partnerCode])state.messages[partnerCode]=[];state.messages[partnerCode].push({from,message});if(partnerCode===state.activeChat)renderMessages();}});
            socket.on('system message',({recipient,text})=>{if(state.activeChat===recipient){const el=document.createElement('p');el.style.textAlign='center';el.style.color='var(--text-light)';el.textContent=text;ui.chat.messages.appendChild(el);}});
            function renderMessages(){ui.chat.messages.innerHTML='';if(state.activeChat&&state.messages[state.activeChat]){state.messages[state.activeChat].forEach(({from,message})=>{const bubble=document.createElement('div');bubble.className=`message-bubble ${from===state.myUsername?'sent':'received'}`;bubble.innerHTML=message.replace(/\n/g,'<br>');ui.chat.messages.appendChild(bubble);});ui.chat.messages.scrollTop=ui.chat.messages.scrollHeight;}}
            function handleChatEntry(data){initUser();if(data?.problem){setTimeout(()=>{alert("Selecciona un amigo para compartirle el problema.");ui.chat.chatInput.value=data.problem;history.replaceState({},'',location.pathname+location.hash);},500);}}
            
            function renderConcepts(){const term=ui.concepts.search.value.toLowerCase();ui.concepts.grid.innerHTML='';const keys=Object.keys(mathConcepts).filter(key=>mathConcepts[key].name.toLowerCase().includes(term));if(keys.length===0){ui.concepts.grid.innerHTML=`<p class="card">No se encontraron temas.</p>`;return;}
            keys.forEach(key=>{const item=mathConcepts[key];const card=document.createElement('div');card.className='content-card card';card.innerHTML=`<img src="${item.img}" alt="${item.name}"><h4>${item.name}</h4><p>${item.topic}</p>`;card.addEventListener('click',()=>{history.pushState({topicId:key},'','#view-concepto-detalle');showView('#view-concepto-detalle',{topicId:key});});ui.concepts.grid.appendChild(card);});}
            
            function renderConceptDetail(topicId){const item=mathConcepts[topicId];if(!item){ui.concepts.detail.innerHTML=`<p class="card">Concepto no encontrado.</p>`;return;}
            ui.concepts.detail.innerHTML=`<div class="page-header"><h1>${item.name}</h1><p>${item.topic}</p></div><div class="card"><img src="${item.img}" alt="${item.name}"><h3>Descripción</h3><p>${item.description}</p><h3>¿Cómo se resuelve?</h3><p>${item.howTo}</p><h3>Tipos Comunes</h3><p>${item.types}</p><h3>Errores Frecuentes</h3><p>${item.errors}</p><button class="btn practiquemos-btn" data-topic-id="${topicId}" style="margin-top:1.5rem;">Practiquemos</button></div>`;
            ui.concepts.detail.querySelector('.practiquemos-btn').addEventListener('click',e=>{const id=e.target.dataset.topicId;history.pushState({topicId:id},'','#view-practica');showView('#view-practica',{topicId:id});});}
            
            function renderPracticeSearch(defaultTopicId=null){ui.practice.header.textContent = "Genera ejercicios y situaciones problemáticas";const term=ui.practice.search.value.toLowerCase();ui.practice.grid.innerHTML='';const keys=Object.keys(mathConcepts).filter(key=>mathConcepts[key].name.toLowerCase().includes(term));if(keys.length===0){ui.practice.grid.innerHTML=`<p class="card">No hay ejercicios para este tema.</p>`;return;}
            keys.forEach(key=>{const item=mathConcepts[key];const card=document.createElement('div');card.className='content-card card';card.innerHTML=`<h4>Práctica de ${item.name}</h4><p>Genera ejercicios y problemas sobre este tema.</p><button class="btn" data-topic-id="${key}">Comenzar</button>`;card.querySelector('button').addEventListener('click',e=>generatePracticeContent(e.target.dataset.topicId));ui.practice.grid.appendChild(card);});
            if (defaultTopicId) generatePracticeContent(defaultTopicId);}
            
            function generatePracticeContent(topicId){const item=mathConcepts[topicId];ui.practice.header.textContent=`Ejercicios para: ${item.name}`;ui.practice.grid.innerHTML='';for(let i=0;i<5;i++){const problem=genProblem(topicId,i<3);const card=document.createElement('div');card.className='problem-card card';card.innerHTML=`<p><strong>${problem.type}:</strong> ${problem.question}</p><button class="btn btn-secondary toggle-solution-btn">Ver Respuesta</button><div class="solution"><p><strong>Respuesta:</strong> ${problem.answer}</p></div><button class="btn solve-together-btn">Resolvamoslo Juntos</button>`;ui.practice.grid.appendChild(card);}
            document.querySelectorAll('.toggle-solution-btn').forEach(btn=>btn.addEventListener('click',e=>{const s=e.target.nextElementSibling;s.style.display=s.style.display==='block'?'none':'block';}));
            document.querySelectorAll('.solve-together-btn').forEach(btn=>btn.addEventListener('click',e=>{const problem=e.target.parentElement.querySelector('p').textContent;history.pushState({problem},'','#view-chat');showView('#view-chat',{problem});}));}
            
            function genProblem(topicId,isExercise){const n1=Math.floor(Math.random()*20)+1,n2=Math.floor(Math.random()*10)+1,n3=Math.floor(Math.random()*10)+5;const type=isExercise?'Ejercicio':'Situación Problemática';switch(topicId){case'OperacionesConEnteros':return isExercise?{type,question:`Calcula: ${n1} - (${-n2}) * 3`,answer:n1-(-n2)*3}:{type,question:`Un bus tiene ${n1} pasajeros. Bajan ${n2} y suben ${n3}. ¿Cuántos quedan?`,answer:`${n1-n2+n3} pasajeros`};case'EcuacionesDePrimerGrado':return isExercise?{type,question:`Resuelve para x: 2x + ${n1} = ${n1+n2*2}`,answer:`x = ${n2}`}:{type,question:`El doble de mi edad más ${n1} años es ${n1+10}. ¿Qué edad tengo?`,answer:`5 años`};default:return{type,question:`Define "${mathConcepts[topicId].name}".`,answer:'Revisa la sección de conceptos.'};}}

            function renderConsejos(){ui.consejos.container.innerHTML = ''; consejosData.forEach(c => {const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<h3><i class="fas ${c.icon}" style="color:var(--primary-color); margin-right: 0.5rem;"></i><span data-lang-key="${c.titleKey}"></span></h3><p data-lang-key="${c.textKey}"></p>`; ui.consejos.container.appendChild(card);})}
            
            function applyTranslations(lang){const langPack=translations[lang]||translations.es;document.querySelectorAll('[data-lang-key]').forEach(el=>{const key=el.dataset.langKey;if(langPack[key])el.textContent=langPack[key];});document.documentElement.lang=lang;localStorage.setItem('appLanguage',lang);}
            ui.ajustes.lang.addEventListener('change', (e)=>applyTranslations(e.target.value));
            function applyBackground(url){const menuView=document.getElementById('view-menu');const existingBg=document.getElementById('menu-background');if(existingBg)existingBg.remove();if(url.startsWith('data:video')){const video=document.createElement('video');video.id='menu-background';video.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;opacity:0.2;';video.src=url;video.autoplay=true;video.loop=true;video.muted=true;menuView.prepend(video);}else{menuView.style.backgroundImage=`url(${url})`;menuView.style.backgroundSize='cover';menuView.style.backgroundPosition='center';} localStorage.setItem('menuBackground',url);}
            ui.ajustes.bgUpload.addEventListener('change',e=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=(ev)=>applyBackground(ev.target.result);reader.readAsDataURL(file);}});
            ui.ajustes.bgUrlForm.addEventListener('submit',e=>{e.preventDefault();const url=ui.ajustes.bgUrlInput.value.trim();if(url)applyBackground(url);});
            
            function init() {
                if(document.getElementById('particles-js'))particlesJS('particles-js',{"particles":{"number":{"value":60,"density":{"enable":true,"value_area":800}},"color":{"value":"#ffffff"},"shape":{"type":"circle"},"opacity":{"value":0.8,"random":true},"size":{"value":2,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#ffffff","opacity":0.2,"width":1},"move":{"enable":true,"speed":1,"direction":"none","out_mode":"out"}},"interactivity":{}});
                
                ui.quienes.container.innerHTML = quienesSomosText;
                ui.concepts.search.addEventListener('input', renderConcepts);
                ui.practice.search.addEventListener('input', renderPracticeSearch);

                renderConsejos();
                renderConcepts();
                renderPracticeSearch();
                const savedLang = localStorage.getItem('appLanguage') || 'es';
                ui.ajustes.lang.value = savedLang;
                applyTranslations(savedLang);
                const savedBg = localStorage.getItem('menuBackground');
                if(savedBg) applyBackground(savedBg);
                
                showView(location.hash, history.state);
            }
            init();
        });
    </script>
</body>
</html>